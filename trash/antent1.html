<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Block Arena 3D - Fixed</title>
    <style>
        body { margin: 0; overflow: hidden; font-family: 'Courier New', Courier, monospace; background: #000; }
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.9); color: #0f0; z-index: 100; text-align: center; }
        .menu-card { border: 2px solid #0f0; padding: 50px; background: #111; box-shadow: 0 0 15px #0f0; }
        button { background: #0f0; color: #000; border: none; padding: 15px 30px; font-weight: bold; cursor: pointer; margin-top: 20px; font-size: 1.2rem; }
        button:hover { background: #fff; }
        #crosshair { position: absolute; top: 50%; left: 50%; width: 10px; height: 10px; border: 1px solid #0f0; transform: translate(-50%, -50%); pointer-events: none; z-index: 10; display: none; }
        #roomInput { background: #000; color: #0f0; border: 1px solid #0f0; padding: 10px; text-align: center; margin-bottom: 10px; }
    </style>
</head>
<body>

    <div id="ui-layer">
        <div class="menu-card" id="main-menu">
            <h1>BLOCK_ARENA.EXE</h1>
            <button id="createBtn">CREATE ROOM</button>
            <p>OR</p>
            <input type="text" id="roomInput" placeholder="CODE" maxlength="4"><br>
            <button id="joinBtn">JOIN ROOM</button>
        </div>
        <div class="menu-card" id="lobby-menu" style="display:none;">
            <h2 id="roomDisplay">ROOM: ----</h2>
            <p>SYNCING SATELLITES...</p>
            <button id="startBtn">ENTER ARENA</button>
        </div>
    </div>

    <div id="crosshair"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/PointerLockControls.js"></script>

    <script>
        let scene, camera, renderer, controls;
        let moveForward = false, moveBackward = false, moveLeft = false, moveRight = false;
        let velocity = new THREE.Vector3();
        let direction = new THREE.Vector3();
        let prevTime = performance.now();

        // --- 1. THE GAME ENGINE ---
        function initGame() {
            // Scene Setup
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x111122); // Dark Blue Night
            scene.fog = new THREE.Fog(0x111122, 0, 100);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            // Lighting (Crucial so it's not black!)
            const ambientLight = new THREE.AmbientLight(0x404040, 2); // Soft white light
            scene.add(ambientLight);
            
            const sunLight = new THREE.DirectionalLight(0xffffff, 1);
            sunLight.position.set(10, 20, 10);
            scene.add(sunLight);

            // Floor
            const grid = new THREE.GridHelper(200, 50, 0x00ff00, 0x222222);
            scene.add(grid);

            // Generate Obstacles
            for (let i = 0; i < 50; i++) {
                const h = Math.random() * 8 + 2;
                const geometry = new THREE.BoxGeometry(4, h, 4);
                const material = new THREE.MeshStandardMaterial({ color: 0x00ff00, wireframe: Math.random() > 0.8 });
                const box = new THREE.Mesh(geometry, material);
                box.position.set(Math.random() * 100 - 50, h/2, Math.random() * 100 - 50);
                scene.add(box);
            }

            // Controls
            controls = new THREE.PointerLockControls(camera, document.body);
            scene.add(controls.getObject());

            // Key Events
            const onKeyDown = (e) => {
                if (e.code === 'KeyW') moveForward = true;
                if (e.code === 'KeyS') moveBackward = true;
                if (e.code === 'KeyA') moveLeft = true;
                if (e.code === 'KeyD') moveRight = true;
            };
            const onKeyUp = (e) => {
                if (e.code === 'KeyW') moveForward = false;
                if (e.code === 'KeyS') moveBackward = false;
                if (e.code === 'KeyA') moveLeft = false;
                if (e.code === 'KeyD') moveRight = false;
            };
            document.addEventListener('keydown', onKeyDown);
            document.addEventListener('keyup', onKeyUp);

            // Start Loop
            animate();
        }

        function animate() {
            requestAnimationFrame(animate);
            if (controls.isLocked) {
                const time = performance.now();
                const delta = (time - prevTime) / 1000;

                velocity.x -= velocity.x * 10.0 * delta;
                velocity.z -= velocity.z * 10.0 * delta;

                direction.z = Number(moveForward) - Number(moveBackward);
                direction.x = Number(moveRight) - Number(moveLeft);
                direction.normalize();

                if (moveForward || moveBackward) velocity.z -= direction.z * 400.0 * delta;
                if (moveLeft || moveRight) velocity.x -= direction.x * 400.0 * delta;

                controls.moveRight(-velocity.x * delta);
                controls.moveForward(-velocity.z * delta);

                prevTime = time;
            }
            renderer.render(scene, camera);
        }

        // --- 2. MENU LOGIC ---
        document.getElementById('createBtn').onclick = () => {
            const code = Math.random().toString(36).substring(2, 6).toUpperCase();
            document.getElementById('main-menu').style.display = 'none';
            document.getElementById('lobby-menu').style.display = 'block';
            document.getElementById('roomDisplay').innerText = `ROOM: ${code}`;
        };

        document.getElementById('startBtn').onclick = () => {
            document.getElementById('ui-layer').style.display = 'none';
            document.getElementById('crosshair').style.display = 'block';
            initGame();
            controls.lock();
        };

        document.getElementById('joinBtn').onclick = () => {
            if(document.getElementById('roomInput').value.length === 4) {
                document.getElementById('ui-layer').style.display = 'none';
                document.getElementById('crosshair').style.display = 'block';
                initGame();
                setTimeout(() => controls.lock(), 100);
            }
        };

        // Re-lock mouse if user clicks screen
        document.body.addEventListener('click', () => {
            if (controls && !controls.isLocked && document.getElementById('ui-layer').style.display === 'none') {
                controls.lock();
            }
        });
    </script>
</body>
</html>
