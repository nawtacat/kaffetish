<!DOCTYPE html>
<html>
<head>
  <title>Full Screen Field Input with Visual Buttons</title>
  <style>
    body {
      margin: 0;
      background: #111;
      color: #0f0;
      font-family: monospace;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center; 
      height: 100vh;
      width: 100vw; 
      overflow: hidden; 
      touch-action: none;
    }

    #zones {
      position: relative;
      width: 600px; 
      height: 600px; 
      margin-bottom: 20px;
    }

    .zone {
      position: absolute;
      width: 120px; 
      height: 120px; 
      border-radius: 50%;
      background: #222;
      border: 2px solid #333;
      transition: background 0.1s;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      user-select: none; 
      color: #0f0; 
    }

    .zone.active {
      background: #0f0; 
      color: #111; 
    }

    #log {
      width: 90vw;
      max-width: 600px;
      height: 150px;
      background: #000;
      border: 1px solid #444;
      padding: 10px;
      overflow-y: auto;
    }
  </style>
</head>
<body>
  <div id="zones"></div>
  <div id="log"></div>

  <audio id="wrongSound" src="https://kaffetish.club/trash/wronguserorpass.mp3" preload="auto"></audio>
  <audio id="userCorrect" src="https://kaffetish.club/trash/usercorrect.mp3" preload="auto"></audio>
  <audio id="passCorrect" src="https://kaffetish.club/trash/passcorrect.mp3" preload="auto"></audio>

  <script>
    // Constants for visual button positioning
    const ZONES_CONTAINER_WIDTH = 600;
    const ZONES_CONTAINER_HEIGHT = 600;
    const BUTTON_PLACEMENT_RADIUS = 250;
    const VISUAL_BUTTON_CENTER_X = ZONES_CONTAINER_WIDTH / 2; 
    const VISUAL_BUTTON_CENTER_Y = ZONES_CONTAINER_HEIGHT / 2; 
    const ZONE_BUTTON_SIZE = 120;
    const BUTTON_ANGLES_DEGREES = [180, 100, 67, 34, 1]; 

    const zonesContainer = document.getElementById('zones'); 
    const logDisplay = document.getElementById('log');

    // Combo definitions
    const userCombo = ['23', '1', '1'];
    const passCombo = ['14', '14', '245'];
    let currentInput = [];
    let stage = 'user';

    // Audio elements
    const wrongSound = document.getElementById('wrongSound');
    const userCorrectSound = document.getElementById('userCorrect');
    const passCorrectSound = document.getElementById('passCorrect');

    const ZONES_ELEMENTS_BY_FINGER = {}; 
    const touchesCurrentlyDown = new Set(); 
    const fingersInCurrentPotentialChord = new Set(); 
    const keysCurrentlyDown = new Set(); 
    const activeTouchEventToButtonElement = new Map(); 

    const fieldAngleRanges = {
      finger_1_min: 140.0, finger_1_max: 270.5, 
      finger_2_min: 83.5,  finger_2_max: 140.0,  
      finger_3_min: 50.5,  finger_3_max: 83.5,   
      finger_4_min: 17.5,  finger_4_max: 50.5,   
      finger_5_lower_max: 17.5, finger_5_upper_min: 270.5 
    };

    function getFingerNumberForTouchPoint(touchClientX, touchClientY) {
        const screenCenterX = window.innerWidth / 2;
        const screenCenterY = window.innerHeight / 2;
        if (touchClientX === screenCenterX && touchClientY === screenCenterY) return null;

        let angleRad = Math.atan2(screenCenterY - touchClientY, touchClientX - screenCenterX);
        let angleDeg = angleRad * (180 / Math.PI);
        if (angleDeg < 0) angleDeg += 360; 

        if (angleDeg >= fieldAngleRanges.finger_1_min && angleDeg <= fieldAngleRanges.finger_1_max) return '1';
        if (angleDeg >= fieldAngleRanges.finger_2_min && angleDeg <  fieldAngleRanges.finger_2_max) return '2';
        if (angleDeg >= fieldAngleRanges.finger_3_min && angleDeg <  fieldAngleRanges.finger_3_max) return '3';
        if (angleDeg >= fieldAngleRanges.finger_4_min && angleDeg <  fieldAngleRanges.finger_4_max) return '4';
        if (angleDeg <  fieldAngleRanges.finger_5_lower_max || angleDeg > fieldAngleRanges.finger_5_upper_min) return '5';
        return null; 
    }

    function setupVisualButtons() {
        BUTTON_ANGLES_DEGREES.forEach((deg, i) => {
            const fingerNumber = String(i + 1);
            const rad = (deg * Math.PI) / 180;
            const x = VISUAL_BUTTON_CENTER_X + BUTTON_PLACEMENT_RADIUS * Math.cos(rad) - ZONE_BUTTON_SIZE / 2;
            const y = VISUAL_BUTTON_CENTER_Y - BUTTON_PLACEMENT_RADIUS * Math.sin(rad) - ZONE_BUTTON_SIZE / 2;

            const zoneElement = document.createElement('div');
            zoneElement.className = 'zone';
            zoneElement.style.left = `${x}px`;
            zoneElement.style.top = `${y}px`;
            zoneElement.style.width = `${ZONE_BUTTON_SIZE}px`;
            zoneElement.style.height = `${ZONE_BUTTON_SIZE}px`;
            zoneElement.dataset.finger = fingerNumber; 
            zoneElement.textContent = fingerNumber;    
            
            zonesContainer.appendChild(zoneElement);
            ZONES_ELEMENTS_BY_FINGER[fingerNumber] = zoneElement;
        });
    }

    // --- FIXED AUDIO FUNCTION ---
    function playAudio(audioElement) {
      if (!audioElement) {
        logToScreen("Error: Audio element not found");
        return;
      }
      
      // Force volume to 100%
      audioElement.volume = 1.0;
      audioElement.currentTime = 0;
      
      const playPromise = audioElement.play();
      
      if (playPromise !== undefined) {
        playPromise.catch(err => {
          // This will print to the screen if the sound fails
          console.error('Audio play error:', err);
          logToScreen(`Audio Error: ${err.message}`);
        });
      }
    }

    function logToScreen(message) {
        const div = document.createElement('div');
        div.textContent = message;
        logDisplay.appendChild(div);
        logDisplay.scrollTop = logDisplay.scrollHeight;
    }
    
    function checkAndProcessStage() {
        const targetComboArray = stage === 'user' ? userCombo : passCombo;
        if (currentInput.length === targetComboArray.length) { 
            const enteredFullSequence = JSON.stringify(currentInput);
            const targetFullSequence = JSON.stringify(targetComboArray);
            
            if (enteredFullSequence === targetFullSequence) { 
                if (stage === 'user') {
                    logToScreen('User combo CORRECT!');
                    playAudio(userCorrectSound);
                    stage = 'pass';
                    logToScreen('Now enter PASS combo.');
                } else if (stage === 'pass') {
                    logToScreen('Pass combo CORRECT!');
                    playAudio(passCorrectSound); // This triggers the pass sound
                    stage = 'user';
                    logToScreen('Authenticated! Enter USER combo again.');
                }
            } else { 
                logToScreen(`${stage.toUpperCase()} sequence incorrect. Try again.`);
                playAudio(wrongSound);
            }
            currentInput = []; 
        } else if (currentInput.length < targetComboArray.length) { 
            logToScreen(`${stage.toUpperCase()} sequence: ${currentInput.join(' -> ')} ... (${currentInput.length}/${targetComboArray.length})`);
        }
    }

    // --- Touch Event Listeners ---
    document.body.addEventListener('touchstart', (e) => {
        e.preventDefault(); 
        for (let touch of e.changedTouches) {
            const fingerNumber = getFingerNumberForTouchPoint(touch.clientX, touch.clientY);
            if (fingerNumber) {
                const buttonElement = ZONES_ELEMENTS_BY_FINGER[fingerNumber];
                if (buttonElement) buttonElement.classList.add('active');
                fingersInCurrentPotentialChord.add(fingerNumber); 
                touchesCurrentlyDown.add(touch.identifier);
                if (buttonElement) activeTouchEventToButtonElement.set(touch.identifier, buttonElement);
            }
        }
    }, { passive: false });

    document.body.addEventListener('touchend', (e) => {
        e.preventDefault();
        const liftedButtonsThatWereActive = new Set();

        for (let touch of e.changedTouches) {
            if (touchesCurrentlyDown.has(touch.identifier)) {
                const buttonElement = activeTouchEventToButtonElement.get(touch.identifier);
                if (buttonElement) liftedButtonsThatWereActive.add(buttonElement);
                activeTouchEventToButtonElement.delete(touch.identifier);
                touchesCurrentlyDown.delete(touch.identifier);
            }
        }

        liftedButtonsThatWereActive.forEach(buttonElement => {
            let stillActive = false;
            for (const btn of activeTouchEventToButtonElement.values()) {
                if (btn === buttonElement) { stillActive = true; break; }
            }
            if (!stillActive) buttonElement.classList.remove('active');
        });

        if (touchesCurrentlyDown.size === 0 && fingersInCurrentPotentialChord.size > 0) {
            const combo = [...fingersInCurrentPotentialChord].sort().join('');
            currentInput.push(combo);
            logToScreen(`Input: ${combo}`);
            checkAndProcessStage();
            fingersInCurrentPotentialChord.clear();
            
            if(activeTouchEventToButtonElement.size === 0) { 
                 Object.values(ZONES_ELEMENTS_BY_FINGER).forEach(btn => btn.classList.remove('active'));
            }
        } else if (touchesCurrentlyDown.size === 0) {
            Object.values(ZONES_ELEMENTS_BY_FINGER).forEach(btn => btn.classList.remove('active'));
        }
    }, { passive: false });

    // --- Keyboard Event Listeners ---
    document.body.addEventListener('keydown', (e) => {
        const fingerNumber = e.key;
        if (['1', '2', '3', '4', '5'].includes(fingerNumber) && !e.repeat) {
            e.preventDefault(); 
            keysCurrentlyDown.add(fingerNumber);
            fingersInCurrentPotentialChord.add(fingerNumber);
            const buttonElement = ZONES_ELEMENTS_BY_FINGER[fingerNumber];
            if (buttonElement) buttonElement.classList.add('active');
        }
    });

    document.body.addEventListener('keyup', (e) => {
        const fingerNumber = e.key;
        if (['1', '2', '3', '4', '5'].includes(fingerNumber)) {
            e.preventDefault();
            keysCurrentlyDown.delete(fingerNumber);
            if (keysCurrentlyDown.size === 0 && fingersInCurrentPotentialChord.size > 0) {
                const combo = [...fingersInCurrentPotentialChord].sort().join('');
                currentInput.push(combo);
                logToScreen(`Input: ${combo}`);
                checkAndProcessStage();
                fingersInCurrentPotentialChord.clear();
                Object.values(ZONES_ELEMENTS_BY_FINGER).forEach(btn => btn.classList.remove('active'));
            }
        }
    });

    window.addEventListener('DOMContentLoaded', () => {
        setupVisualButtons();
        logToScreen(`Enter ${stage.toUpperCase()} combo.`);
    });
  </script>
</body>
</html>
