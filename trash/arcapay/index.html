<!DOCTYPE html>
<html>
<head>
  <title>Full Screen Field Input - Login Only</title>
  <style>
    body {
      margin: 0;
      background: #111;
      color: #0f0;
      font-family: monospace;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center; 
      height: 100vh;
      width: 100vw; 
      overflow: hidden; 
      touch-action: none;
    }

    /* Start Button Overlay */
    #start-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
    }

    #start-btn {
      padding: 20px 40px;
      font-size: 30px;
      background: #0f0;
      color: #000;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-family: monospace;
      font-weight: bold;
    }

    #zones {
      position: relative;
      width: 600px; 
      height: 600px; 
      margin-bottom: 20px;
    }

    .zone {
      position: absolute;
      width: 120px; 
      height: 120px; 
      border-radius: 50%;
      background: #222;
      border: 2px solid #333;
      transition: background 0.1s;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      user-select: none; 
      color: #0f0; 
    }

    .zone.active {
      background: #0f0; 
      color: #111; 
    }

    #log {
      width: 90vw;
      max-width: 600px;
      height: 150px;
      background: #000;
      border: 1px solid #444;
      padding: 10px;
      overflow-y: auto;
    }
  </style>
</head>
<body>

  <div id="start-overlay">
    <button id="start-btn">TAP TO START</button>
    <p style="margin-top:20px; color:#666;">(Enables Audio)</p>
  </div>

  <div id="zones"></div>
  <div id="log"></div>

  <audio id="wrongSound" src="https://kaffetish.club/trash/wronguserorpass.mp3" preload="auto"></audio>
  <audio id="userCorrect" src="https://kaffetish.club/trash/usercorrect.mp3" preload="auto"></audio>
  <audio id="passCorrect" src="https://kaffetish.club/trash/passcorrect.mp3" preload="auto"></audio>

  <script>
    // Constants
    const ZONES_CONTAINER_WIDTH = 600;
    const ZONES_CONTAINER_HEIGHT = 600;
    const BUTTON_PLACEMENT_RADIUS = 250;
    const VISUAL_BUTTON_CENTER_X = ZONES_CONTAINER_WIDTH / 2; 
    const VISUAL_BUTTON_CENTER_Y = ZONES_CONTAINER_HEIGHT / 2; 
    const ZONE_BUTTON_SIZE = 120;
    const BUTTON_ANGLES_DEGREES = [180, 100, 67, 34, 1]; 

    const zonesContainer = document.getElementById('zones'); 
    const logDisplay = document.getElementById('log');

    // State
    const userCombo = ['23', '1', '1'];
    
    let currentInput = [];
    
    // --- FIX PART 1: ADD GAME STATE FLAG ---
    let isGameActive = false; 

    // Audio
    const wrongSound = document.getElementById('wrongSound');
    const userCorrectSound = document.getElementById('userCorrect');
    const passCorrectSound = document.getElementById('passCorrect');
    const allAudio = [wrongSound, userCorrectSound, passCorrectSound];

    // Elements & Tracking
    const ZONES_ELEMENTS_BY_FINGER = {}; 
    const touchesCurrentlyDown = new Set(); 
    const fingersInCurrentPotentialChord = new Set(); 
    const keysCurrentlyDown = new Set(); 
    const activeTouchEventToButtonElement = new Map(); 

    const fieldAngleRanges = {
      finger_1_min: 140.0, finger_1_max: 270.5, 
      finger_2_min: 83.5,  finger_2_max: 140.0,  
      finger_3_min: 50.5,  finger_3_max: 83.5,   
      finger_4_min: 17.5,  finger_4_max: 50.5,   
      finger_5_lower_max: 17.5, finger_5_upper_min: 270.5 
    };

    // --- AUDIO UNLOCKER ---
    document.getElementById('start-btn').addEventListener('click', function() {
        // 1. Play all sounds muted to unlock them
        allAudio.forEach(audio => {
            audio.muted = true;
            audio.play().then(() => {
                audio.pause();
                audio.currentTime = 0;
                audio.muted = false; // Reset to audible
            }).catch(e => console.error("Unlock error:", e));
        });

        // 2. Hide the overlay
        document.getElementById('start-overlay').style.display = 'none';
        logToScreen("Audio Unlocked. System Ready.");

        // --- FIX PART 2: ACTIVATE GAME ---
        // We set this to true AFTER the click, ensuring the initial tap 
        // doesn't register as game input.
        setTimeout(() => {
            isGameActive = true;
        }, 100);
    });

    function playAudio(audioElement) {
      if (!audioElement) return;
      audioElement.currentTime = 0;
      audioElement.volume = 1.0;
      const p = audioElement.play();
      if (p !== undefined) {
          p.catch(e => {
              logToScreen("Audio Fail: " + e.message);
          });
      }
    }

    function getFingerNumberForTouchPoint(touchClientX, touchClientY) {
        const screenCenterX = window.innerWidth / 2;
        const screenCenterY = window.innerHeight / 2;
        if (touchClientX === screenCenterX && touchClientY === screenCenterY) return null;

        let angleRad = Math.atan2(screenCenterY - touchClientY, touchClientX - screenCenterX);
        let angleDeg = angleRad * (180 / Math.PI);
        if (angleDeg < 0) angleDeg += 360; 

        if (angleDeg >= fieldAngleRanges.finger_1_min && angleDeg <= fieldAngleRanges.finger_1_max) return '1';
        if (angleDeg >= fieldAngleRanges.finger_2_min && angleDeg <  fieldAngleRanges.finger_2_max) return '2';
        if (angleDeg >= fieldAngleRanges.finger_3_min && angleDeg <  fieldAngleRanges.finger_3_max) return '3';
        if (angleDeg >= fieldAngleRanges.finger_4_min && angleDeg <  fieldAngleRanges.finger_4_max) return '4';
        if (angleDeg <  fieldAngleRanges.finger_5_lower_max || angleDeg > fieldAngleRanges.finger_5_upper_min) return '5';
        return null; 
    }

    function setupVisualButtons() {
        BUTTON_ANGLES_DEGREES.forEach((deg, i) => {
            const fingerNumber = String(i + 1);
            const rad = (deg * Math.PI) / 180;
            const x = VISUAL_BUTTON_CENTER_X + BUTTON_PLACEMENT_RADIUS * Math.cos(rad) - ZONE_BUTTON_SIZE / 2;
            const y = VISUAL_BUTTON_CENTER_Y - BUTTON_PLACEMENT_RADIUS * Math.sin(rad) - ZONE_BUTTON_SIZE / 2;

            const zoneElement = document.createElement('div');
            zoneElement.className = 'zone';
            zoneElement.style.left = `${x}px`;
            zoneElement.style.top = `${y}px`;
            zoneElement.style.width = `${ZONE_BUTTON_SIZE}px`;
            zoneElement.style.height = `${ZONE_BUTTON_SIZE}px`;
            zoneElement.dataset.finger = fingerNumber; 
            zoneElement.textContent = fingerNumber;    
            
            zonesContainer.appendChild(zoneElement);
            ZONES_ELEMENTS_BY_FINGER[fingerNumber] = zoneElement;
        });
    }

    function logToScreen(message) {
        const div = document.createElement('div');
        div.textContent = message;
        logDisplay.appendChild(div);
        logDisplay.scrollTop = logDisplay.scrollHeight;
    }
    
    // --- UPDATED LOGIC FOR SINGLE STAGE ---
    function checkAndProcessStage() {
        const targetComboArray = userCombo; // Target is always userCombo

        if (currentInput.length === targetComboArray.length) { 
            const enteredFullSequence = JSON.stringify(currentInput);
            const targetFullSequence = JSON.stringify(targetComboArray);
            
            if (enteredFullSequence === targetFullSequence) { 
                // SUCCESS - Single stage
                logToScreen('ACCESS GRANTED: User Identified.');
                playAudio(passCorrectSound); 
            } else { 
                // FAIL
                logToScreen(`Incorrect sequence. Try again.`);
                playAudio(wrongSound);
            }
            currentInput = []; 
        } else if (currentInput.length < targetComboArray.length) { 
            logToScreen(`Sequence: ${currentInput.join(' -> ')} ... (${currentInput.length}/${targetComboArray.length})`);
        }
    }

    // --- Touch Event Listeners ---
    document.body.addEventListener('touchstart', (e) => {
        // --- FIX PART 3: GUARD CLAUSE ---
        // If the game hasn't started, stop immediately.
        if (!isGameActive) return;

        if(e.target.id !== 'start-btn') {
            e.preventDefault(); 
        }

        for (let touch of e.changedTouches) {
            const fingerNumber = getFingerNumberForTouchPoint(touch.clientX, touch.clientY);
            if (fingerNumber) {
                const buttonElement = ZONES_ELEMENTS_BY_FINGER[fingerNumber];
                if (buttonElement) buttonElement.classList.add('active');
                fingersInCurrentPotentialChord.add(fingerNumber); 
                touchesCurrentlyDown.add(touch.identifier);
                if (buttonElement) activeTouchEventToButtonElement.set(touch.identifier, buttonElement);
            }
        }
    }, { passive: false });

    document.body.addEventListener('touchend', (e) => {
         // --- FIX PART 4: GUARD CLAUSE ---
         if (!isGameActive) return;

         if(e.target.id !== 'start-btn') {
            e.preventDefault(); 
        }
        
        const liftedButtonsThatWereActive = new Set();

        for (let touch of e.changedTouches) {
            if (touchesCurrentlyDown.has(touch.identifier)) {
                const buttonElement = activeTouchEventToButtonElement.get(touch.identifier);
                if (buttonElement) liftedButtonsThatWereActive.add(buttonElement);
                activeTouchEventToButtonElement.delete(touch.identifier);
                touchesCurrentlyDown.delete(touch.identifier);
            }
        }

        liftedButtonsThatWereActive.forEach(buttonElement => {
            let stillActive = false;
            for (const btn of activeTouchEventToButtonElement.values()) {
                if (btn === buttonElement) { stillActive = true; break; }
            }
            if (!stillActive) buttonElement.classList.remove('active');
        });

        if (touchesCurrentlyDown.size === 0 && fingersInCurrentPotentialChord.size > 0) {
            const combo = [...fingersInCurrentPotentialChord].sort().join('');
            currentInput.push(combo);
            logToScreen(`Input: ${combo}`);
            checkAndProcessStage();
            fingersInCurrentPotentialChord.clear();
            
            if(activeTouchEventToButtonElement.size === 0) { 
                 Object.values(ZONES_ELEMENTS_BY_FINGER).forEach(btn => btn.classList.remove('active'));
            }
        } else if (touchesCurrentlyDown.size === 0) {
            Object.values(ZONES_ELEMENTS_BY_FINGER).forEach(btn => btn.classList.remove('active'));
        }
    }, { passive: false });

    // --- Keyboard Event Listeners ---
    document.body.addEventListener('keydown', (e) => {
        // Guard clause for keyboard too
        if (!isGameActive) return;

        const fingerNumber = e.key;
        if (['1', '2', '3', '4', '5'].includes(fingerNumber) && !e.repeat) {
            e.preventDefault(); 
            keysCurrentlyDown.add(fingerNumber);
            fingersInCurrentPotentialChord.add(fingerNumber);
            const buttonElement = ZONES_ELEMENTS_BY_FINGER[fingerNumber];
            if (buttonElement) buttonElement.classList.add('active');
        }
    });

    document.body.addEventListener('keyup', (e) => {
        if (!isGameActive) return;

        const fingerNumber = e.key;
        if (['1', '2', '3', '4', '5'].includes(fingerNumber)) {
            e.preventDefault();
            keysCurrentlyDown.delete(fingerNumber);
            if (keysCurrentlyDown.size === 0 && fingersInCurrentPotentialChord.size > 0) {
                const combo = [...fingersInCurrentPotentialChord].sort().join('');
                currentInput.push(combo);
                logToScreen(`Input: ${combo}`);
                checkAndProcessStage();
                fingersInCurrentPotentialChord.clear();
                Object.values(ZONES_ELEMENTS_BY_FINGER).forEach(btn => btn.classList.remove('active'));
            }
        }
    });

    window.addEventListener('DOMContentLoaded', () => {
        setupVisualButtons();
        logToScreen(`Waiting for Start...`);
    });
  </script>
</body>
</html>
