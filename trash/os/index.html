<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini macOS</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        :root {
            --wallpaper: url('https://images.unsplash.com/photo-1579546929518-9e396f3a8034?q=80&w=2940&auto=format=fit-crop');
            --font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            --shadow-color: rgba(0, 0, 0, 0.3);
            --highlight-color: #007aff;
            --highlight-text: #fff;
        }

        body[data-theme="dark"] {
            --acrylic-bg: rgba(40, 40, 40, 0.6);
            --window-bg: #2d2d2d;
            --window-header: #3c3c3c;
            --sidebar-bg: rgba(0,0,0,0.15);
            --active-sidebar-item: rgba(255,255,255,0.1);
            --border-color: rgba(255, 255, 255, 0.2);
            --primary-text: #f0f0f0;
            --secondary-text: #a0a0a0;
        }

        body[data-theme="light"] {
            --acrylic-bg: rgba(245, 245, 245, 0.6);
            --window-bg: #f7f7f7;
            --window-header: #ececec;
            --sidebar-bg: rgba(0,0,0,0.05);
            --active-sidebar-item: rgba(0,0,0,0.1);
            --border-color: rgba(0, 0, 0, 0.12);
            --primary-text: #222;
            --secondary-text: #666;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; overflow: hidden; }
        body { font-family: var(--font-family); background: var(--wallpaper) center/cover; color: var(--primary-text); user-select: none; }

        #desktop { height: 100%; width: 100%; position: relative; }
        
        #top-menu-bar, #dock { transition: transform 0.3s ease, opacity 0.3s ease; }
        .fullscreen-mode #top-menu-bar, .fullscreen-mode #dock { transform: translateY(100%); opacity: 0; pointer-events: none; }
        .fullscreen-mode #top-menu-bar { transform: translateY(-100%); }

        #top-menu-bar {
            position: absolute; top: 0; left: 0; width: 100%; height: 28px;
            background: var(--acrylic-bg); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 10px; z-index: 10000; font-size: 14px; color: var(--primary-text);
        }
        .menu-section { display: flex; align-items: center; gap: 15px; }
        .menu-item { position: relative; padding: 4px 8px; border-radius: 4px; cursor: default; }
        .app-name { font-weight: 600; }

        #dock {
            position: absolute; bottom: 8px; left: 50%; transform: translateX(-50%);
            display: flex; align-items: flex-end; padding: 8px;
            background: var(--acrylic-bg); backdrop-filter: blur(25px);
            border-radius: 18px; box-shadow: 0 5px 30px var(--shadow-color);
            border: 1px solid var(--border-color); height: 60px;
        }
        .dock-item { position: relative; width: 52px; transition: all 0.2s cubic-bezier(0.3, 1.5, 0.7, 1); cursor: pointer; }
        .dock-item img { width: 100%; filter: drop-shadow(0 2px 5px rgba(0,0,0,0.2)); }
        .dock-item .running-indicator { position: absolute; bottom: -8px; left: 50%; transform: translateX(-50%); width: 5px; height: 5px; background: var(--secondary-text); border-radius: 50%; display: none; }
        .dock-item.running .running-indicator { display: block; }

        .window {
            position: absolute; background: var(--window-bg); color: var(--primary-text);
            border-radius: 12px; box-shadow: 0 20px 60px var(--shadow-color);
            display: flex; flex-direction: column; resize: both; overflow: hidden;
            border: 1px solid var(--border-color); animation: openWindow 0.3s ease;
            opacity: 0.95; transition: opacity 0.2s, box-shadow 0.2s;
        }
        .window.active { opacity: 1; box-shadow: 0 25px 80px var(--shadow-color); }
        .window.fullscreen { top: 0 !important; left: 0 !important; width: 100vw !important; height: 100vh !important; border-radius: 0; resize: none; z-index: 5000 !important; }
        .window-header { height: 40px; background: var(--window-header); display: flex; align-items: center; padding: 0 12px; flex-shrink: 0; cursor: grab; position: relative; border-bottom: 1px solid var(--border-color); }
        .window-controls { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); display: flex; gap: 8px; }
        .control-btn { width: 13px; height: 13px; border-radius: 50%; }
        .close { background-color: #ff605c; } .minimize { background-color: #ffbd44; } .maximize { background-color: #00ca4e; }
        .window-title { flex-grow: 1; text-align: center; font-weight: 500; }
        .window-body { flex-grow: 1; background: var(--window-bg); display: flex; overflow: auto; }

        #spotlight-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.3); backdrop-filter: blur(10px);
            z-index: 11000; display: none; align-items: flex-start; justify-content: center;
            opacity: 0; transition: opacity 0.2s ease;
        }
        #spotlight-overlay.show { display: flex; opacity: 1; }
        #spotlight-search { width: 600px; background: var(--acrylic-bg); margin-top: 20vh; border-radius: 12px; box-shadow: 0 10px 50px rgba(0,0,0,0.4); border: 1px solid var(--border-color); }
        #spotlight-input { width: 100%; background: transparent; border: none; outline: none; padding: 20px 25px; font-size: 24px; color: var(--primary-text); border-bottom: 1px solid var(--border-color); }
        #spotlight-results { max-height: 400px; overflow-y: auto; }
        .result-item { display: flex; align-items: center; gap: 15px; padding: 10px 20px; cursor: pointer; }
        .result-item:hover, .result-item.selected { background: var(--highlight-color); color: var(--highlight-text); }
        .result-item img { width: 32px; height: 32px; }

        .calculator-body { width: 100%; background: #2E2E2E; display: flex; flex-direction: column; }
        .calc-display { flex-grow: 1; color: white; font-size: 64px; text-align: right; padding: 30px 20px; font-weight: 300; }
        .calc-buttons { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1px; }
        .calc-btn { background: #505050; color: white; border: none; font-size: 24px; padding: 20px 0; cursor: pointer; transition: background-color 0.1s; }
        .calc-btn:hover { background: #676767; }
        .calc-btn.op { background: #FF9500; } .calc-btn.op:hover { background: #ffab3a; }
        .calc-btn.func { background: #383838; } .calc-btn.func:hover { background: #4a4a4a; }
        .calc-btn.zero { grid-column: 1 / span 2; }
        
        .settings-body { width: 100%; display: flex; }
        .settings-sidebar { width: 220px; background: var(--sidebar-bg); padding: 10px; border-right: 1px solid var(--border-color); flex-shrink: 0; }
        .sidebar-item { padding: 10px 15px; border-radius: 8px; cursor: pointer; font-weight: 500; }
        .sidebar-item.active, .sidebar-item:hover { background: var(--active-sidebar-item); }
        .settings-content { flex-grow: 1; padding: 30px; }
        .appearance-options { display: flex; gap: 20px; }
        .appearance-box { border: 2px solid var(--border-color); padding: 10px; border-radius: 8px; cursor: pointer; text-align: center; }
        .appearance-box.selected { border-color: var(--highlight-color); }
    </style>
</head>
<body data-theme="dark">
    <div id="desktop"></div>
    <div id="top-menu-bar">
        <div class="menu-section left"></div>
        <div class="menu-section right"></div>
    </div>
    <div id="dock"></div>
    <div id="spotlight-overlay">
        <div id="spotlight-search">
            <input id="spotlight-input" type="text" placeholder="Spotlight Search">
            <div id="spotlight-results"></div>
        </div>
    </div>
    <script>
    const ICONS = {
        'Finder': 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAACACAYAAADDPmHLAAAFyElEQVR4Xu2dP48cNRSFz/d6E7i1oKChoKCgoKCgoKCgoKCgoKCgoKCgoKChoKDgP0KCA0EhwUFCISFBQkJCQkJCREJCQkKCQyQ4JIeFwQ1+tLd29947O/PuaZObzI5nZ3ffN/t27w6XmYyPj3d7e3s72Xz9+nU7Pz9vR0dH28n06NEjW1lZ+fWzXFtb235+fp7N/B+4/3g7Ozvb7u/vj+b3n34s4+Pj/T5/N/zRkXb/hAsXLmzHjx9/3Wz2T7bT09M/+3c6hG1gIADXrl2zgwcPbu7cE3oN7G9s/N/7B0B/L/b+wX54eLidnp5u7Xf/4uLibrP5h4eH/W4/e/as/f///xP64qWlpb3O68/m9fA/uLi4/Otz//p06+vrY3e2m9Xh6+vrcX2jI83k/xH5rM/v7+83gX8z8f7+/vY/9/9qjY+P9zvw/hHwf6+P/b9a39/fH9/i/oH8/3T/z5/fNl3yX9749u3b7dGjR9vOnTsX3v/s7Gzb399vFxcXy93n/7+fH8m/fPny3hW7zR6Y+L6+vo/9i/u/eB+4X3l7e3s3+z/d5wF9/P/9y/vP7/59//b29p/2/7J+J3oNLAJAAAJAAAJAAAJAAAIwUAI4PDx8/7k+kAAkAAkAgSMAcDAYgX/58mW3u7vb7u7u/u99cHAwm6gEIAEJQAIQgAQgAQm4BCA+hP/7+vo+8n6/d4v7R/Z4+j+l8/vP73f/uP/8T2w8x8fHO/I+cO3aNdvd3d3953N7ezs7Oztj97cQAAkAgScA8Uf2W7dulYMDAAFAAI4gAPFP7F+/vjs+Pr5/3o/58+eP7d+/P14/d+7c8eXLl8e7j/u/O84/+T9/4v7x/i/+w/n5+eP/f6dOnTrW39+/y/3Z2dl47V9cXByvLgFIAAI4hwDc3t7+2z0gAQk4jgD8T8Tz/R/p/l05Pj7+13kEIAEJQAIQgAQgAQn4BQHI+Pj4n+0/NjbW/d5v/gGA//3337ePHz/+s7/ZzP+BvH/58mX3//706VP3/+6/vH/x4kV3/P+X/P9/G/d/4X/++vXrb+9v5+fn3d5+Pj4+/vW57+7u/s1p3g4EAiAAASCAcwjA3d3d+t7LzWYA+Pn52Z6enravr298Xwz+d+/eff/t7u5u7f/i4uLzB9b9+/d/+qf35+fn/d1eXl4ezyWAAAQgAAEgAAEgAAEIgIELwNPT0/b29nZeQAIQgAQgAAkAgSgA7nN4eLjd3d1tqAMPDAxsnz59+s0BOH/+/L7b399/Xn26zR5++PDh/X53l/zv7u6+L2z+j+sBAQEAgAAQgAQgAAQgAAQgAAQgAQlA/A/g+Pj4P8gDSQASgAQgAIkEIP4I/n3f7+7u/us8AkACEIAEIACJUwCbAQGAgAAgAAEIwBAE4IULF8btb53vP93n/u/+/fvb0dHR5/Uf6/z+D/Z/5/cP9n/+/Pnz/R/u+Ph4N/i/X63+3+3/D51fX1/328/m9QCAwN/fP/5n/z/Zf/z4cTwGggAEAQEAgAAQeAIQ3w/w9PS0/f///3+7T19fH9/3/3d/8X7w/vL+/v4+2H/+8Pz8/P6f7e8D/P/+H/vPnz/f7p/s+Pv7Oz6fEAAgAIEgAO5vB/jP/+7k5GR/8n/79u3x/Xp+fr4357Ozsx/vYxSAAAQgAAEgAAEgAAEImIQA/D/v6urqP+gDSQASgAQgAIkQgPhj+X/mAwABQAACQACGJADRj+f8/Pyt/QMA/hH95ubm/d3m/5H+l3f/33d3d+M1/wcCgP+d8/vPnz/X78f/d/l/L+j+X3P8/3/g/3e/Pz/9P9v/u/w/FHD/7hCAgAAgAAEIQMABAeDq6mp/9j85Oflv/+3k5GT79ddf//V5fRKAQAACQACeCAD+b/+P/R+vPxQ/gAAQgAAQgAAQgAAQgAAS/wWc7vL5v5oJNAAAAABJRU5ErkJggg==',
        'System Settings': 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAACACAYAAADDPmHLAAAFpUlEQVR4Xu2dP48cNRSAz1nIuA14C4aGgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoIC/wPcgAsggoIiJiZGREQkIiIiIiIiIiIiIjIyIiKy2G8aM7Ozb4/b1yZ5kk1m5+fdV/u/u/ftVlPZ3d097Ozs/Fk3t7e3t729vb097MHBwW15eTnb2Nj4u+dZW1vbHh4eHm03/g/wL95eXl5u+/v7Z9P/138K4+PjA3/+bvjDIwL/Qrh58+b2/PnzW6vNfsn29vb2T/8uJ2B3YCMAnjp1qv3111/X7NkTegu2PzZ+8HwAGD3EHgDZ3d29NTc3N1ar/Qf/i7N5wM/PzwP65B88eLDNzc3N9evXrw/oK19fXw/s9a/N6+F/cXEx/b/u/vTp8uXLe8PudrM6fH19fdze6EhA/p/IHfJ8f39/BP93wP39/T/5P/h/L4+Pjwfo/TPA/x4f+H9t/f39/THc/QP5/1P//8y/bZf8f3P89u3b2NjY2L/Z2VlZfN+zZ8/a8vLy8PL4n87+xPJ/+/btW1e02QwA+P7+/pj/mP/F/UD+xevr63+z/8f3eQAfv/+feP/hf/3r6+uv+n/p+4Tegk0AAAAAAAQAAAAAgAAAAMCACXBwcPDWcz0gAIAAIAAEjgHAYDDw58+f7/b29rbt7Ox80X99fHyMiaiAAgAAAQAAAQAAAQABXAJQPwD8/f19xPr93q3/H8kfSP/P5/yv/3f/8X9h4zk5Odni/wDXrl3bPDw8/NXczc3N7e3t/THc3wIAAQAA4AkA+SO5e/fudaQDAACAAByBAJH8kT9//ny3vb39vP2MDRs2bMiTJ0/G6xMnTgzvPu7/7jj/5H/+xP3j/Rf/wfz8/Pj/P3Xq1OHh4eF173/58uV49cHBwePWBQABAAAcQgDu7++P5AdAAAhwBAH4B4L5/Q/v/lU5OTn5r/MIQAAAIAAAIAAAIAAAD/gDAPkjs7Ky8lzvN5cDAv+X/P/u7Oxszc/P3+rn4eHh3/0bGxv/d57//7i4OL1/4X/9+vXrb3P+wYMHG6v/4eHhT/O83x/2h4SEAAACQADHEIC7u7v9vWd2HwHg4eHhvrKy8v8+GAz+d+/eff/29vZ2y7+4uPjNAXD9+vXP+vP1x8fHx/s5Ozt72Z/n5+e3r/n5+fntK4AAAEAAAAAgAAAAMCAC8PT09Pb29nZeAQIAAQAAAQAAjggAvs/Pz7e9vb3NCoDjx4/v27dv378XwDdv3ty+v7//vPq42Qw+efLkdr87yf/+/v5XNv8n9AEBAAAAEAAAAAAAAAAAEAAAAAAAAID4B+Dk5OSX+SAlAQAAAgAA4EgEIP4Y/P+O6/1/+oAAAIAAAIAAAI5TAJsBIAAAAQAAQADAEAD+9OkT9/61fR/u/+7cuXMlICDwm/+je/n6+prX/+3t7fM/v5/O/7i4OFar/0v25+fn/f6zX8v1n3/L/n+z/w+dX15ezus/m9cDAIF/e3vb5P/4//z58+NZAQAAAgAAAAAA4AEBPP1D+vTp02G5x8fH++Xk5OTWf/L//v378X/R+yP7D+4D95f39/f/uT6vPv/+hP+4//z58+NfEAAAAAAAAEBAAu7u7gb4L/x/eHh43z8xMDDwBwMBAAEAAAAAAAgAAAAAAAAAgCQ/APl//fr1o35IEgAAAIAAAEBEBCH+iPkf8AFAAAIAAABAIAlA9AP5z58/b/8AgH9Ev7+/v/n+/j/R/+Uf//85OTnpt/xX/f//P/V+P/2/X/63+3fr//X+79T/1/t//f/4/yD/7kUAAAAAAIAABCAA5J+s/2v/33//fU7Oz8/Pfn9eXwQQAAAIAADwggD4b/+P7T9u/8QAAQAAAQAAAAAAAQAAQOJfgM+9eGf8Gj2YAAAAAElFTkSuQmCC',
        'Calculator': 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAACACAYAAADDPmHLAAADIklEQVR4Xu3ZMQ7CMBAAwXASd3MhXgMhbosb0GgIuAgHwImLsRkSgqg7g9+fJG3/tXzSjY1eA0ACEIAEJIAjASR3AgkACEAAAmACQHJ3IAEJQAAC0CSAzG1AEgACEICAdQJIchkCEIAABDgSQHIDkAQgAQhAQCMAJI1RAAm4AEjuBBIACEAACMAEgOTuQAIQgAAEoEkAmdtAEgACEICAdQJIchkCEIAABDgSQHIDkAQgAQhAQCMAJI1RAAm4AEjuBBIACEAACMAEgOTuQAIQgAAEoEkAmdtAEgACEICAdQJIchkCEIAABDgSQHIDkAQgAQhAQCMAJI1RAAm4AEjuBBIACEAACMAEgOTuQAIQgAAEoEkAmdtAEgACEICAdQJIchkCEIAABDgSQHIDkAQgAQhAQCMAJI1RAAm4AEjuBBIACEAACMAEgOTuQAIQgAAEoEkAmdtAEgACEICAdQJIchkCEIAABDgSQHIDkAQgAQhAQCMAJI1RAAm4AEjuBBIACEAACMAEgOTuQAIQgAAEoEkAmdtAEgACEICAdQJIchkCEIAABDgSQHIDkAQgAQhAQCMAJI1RAAm4AEjuBBIACEAACMAEgOTuQAIQgAAEoEkAmdtAEgACEICAdQJIchkCEIAABDgSQHIDkAQgAQhAQCMAJI1RAAm4AEjuBBIACEAACMAEgOTuQAIQgAAEoEkAmdtAEgACEICAdQJIchkCEIAABDgSQHIDkAQgAQhAQCMAJI1RAAm4AEjuBBIACEAACMAEgOTuQAIQgAAEoEkAmdtAEgACEICAdQJIchkCEIAABDgSQHIDkAQgAQhAQCMAJI1RAAm4AEjuBBIACEAACMAEgOTuQAIQgAAEoEkAmdtAEgACEICAdQJIchkCEIAABDgSQHIDkAQgAQhAQCMAJI1RAAm4AEjuBBIACEAACMAEgOTuQAIQgAAEoEkAmdtAEgACEICAdQJIchkCEIAABDgSQHIDkAQgAQhAQCMAJI1RAAm4AEjuBBIACEAACMDAH4A2qB8WJ/zAAAAAElFTkSuQmCC',
        'TextEdit': 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAACACAYAAADDPmHLAAACF0lEQVR4Xu3ZMQ4CMRBE0WwngVw25yAOAiGu4kQ4iwto5gC5t3EMj5A+Qn4JqO/3J/n9u6GkhwASgAQgAYgTAJI7gASAAASAgAkAydwBCUACEAACTQBI7gYkAAEgAIGdAJA8gQYgAQgAgScA5EkgAYgTAJI7gASAAASAgAkAydwBCUACEAACTQBI7gYkAAEgAIGdAJA8gQYgAQgAgScA5EkgAYgTAJI7gASAAASAgAkAydwBCUACEAACTQBI7gYkAAEgAIGdAJA8gQYgAQgAgScA5EkgAYgTAJI7gASAAASAgAkAydwBCUACEAACTQBI7gYkAAEgAIGdAJA8gQYgAQgAgScA5EkgAYgTAJI7gASAAASAgAkAydwBCUACEAACTQBI7gYkAAEgAIGdAJA8gQYgAQgAgScA5EkgAYgTAJI7gASAAASAgAkAydwBCUACEAACTQBI7gYkAAEgAIGdAJA8gQYgAQgAgScA5EkgAYgTAJI7gASAAASAgAkAydwBCUACEAACTQBI7gYkAAEgAIGdAJA8gQYgAQgAgScA5EkgAYgTAJI7gASAAASAgAkAydwBCUACEAACTQBI7gYkAAEgAIGdAJA8gQYgAQgAgScA5EkgAYgTAJI7gASAAASAgAkAydwBCUACEAACTQBI7gYkAAEgAIGdAJA8gQYgAQgAgScA5EkgAYgTAJI7gASAAASAgAkAydwBCUACEAACTQBI7gYkAAEgAIGdAJA8gQYgAQgAgScA5EkgAYgTAJI7gASAAASAgAn8BfbA7rJ5DBZBAAAAAElFTkSuQmCC',
    };
    
    class GeminiMacOS {
        constructor() {
            this.state = {
                vfs: { 'Desktop': [], 'Documents': [], 'Downloads': [], 'contents': {} },
                openWindows: {},
                activeApp: 'Finder',
                settings: { theme: 'dark' }
            };
            this.highestZIndex = 100;
            this.apps = {
                'Finder': { icon: ICONS.Finder, menus: {'File':{'New Folder':()=>console.log('new folder')}} },
                'System Settings': { icon: ICONS['System Settings'], menus: {}},
                'Calculator': { icon: ICONS.Calculator, menus: {}},
                'TextEdit': { icon: ICONS.TextEdit, menus: {
                    'File': { 'New': null, 'Open': null, 'Save': (app) => app.saveFile() },
                    'Edit': { 'Cut': null, 'Copy': null, 'Paste': null }
                }},
            };
            this.init();
        }

        init() {
            this.loadState();
            this.applySettings();
            this.updateMenuBar(); // Build the menu bar structure first
            this.renderDock();
            this.updateTime(); // Now it's safe to update time
            setInterval(() => this.updateTime(), 5000); // Update time less frequently
            this.setupEventListeners();
        }

        loadState() {
            const savedState = localStorage.getItem('geminiMacOSState');
            if (savedState) this.state = JSON.parse(savedState);
        }

        saveState() {
            localStorage.setItem('geminiMacOSState', JSON.stringify(this.state));
        }

        applySettings() { document.body.dataset.theme = this.state.settings.theme; }
        
        updateTime() {
            const clockEl = document.getElementById('clock');
            if (clockEl) {
                clockEl.textContent = new Date().toLocaleString('en-US', {
                    weekday: 'short', month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit'
                });
            }
        }
        
        updateMenuBar() {
            const app = this.apps[this.state.activeApp];
            const left = document.querySelector('#top-menu-bar .left');
            left.innerHTML = `<i class="ph-fill ph-apple-logo" style="font-size: 18px;"></i><span class="app-name">${this.state.activeApp}</span>`;
            // Simplified menu logic for now
        }
        
        renderDock() {
            const dock = document.getElementById('dock');
            dock.innerHTML = '';
            for (const appName in this.apps) {
                const item = document.createElement('div');
                item.className = 'dock-item';
                item.dataset.app = appName;
                if(this.state.openWindows[appName]) item.classList.add('running');
                item.innerHTML = `<img src="${this.apps[appName].icon}" alt="${appName}"><div class="running-indicator"></div>`;
                dock.appendChild(item);
            }
        }

        createWindow(appName) {
            if (this.state.openWindows[appName]) { this.focusWindow(appName); return; }
            
            const win = document.createElement('div');
            win.className = 'window';
            win.dataset.app = appName;
            
            const appInstance = this.getAppInstance(appName, win);
            this.state.openWindows[appName] = { el: win, instance: appInstance };
            
            win.innerHTML = `<div class="window-header"><div class="window-controls"><span class="control-btn close"></span><span class="control-btn minimize"></span><span class="control-btn maximize"></span></div><div class="window-title">${appInstance.title || ''}</div></div>`;
            win.appendChild(appInstance.body);
            
            document.getElementById('desktop').appendChild(win);
            this.focusWindow(appName);

            win.querySelector('.maximize').addEventListener('click', () => {
                win.classList.toggle('fullscreen');
                document.getElementById('desktop').classList.toggle('fullscreen-mode');
            });
        }

        focusWindow(appName) {
            Object.values(this.state.openWindows).forEach(w => w.el.classList.remove('active'));
            this.state.activeApp = appName;
            this.highestZIndex++;
            this.state.openWindows[appName].el.style.zIndex = this.highestZIndex;
            this.state.openWindows[appName].el.classList.add('active');
            this.updateMenuBar();
            this.renderDock();
        }

        closeWindow(appName) {
            this.state.openWindows[appName].el.remove();
            delete this.state.openWindows[appName];
            this.state.activeApp = 'Finder';
            this.updateMenuBar();
            this.renderDock();
        }
        
        setupEventListeners() {
            const dock = document.getElementById('dock');
            dock.addEventListener('click', e => {
                const item = e.target.closest('.dock-item');
                if (item) this.createWindow(item.dataset.app);
            });
            
            dock.addEventListener('mousemove', e => {
                const rect = dock.getBoundingClientRect();
                const mouseX = e.clientX - rect.left;
                Array.from(dock.children).forEach(item => {
                    const itemRect = item.getBoundingClientRect();
                    const itemCenterX = itemRect.left - rect.left + itemRect.width / 2;
                    const distance = Math.abs(mouseX - itemCenterX);
                    const scale = Math.max(1, 1.8 - distance / 100);
                    item.style.width = `${52 * scale}px`;
                });
            });

            dock.addEventListener('mouseleave', () => Array.from(dock.children).forEach(item => item.style.width = '52px'));
            
            document.getElementById('desktop').addEventListener('mousedown', e => {
                const win = e.target.closest('.window');
                if (win) this.focusWindow(win.dataset.app);
                else {
                    this.state.activeApp = 'Finder';
                    this.updateMenuBar();
                    Object.values(this.state.openWindows).forEach(w => w.el.classList.remove('active'));
                }
            });

            document.getElementById('desktop').addEventListener('click', e => {
                const c = e.target;
                if(c.classList.contains('close')) this.closeWindow(c.closest('.window').dataset.app);
            });

            const spotlight = document.getElementById('spotlight-overlay');
            const spotlightInput = document.getElementById('spotlight-input');
            const spotlightResults = document.getElementById('spotlight-results');
            document.addEventListener('keydown', e => {
                if ((e.ctrlKey || e.metaKey) && e.code === 'Space') {
                    e.preventDefault();
                    spotlight.classList.toggle('show');
                    if (spotlight.classList.contains('show')) {
                        spotlightInput.value = '';
                        spotlightResults.innerHTML = '';
                        spotlightInput.focus();
                    }
                }
                if (e.key === 'Escape' && spotlight.classList.contains('show')) spotlight.classList.remove('show');
            });
            spotlightInput.addEventListener('input', () => {
                const query = spotlightInput.value.toLowerCase();
                spotlightResults.innerHTML = '';
                if (!query) return;
                Object.keys(this.apps).forEach(appName => {
                    if (appName.toLowerCase().includes(query)) {
                        const item = document.createElement('div');
                        item.className = 'result-item';
                        item.innerHTML = `<img src="${this.apps[appName].icon}"> <div><h4>${appName}</h4><span>Application</span></div>`;
                        item.onclick = () => {
                            this.createWindow(appName);
                            spotlight.classList.remove('show');
                        };
                        spotlightResults.appendChild(item);
                    }
                });
            });
        }
        
        getAppInstance(appName, win) {
            switch(appName) {
                case "System Settings": return new SystemSettings(this);
                case "Calculator": return new Calculator();
                default: return { body: document.createElement('div'), title: appName };
            }
        }
    }

    class SystemSettings {
        constructor(os) {
            this.os = os; this.body = document.createElement('div');
            this.body.className = 'settings-body'; this.title = "System Settings";
            this.render('Appearance'); this.addEventListeners();
        }
        render(page) {
            this.body.innerHTML = `<div class="settings-sidebar"><div class="sidebar-item active" data-page="Appearance">Appearance</div></div>
                <div class="settings-content"><h3>Appearance</h3><div class="appearance-options">
                <div class="appearance-box ${this.os.state.settings.theme === 'light' ? 'selected' : ''}" data-theme="light">Light</div>
                <div class="appearance-box ${this.os.state.settings.theme === 'dark' ? 'selected' : ''}" data-theme="dark">Dark</div></div></div>`;
        }
        addEventListeners() {
            this.body.addEventListener('click', e => {
                const box = e.target.closest('.appearance-box');
                if (box) {
                    this.os.state.settings.theme = box.dataset.theme;
                    this.os.applySettings(); this.os.saveState(); this.render('Appearance');
                }
            });
        }
    }

    class Calculator {
        constructor() {
            this.body = document.createElement('div'); this.body.className = 'calculator-body'; this.title = "Calculator";
            this.displayValue = '0'; this.firstOperand = null; this.waiting = false; this.operator = null;
            this.render(); this.addEventListeners();
        }
        render() {
            this.body.innerHTML = `<div class="calc-display">${this.displayValue}</div><div class="calc-buttons">
                <button class="calc-btn func" data-key="AC">AC</button><button class="calc-btn func" data-key="+/-">+/-</button><button class="calc-btn func" data-key="%">%</button><button class="calc-btn op" data-key="/">÷</button>
                <button class="calc-btn" data-key="7">7</button><button class="calc-btn" data-key="8">8</button><button class="calc-btn" data-key="9">9</button><button class="calc-btn op" data-key="*">×</button>
                <button class="calc-btn" data-key="4">4</button><button class="calc-btn" data-key="5">5</button><button class="calc-btn" data-key="6">6</button><button class="calc-btn op" data-key="-">−</button>
                <button class="calc-btn" data-key="1">1</button><button class="calc-btn" data-key="2">2</button><button class="calc-btn" data-key="3">3</button><button class="calc-btn op" data-key="+">+</button>
                <button class="calc-btn zero" data-key="0">0</button><button class="calc-btn" data-key=".">.</button><button class="calc-btn op" data-key="=">=</button></div>`;
        }
        addEventListeners(){this.body.addEventListener('click',e=>{const k=e.target.dataset.key;if(!k)return;if('1234567890'.includes(k))this.digit(k);else if(k==='.')this.decimal();else if('+-*/'.includes(k))this.op(k);else if(k==='=')this.equals();else if(k==='AC')this.reset();else if(k==='+/-')this.toggleSign();else if(k==='%')this.percent();this.update();});}
        digit(d){if(this.waiting){this.displayValue=d;this.waiting=false;}else{this.displayValue=this.displayValue==='0'?d:this.displayValue+d;}}
        decimal(){if(!this.displayValue.includes('.'))this.displayValue+='.';}
        op(o){const v=parseFloat(this.displayValue);if(this.operator&&this.waiting){this.operator=o;return;}if(this.firstOperand===null){this.firstOperand=v;}else if(this.operator){const r=this.calc(this.firstOperand,v,this.operator);this.displayValue=`${parseFloat(r.toFixed(7))}`;this.firstOperand=r;}this.waiting=true;this.operator=o;}
        calc(a,b,o){if(o==='+')return a+b;if(o==='-')return a-b;if(o==='*')return a*b;if(o==='/')return a/b;return b;}
        equals(){if(!this.operator)return;const v=parseFloat(this.displayValue);const r=this.calc(this.firstOperand,v,this.operator);this.displayValue=`${parseFloat(r.toFixed(7))}`;this.firstOperand=null;this.operator=null;this.waiting=true;}
        reset(){this.displayValue='0';this.firstOperand=null;this.waiting=false;this.operator=null;}
        toggleSign(){this.displayValue=(parseFloat(this.displayValue)*-1).toString();}
        percent(){this.displayValue=(parseFloat(this.displayValue)/100).toString();}
        update(){this.body.querySelector('.calc-display').innerText=this.displayValue.slice(0,10);}
    }

    new GeminiMacOS();
    </script>
</body>
</html>
