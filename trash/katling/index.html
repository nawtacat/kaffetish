<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Katling - Final Demo</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,700;1,400&family=Inter:wght@400;500;600;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --font-body: 'Lora', serif;
            --font-ui: 'Inter', sans-serif;
            --color-background: #FFFFFF;
            --color-text-primary: #111111;
            --color-text-secondary: #6c757d;
            --color-border: #f0f0f0;
            --color-brand: #ff1c55;
            --border-radius: 6px;
            --max-width: 720px;
        }

        *, *::before, *::after { box-sizing: border-box; }

        body {
            font-family: var(--font-ui);
            background-color: var(--color-background);
            color: var(--color-text-primary);
            margin: 0;
            -webkit-font-smoothing: antialiased;
        }

        /* --- Layout & Navigation --- */
        .app-container {
            max-width: var(--max-width);
            margin: 0 auto;
            padding: 0 1.5rem;
        }
        
        .main-nav {
            padding: 1.5rem 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--color-border);
            margin-bottom: 3.5rem;
        }
        
        .nav-logo img {
            /* CHANGED: Logo is now twice the size */
            height: 56px; 
            cursor: pointer;
        }
        
        .nav-links {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .nav-links a {
            color: var(--color-text-primary);
            text-decoration: none;
            font-weight: 600;
            transition: color 0.2s;
            font-size: 0.95rem;
        }
        .nav-links a:hover { color: var(--color-brand); }
        .nav-links a.new-post-btn img {
            height: 32px; /* Icon logo */
            transition: transform 0.2s ease;
        }
        .nav-links a.new-post-btn:hover img {
            transform: scale(1.1) rotate(10deg);
        }

        /* --- Buttons --- */
        .primary-btn {
            background-color: var(--color-brand);
            color: white; border: none; padding: 0.8rem 1.75rem;
            border-radius: var(--border-radius); font-weight: 600; cursor: pointer; text-decoration: none;
            display: inline-block; transition: background-color 0.2s;
        }
        .primary-btn:hover { background-color: #d9174a; }

        .secondary-btn {
            background: none; color: var(--color-text-primary); border: 1px solid #ccc; padding: 0.8rem 1.75rem;
            border-radius: var(--border-radius); font-weight: 600; cursor: pointer; text-decoration: none;
            display: inline-block; transition: all 0.2s;
        }
        .secondary-btn:hover { background-color: var(--color-text-primary); color: white; border-color: var(--color-text-primary); }
        .secondary-btn.active { background: var(--color-text-primary); color: white; border-color: var(--color-text-primary); }

        /* --- Post Card (Feed) - Blended Design --- */
        .feed-container { display: flex; flex-direction: column; }
        .post-card {
            padding: 2.5rem 0;
            border-bottom: 1px solid var(--color-border);
            cursor: pointer;
        }
        .post-card:hover h2 { color: var(--color-brand); }
        
        .author-info { display: flex; align-items: center; gap: 10px; margin-bottom: 1.25rem; font-size: 0.9rem; }
        .author-avatar { width: 32px; height: 32px; border-radius: 50%; }
        .author-name { font-weight: 600; }

        .post-card h2 {
            font-family: var(--font-ui); font-size: 2rem; font-weight: 800; letter-spacing: -0.8px;
            margin: 0 0 0.5rem 0; transition: color 0.2s;
        }
        .post-card p.subtitle {
            font-family: var(--font-body); font-size: 1.1rem; line-height: 1.7;
            color: var(--color-text-secondary); margin: 0;
        }
        
        .post-meta {
            margin-top: 1.5rem; font-size: 0.8rem; color: #999;
            display: flex; gap: 1.5rem; text-transform: uppercase; letter-spacing: 0.5px;
        }

        /* --- Single Post View --- */
        .post-view { padding-top: 2rem; }
        .post-view h1 {
            font-family: var(--font-ui); font-size: 3.5rem; font-weight: 800; letter-spacing: -2px;
            line-height: 1.1; margin: 1.5rem 0;
        }
        .post-view .post-meta { margin: 2rem 0 3rem 0; }
        .article-content {
            font-family: var(--font-body); font-size: 1.2rem; line-height: 1.9;
        }
        .article-content p { margin: 0 0 2rem 0; }
        
        /* Profile Page - Blended Design */
        .profile-header {
            text-align: center; padding: 3rem 0; margin-bottom: 2rem;
            border-bottom: 1px solid var(--color-border);
            display: flex; flex-direction: column; align-items: center; gap: 1.25rem;
        }
        .profile-header .author-avatar { width: 90px; height: 90px; border-radius: 50%; }
        .profile-header h2 { font-size: 2.5rem; font-weight: 800; margin: 0; }
        .profile-header p { font-size: 1.1rem; color: var(--color-text-secondary); max-width: 500px; margin: 0 auto; line-height: 1.6; }
        
        /* Forms & Editor */
        .form-view, .editor-view { padding: 2rem 0; }
        .form-view h1, .editor-view h1 { font-size: 2.5rem; letter-spacing: -1px; margin: 0 0 2.5rem 0; }
        .form-field { display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 1.5rem; }
        .form-field label { font-weight: 600; font-size: 0.9rem; }
        .form-field input, .form-field textarea {
            width: 100%; border: 1px solid #ccc; background: #f8f9fa; border-radius: var(--border-radius);
            padding: 0.85rem 1rem; font-size: 1rem; font-family: var(--font-ui);
        }

        #editor-title {
            font-size: 3rem; font-weight: 800; letter-spacing: -1.5px; width: 100%;
            margin-bottom: 0.5rem; border: none; padding: 0; background: none;
        }
        #editor-title:focus { outline: none; }
        #editor-content { font-family: var(--font-body); font-size: 1.2rem; line-height: 1.9; width: 100%; min-height: 50vh; resize: vertical; border: none; padding: 0; background: none;}
        #editor-content:focus { outline: none; }
        .editor-toggle { display: flex; gap: 1rem; margin-bottom: 2rem; border-bottom: 1px solid var(--color-border); padding-bottom: 2rem; }
        .editor-toggle label { font-weight: 600; cursor: pointer; padding: 0.5rem 1rem; border-radius: var(--border-radius); border: 1px solid transparent; }
        .editor-toggle input { display: none; }
        .editor-toggle input:checked + label { background-color: #fff0f3; border-color: var(--color-brand); color: var(--color-brand); }
        #poll-options-container { display: flex; flex-direction: column; gap: 0.75rem; }
        .poll-option-input { display: flex; gap: 1rem; }
        .poll-option-input input { border: 1px solid var(--color-border) !important; padding: 0.75rem !important; font-size: 1rem !important; }

        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .app-container { padding: 0 1rem; }
            .main-nav { padding: 1rem 0; margin-bottom: 1.5rem; }
            /* CHANGED: Mobile logo size adjusted */
            .nav-logo img { height: 36px; } 
            .nav-links { gap: 1rem; }
            .nav-links a.desktop-only { display: none; }
            .nav-links a.new-post-btn img { height: 28px; }

            .post-card { padding: 2rem 0; }
            .post-card h2 { font-size: 1.5rem; }
            
            .post-view { padding-top: 0; }
            .post-view h1 { font-size: 2.25rem; letter-spacing: -1px; }
            .article-content { font-size: 1.1rem; line-height: 1.8; }

            .profile-header { padding: 2rem 0; }
            .profile-header h2 { font-size: 2rem; }
            .profile-header .author-avatar { width: 80px; height: 80px; }
            
            #editor-title { font-size: 2rem; }
        }

        /* Other unchanged styles for poll, responses, etc. */
        .poll-option { background: none; border: 1px solid #ccc; border-radius: var(--border-radius); padding: 1rem; margin-bottom: 1rem; cursor: pointer; transition: border-color 0.2s, background-color 0.2s; font-weight: 500; }
        .poll-option:hover { border-color: var(--color-brand); background-color: #fff8f9; }
        .poll-option-result { border: 1px solid transparent; border-radius: var(--border-radius); margin-bottom: 1rem; position: relative; overflow: hidden; background: #f8f9fa;}
        .poll-option-result.voted { border-color: var(--color-brand); }
        .poll-result-bar { background: var(--color-brand); opacity: 0.1; height: 100%; position: absolute; top: 0; left: 0; transition: width 0.5s ease; }
        .poll-result-text { position: relative; z-index: 1; padding: 1rem; display: flex; justify-content: space-between; font-weight: 600; }
        .poll-result-text .voted-check { color: var(--color-brand); font-weight: 700; }
        .article-actions { margin: 3rem 0; display: flex; align-items: center; gap: 1.5rem; padding: 1.5rem 0; border-top: 1px solid var(--color-border); border-bottom: 1px solid var(--color-border); }
        .action-btn { background: none; border: 1px solid #ccc; border-radius: 20px; padding: 0.6rem 1.2rem; cursor: pointer; display: flex; align-items: center; gap: 8px; font-weight: 600; transition: all 0.2s; }
        .action-btn:hover { border-color: var(--color-text-primary); }
        .action-btn.applauded { background-color: #fff0f3; border-color: var(--color-brand); color: var(--color-brand); }
        .responses-section { margin-top: 4rem; padding-top: 3rem; border-top: 1px solid var(--color-border); }
        .responses-section h3 { font-size: 1.5rem; margin-bottom: 2rem; }
        .response-form textarea { width: 100%; min-height: 120px; border: 1px solid #ccc; border-radius: var(--border-radius); padding: 1rem; font-family: var(--font-body); font-size: 1.1rem; margin-bottom: 1rem; background: #f8f9fa; }
        .response-list { margin-top: 3rem; }
        .response { display: flex; gap: 1rem; margin-bottom: 2rem; border-bottom: 1px solid var(--color-border); padding-bottom: 2rem; }
        .response-author .author-avatar { width: 40px; height: 40px; border-radius: 50%; }
        .response-content p { margin: 0; line-height: 1.6; font-family: var(--font-body); font-size: 1.05rem; }
        .response-content .author-name { font-weight: 600; margin-bottom: 0.5rem; display: block; }
        .hidden { display: none; }
    </style>
</head>
<body>

    <div class="app-container" id="app-container"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- DATABASE & PERSISTENCE ---
            const DB_KEY = 'katling_db_v3'; // Use a new key for the new design
            let DB;

            const defaultDB = {
                users: {
                    1: { id: 1, name: "Sonia", avatar: "https://i.pravatar.cc/150?u=sonia", bio: "Exploring the intersection of technology and public policy. Believes in rigorous debate and thoughtful disagreement.", listening: [2, 3] },
                    2: { id: 2, name: "ExistentialBeef", avatar: "https://i.pravatar.cc/150?u=beef", bio: "Here to ask the hard questions about philosophy and ethics.", listening: [1] },
                    3: { id: 3, name: "Ada", avatar: "https://i.pravatar.cc/150?u=ada", bio: "Data scientist and climate advocate.", listening: [1, 2] }
                },
                posts: [
                    { id: 101, type: 'article', userId: 2, title: "The Tyranny of the Algorithm", subtitle: "We've outsourced our curiosity to recommendation engines. It's time to take it back.", content: "<p>It begins subtly. You watch one video about restoring old tools, and suddenly your digital life is an endless stream of rusty wrenches and Japanese whetstones. The algorithm, in its infinite and opaque wisdom, has decided you are Tool Person. This isn't just a YouTube phenomenon; it's the defining logic of our information age.</p><p>From the news we read to the music we hear, our tastes are being perpetually narrowed and reinforced by automated systems designed for one thing: engagement. The path of least resistance is the path of a thousand more of the same. This creates comfortable, predictable echo chambers that starve genuine curiosity. True discovery is messy, inefficient, and often uncomfortable. It requires us to venture beyond the recommended, to actively seek out what we don't know we'll like. The greatest threat of the algorithm isn't that it's biased, but that it's relentlessly, suffocatingly efficient at giving us what it thinks we want, leaving no room for what we might actually need.</p>", applauds: [1, 3], responses: [{ userId: 1, text: "This is so true. I have to actively fight my feed to find new ideas. It's exhausting." }] },
                    { id: 102, type: 'poll', userId: 1, title: "Should social media platforms be treated as public utilities?", options: [{ text: "Yes, they are essential infrastructure.", votes: [3] }, { text: "No, they are private companies.", votes: [2] }, { text: "It's more complicated than that.", votes: [] }], applauds: [2], responses: [] },
                    { id: 103, type: 'article', userId: 1, title: "Regulating AI is Not a Tech Problem, It's a Power Problem", subtitle: "The debate over AI safety often misses the point. The real question is who controls it.", content: "<p>The public discourse around artificial intelligence is dominated by sci-fi narratives: super-intelligent AIs breaking free, sentient robots, and existential threats. While these make for great movies, they distract from the much more immediate and tangible issue: the concentration of power.</p><p>AI is not an autonomous force of nature; it is a tool built and controlled by human institutions. The real danger lies in how corporations and governments will wield this tool to entrench their power, automate inequality, and erode privacy. Arguing about the consciousness of a large language model is a philosophical luxury when that same model is being used to create autonomous surveillance systems or biased hiring tools. Effective regulation, therefore, must focus less on speculative future risks and more on present-day accountability, transparency, and the distribution of power. It's not about leashing the machine; it's about holding its masters accountable.</p>", applauds: [2, 3], responses: [] },
                ]
            };
            
            function loadDB() { const dbJson = localStorage.getItem(DB_KEY); DB = dbJson ? JSON.parse(dbJson) : defaultDB; }
            function saveDB() { localStorage.setItem(DB_KEY, JSON.stringify(DB)); }

            const state = { loggedInUserId: 1 };
            const appContainer = document.getElementById('app-container');

            function router() {
                const path = window.location.hash.slice(1) || '/';
                const [view, param] = path.split('/').filter(Boolean);
                appContainer.innerHTML = '';
                appContainer.appendChild(createNav());
                const mainContent = document.createElement('main');
                switch (view) {
                    case 'article': mainContent.appendChild(createArticleView(parseInt(param))); break;
                    case 'poll': mainContent.appendChild(createPollView(parseInt(param))); break;
                    case 'profile':
                        if (param === 'edit') mainContent.appendChild(createProfileEditView());
                        else mainContent.appendChild(createProfileView(parseInt(param)));
                        break;
                    case 'new': mainContent.appendChild(createEditorView()); break;
                    default: mainContent.appendChild(createFeedView()); break;
                }
                appContainer.appendChild(mainContent);
            }

            // --- COMPONENT CREATORS ---

            function createNav() {
                const nav = document.createElement('nav');
                nav.className = 'main-nav';
                nav.innerHTML = `
                    <a href="#/" class="nav-logo"><img src="https://kaffetish.club/trash/katling/katlingText.png" alt="Katling Logo"></a>
                    <div class="nav-links">
                        <a href="#/" class="desktop-only">Feed</a>
                        <a href="#/profile/${state.loggedInUserId}" class="desktop-only">My Profile</a>
                        <a href="#/new" class="new-post-btn" title="New Post">
                            <img src="https://kaffetish.club/trash/katling/katling1.png" alt="New Post">
                        </a>
                    </div>
                `;
                return nav;
            }
            
            function createFeedView() {
                const container = document.createElement('div');
                container.className = 'feed-container';
                const listeningList = [state.loggedInUserId, ...DB.users[state.loggedInUserId].listening];
                const feedPosts = DB.posts.filter(p => listeningList.includes(p.userId));

                if (feedPosts.length === 0) {
                    container.innerHTML = `<div style="padding: 4rem 0; text-align: center; color: var(--color-text-secondary);"><p>Your feed is empty. Find authors to listen to via their articles or posts.</p></div>`
                }
                
                feedPosts.sort((a,b) => b.id - a.id).forEach(post => {
                    const author = DB.users[post.userId];
                    const card = document.createElement('div');
                    card.className = 'post-card';
                    card.dataset.id = post.id;
                    card.innerHTML = `
                        <div class="author-info">
                            <img src="${author.avatar}" class="author-avatar">
                            <span class="author-name">${author.name}</span>
                        </div>
                        <h2>${post.title}</h2>
                        ${post.type === 'article' ? `<p class="subtitle">${post.subtitle}</p>`: ''}
                        <div class="post-meta">
                            ${post.type === 'article' ? `<span>${Math.ceil(post.content.split(' ').length / 200)} MIN READ</span>` : '<span>POLL</span>'}
                            <span>${post.responses.length} RESPONSES</span>
                            <span>${post.applauds.length} APPLAUDS</span>
                        </div>
                    `;
                    card.addEventListener('click', () => window.location.hash = `/${post.type}/${post.id}`);
                    container.appendChild(card);
                });
                return container;
            }

            function createArticleView(postId) {
                const post = DB.posts.find(p => p.id === postId);
                const view = createPostShell(post);
                const articleContent = document.createElement('div');
                articleContent.className = 'article-content';
                articleContent.innerHTML = post.content;
                view.querySelector('.post-body').appendChild(articleContent);
                return view;
            }

            function createPollView(postId) {
                const post = DB.posts.find(p => p.id === postId);
                const view = createPostShell(post);
                const pollContainer = document.createElement('div');
                pollContainer.className = 'poll-container';
                const totalVotes = post.options.reduce((sum, opt) => sum + opt.votes.length, 0);
                const userVoteIndex = post.options.findIndex(opt => opt.votes.includes(state.loggedInUserId));
                post.options.forEach((option, index) => {
                    if (userVoteIndex !== -1) {
                        const percentage = totalVotes > 0 ? (option.votes.length / totalVotes) * 100 : 0;
                        const optionEl = document.createElement('div');
                        optionEl.className = `poll-option-result ${index === userVoteIndex ? 'voted' : ''}`;
                        optionEl.innerHTML = `
                            <div class="poll-result-bar" style="width: ${percentage}%;"></div>
                            <div class="poll-result-text">
                                <span>${option.text}</span>
                                <span class="voted-check">${index === userVoteIndex ? '‚úì ' : ''}${percentage.toFixed(0)}%</span>
                            </div>
                        `;
                        pollContainer.appendChild(optionEl);
                    } else {
                        const optionEl = document.createElement('div');
                        optionEl.className = 'poll-option';
                        optionEl.textContent = option.text;
                        optionEl.addEventListener('click', () => handleVote(postId, index));
                        pollContainer.appendChild(optionEl);
                    }
                });
                view.querySelector('.post-body').appendChild(pollContainer);
                return view;
            }
            
            function createPostShell(post) {
                const author = DB.users[post.userId];
                const container = document.createElement('div');
                container.className = 'post-view';
                const isApplauded = post.applauds.includes(state.loggedInUserId);
                container.innerHTML = `
                    <div class="author-info" style="cursor: pointer;" onclick="window.location.hash='/profile/${author.id}'">
                        <img src="${author.avatar}" class="author-avatar"> <span class="author-name">${author.name}</span>
                    </div>
                    <h1>${post.title}</h1>
                    <div class="post-meta">
                        <span>${post.type === 'article' ? `${Math.ceil(post.content.split(' ').length / 200)} MIN READ` : 'POLL'}</span>
                        <span id="applauds-count-${post.id}">${post.applauds.length} APPLAUDS</span>
                    </div>
                    <div class="post-body"></div>
                    <div class="article-actions">
                        <button class="action-btn ${isApplauded ? 'applauded' : ''}" id="applaud-btn">üëè Applaud</button>
                    </div>
                    <div class="responses-section">
                        <h3>${post.responses.length} Responses</h3>
                        <form class="response-form" id="response-form"><textarea placeholder="Write a thoughtful response..." required></textarea><button type="submit" class="primary-btn">Submit</button></form>
                        <div class="response-list" id="response-list"></div>
                    </div>
                `;
                renderResponses(container, post.responses);
                container.querySelector('#applaud-btn').addEventListener('click', () => handleApplaud(post.id));
                container.querySelector('#response-form').addEventListener('submit', (e) => handleResponse(e, post.id));
                return container;
            }

            function renderResponses(container, responses) {
                 const responseList = container.querySelector('#response-list');
                 responseList.innerHTML = '';
                responses.forEach(response => {
                    const responder = DB.users[response.userId];
                    const responseEl = document.createElement('div');
                    responseEl.className = 'response';
                    responseEl.innerHTML = `<div class="response-author"><img src="${responder.avatar}" class="author-avatar" style="cursor: pointer;" onclick="window.location.hash='/profile/${responder.id}'"></div><div class="response-content"><strong class="author-name" style="cursor: pointer;" onclick="window.location.hash='/profile/${responder.id}'">${responder.name}</strong><p>${response.text}</p></div>`;
                    responseList.appendChild(responseEl);
                });
            }

            function createProfileView(userId) {
                const user = DB.users[userId];
                const container = document.createElement('div');
                container.className = 'profile-view';
                let actionButtonHtml = '';
                if (userId === state.loggedInUserId) {
                    actionButtonHtml = `<a href="#/profile/edit" class="secondary-btn">Edit Profile</a>`;
                } else {
                    const isListening = DB.users[state.loggedInUserId].listening.includes(userId);
                    actionButtonHtml = `<button class="${isListening ? 'secondary-btn active' : 'primary-btn'}" id="listen-btn">${isListening ? 'Listening' : 'Listen'}</button>`;
                }
                container.innerHTML = `<div class="profile-header"><img src="${user.avatar}" class="author-avatar"><h2>${user.name}</h2><p>${user.bio}</p><div class="profile-actions">${actionButtonHtml}</div></div><div class="feed-container"></div>`;
                const feedContainer = container.querySelector('.feed-container');
                DB.posts.filter(p => p.userId === userId).forEach(post => {
                    const card = document.createElement('div');
                    card.className = 'post-card';
                    card.innerHTML = `<h2>${post.title}</h2><p class="subtitle">${post.type === 'article' ? post.subtitle : 'Poll'}</p>`;
                    card.addEventListener('click', () => window.location.hash = `/${post.type}/${post.id}`);
                    feedContainer.appendChild(card);
                });
                if (userId !== state.loggedInUserId) {
                    container.querySelector('#listen-btn').addEventListener('click', () => handleListen(userId));
                }
                return container;
            }
            
            function createProfileEditView() {
                const user = DB.users[state.loggedInUserId];
                const container = document.createElement('div');
                container.className = 'form-view';
                container.innerHTML = `
                    <h1>Edit Profile</h1>
                    <form id="profile-edit-form">
                        <div class="form-field">
                            <label for="edit-name">Name</label>
                            <input type="text" id="edit-name" value="${user.name}" required>
                        </div>
                        <div class="form-field">
                            <label for="edit-bio">Bio</label>
                            <textarea id="edit-bio" required>${user.bio}</textarea>
                        </div>
                        <button type="submit" class="primary-btn">Save Changes</button>
                    </form>
                `;
                container.querySelector('#profile-edit-form').addEventListener('submit', handleUpdateProfile);
                return container;
            }
            
            function createEditorView() {
                const container = document.createElement('div');
                container.className = 'editor-view';
                container.innerHTML = `
                    <form class="editor-form" id="editor-form">
                        <div class="editor-toggle">
                            <input type="radio" id="type-article" name="post-type" value="article" checked><label for="type-article">Article</label>
                            <input type="radio" id="type-poll" name="post-type" value="poll"><label for="type-poll">Poll</label>
                        </div>
                        <input type="text" id="editor-title" placeholder="Title your piece...">
                        <div id="article-editor-fields">
                             <textarea id="editor-content" placeholder="Tell your story..."></textarea>
                        </div>
                        <div id="poll-editor-fields" class="hidden">
                            <div id="poll-options-container">
                                <div class="poll-option-input"><input type="text" placeholder="Option 1"></div>
                                <div class="poll-option-input"><input type="text" placeholder="Option 2"></div>
                            </div>
                            <button type="button" id="add-option-btn" class="secondary-btn" style="margin-top: 1rem; padding: 0.5rem 1rem;">+ Add Option</button>
                        </div>
                        <button type="submit" class="primary-btn" style="margin-top: 2rem;">Publish</button>
                    </form>
                `;

                const form = container.querySelector('#editor-form');
                const articleFields = container.querySelector('#article-editor-fields');
                const pollFields = container.querySelector('#poll-editor-fields');
                const addOptionBtn = container.querySelector('#add-option-btn');

                form.elements['post-type'].forEach(radio => {
                    radio.addEventListener('change', (e) => {
                        articleFields.classList.toggle('hidden', e.target.value !== 'article');
                        pollFields.classList.toggle('hidden', e.target.value !== 'poll');
                    });
                });
                
                addOptionBtn.addEventListener('click', () => {
                    const optionContainer = container.querySelector('#poll-options-container');
                    const newOption = document.createElement('div');
                    newOption.className = 'poll-option-input';
                    newOption.innerHTML = `<input type="text" placeholder="Option ${optionContainer.children.length + 1}">`;
                    optionContainer.appendChild(newOption);
                });

                form.addEventListener('submit', handlePublish);
                return container;
            }

            // --- EVENT HANDLERS ---
            function handlePublish(event) {
                event.preventDefault();
                const form = event.target;
                const title = form.querySelector('#editor-title').value.trim();
                const type = form.elements['post-type'].value;

                if (!title) return alert('A title is required.');

                let newPost;
                const newPostId = (DB.posts.length > 0 ? Math.max(...DB.posts.map(p => p.id)) : 100) + 1;

                if (type === 'article') {
                    const content = form.querySelector('#editor-content').value.trim();
                    if (!content) return alert('Article content cannot be empty.');
                    newPost = {
                        id: newPostId, type: 'article', userId: state.loggedInUserId, title,
                        subtitle: content.substring(0, 100) + '...',
                        content: `<p>${content.replace(/\n\s*\n/g, '</p><p>').replace(/\n/g, '<br>')}</p>`,
                        applauds: [], responses: []
                    };
                } else { // Poll
                    const options = Array.from(form.querySelectorAll('#poll-options-container input'))
                        .map(input => input.value.trim()).filter(text => text);
                    if (options.length < 2) return alert('Polls must have at least two options.');
                    newPost = {
                        id: newPostId, type: 'poll', userId: state.loggedInUserId, title,
                        options: options.map(text => ({ text, votes: [] })),
                        applauds: [], responses: []
                    };
                }
                
                DB.posts.push(newPost);
                saveDB();
                window.location.hash = `/${newPost.type}/${newPost.id}`;
            }

            function handleApplaud(postId) { const post = DB.posts.find(p => p.id === postId); const i = post.applauds.indexOf(state.loggedInUserId); if(i > -1) post.applauds.splice(i, 1); else post.applauds.push(state.loggedInUserId); saveDB(); router(); }
            function handleResponse(e, postId) { e.preventDefault(); const txt = e.target.querySelector('textarea'); if(!txt.value.trim()) return; const post = DB.posts.find(p=>p.id===postId); post.responses.push({userId:state.loggedInUserId, text:txt.value.trim()}); saveDB(); router(); }
            function handleListen(userId) { const list = DB.users[state.loggedInUserId].listening; const i = list.indexOf(userId); if(i > -1) list.splice(i, 1); else list.push(userId); saveDB(); router(); }
            function handleVote(postId, optionIndex) { const post = DB.posts.find(p => p.id === postId); if (post.options.some(opt => opt.votes.includes(state.loggedInUserId))) return; post.options[optionIndex].votes.push(state.loggedInUserId); saveDB(); router(); }
            function handleUpdateProfile(e) { e.preventDefault(); const name = document.getElementById('edit-name').value.trim(); const bio = document.getElementById('edit-bio').value.trim(); if(!name||!bio) return; DB.users[state.loggedInUserId].name=name; DB.users[state.loggedInUserId].bio=bio; saveDB(); window.location.hash=`/profile/${state.loggedInUserId}`; }

            // --- Initial Load & Route Handling ---
            loadDB();
            window.addEventListener('hashchange', router);
            router();
        });
    </script>
</body>
</html>
