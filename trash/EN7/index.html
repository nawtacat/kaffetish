<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebAuthn Biometric Passkey Demo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
    </style>
</head>
<body class="p-4">

    <div id="app" class="bg-white p-6 md:p-10 rounded-xl shadow-2xl w-full max-w-lg space-y-6">
        <h1 class="text-3xl font-bold text-gray-900 text-center">WebAuthn Passkey Demo</h1>
        <p class="text-center text-gray-600">
            This demonstrates the secure, passwordless authentication flow using your device's biometrics (like fingerprint or face scan) via the WebAuthn API.
        </p>
        
        <!-- Status and Check Section -->
        <div id="status-box" class="p-4 rounded-lg border border-yellow-300 bg-yellow-50 text-yellow-800 text-sm">
            <p id="webauthn-status" class="font-medium"></p>
        </div>
        
        <!-- Main Form -->
        <div class="space-y-4 pt-4 border-t border-gray-100">
            <input type="text" id="username" value="user_123" placeholder="Enter Username" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" />
            
            <button id="registerButton" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 rounded-lg transition duration-150 shadow-md focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-50">
                1. Register Passkey (Biometrics)
            </button>
            
            <button id="authButton" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 rounded-lg transition duration-150 shadow-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50" disabled>
                2. Authenticate (Log In)
            </button>
        </div>

        <!-- Message Log -->
        <div class="space-y-2 pt-4">
            <p class="text-lg font-semibold text-gray-800">Activity Log:</p>
            <div id="messageLog" class="h-40 overflow-y-auto p-3 text-sm bg-gray-100 rounded-lg border border-gray-300 space-y-1">
                <p class="text-gray-500">Awaiting user action...</p>
            </div>
        </div>

    </div>

    <script>
        const usernameInput = document.getElementById('username');
        const registerButton = document.getElementById('registerButton');
        const authButton = document.getElementById('authButton');
        const messageLog = document.getElementById('messageLog');
        const webauthnStatus = document.getElementById('webauthn-status');

        // --- MOCK SERVER/DATABASE (In a real app, this is your backend server) ---
        // Stores the registered Passkey credential ID for the user
        let registeredCredentialId = null; 
        
        // Base64Url helper functions (Required for WebAuthn)
        const arrayBufferToBase64Url = (buffer) => btoa(String.fromCharCode.apply(null, new Uint8Array(buffer)))
            .replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
        const base64UrlToArrayBuffer = (base64Url) => {
            let base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            while (base64.length % 4) {
                base64 += '=';
            }
            return Uint8Array.from(atob(base64), c => c.charCodeAt(0)).buffer;
        };
        // ------------------------------------------------------------------------
        
        // Utility to log messages
        function log(message, type = 'info') {
            const p = document.createElement('p');
            p.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            p.className = `text-gray-700 ${type === 'error' ? 'text-red-600 font-bold' : ''}`;
            messageLog.prepend(p);
        }

        // 1. Initial Check for WebAuthn support
        if (window.isSecureContext && navigator.credentials) {
            webauthnStatus.textContent = "WebAuthn API is supported in this browser.";
            document.getElementById('status-box').className = 'p-4 rounded-lg border border-green-300 bg-green-50 text-green-800 text-sm';
        } else {
            webauthnStatus.textContent = "WebAuthn API is NOT supported (or running in an insecure context like HTTP). Biometric login will not work.";
            registerButton.disabled = true;
            authButton.disabled = true;
            document.getElementById('status-box').className = 'p-4 rounded-lg border border-red-300 bg-red-50 text-red-800 text-sm';
        }

        // 2. Register a Passkey
        registerButton.addEventListener('click', async () => {
            const username = usernameInput.value.trim();
            if (!username) {
                log("Please enter a username.", 'error');
                return;
            }
            log(`Attempting to register Passkey for: ${username}...`);
            
            // Generate a unique challenge (real world: generated by server)
            const challenge = window.crypto.getRandomValues(new Uint8Array(32));
            const userId = base64UrlToArrayBuffer(btoa(username)); // Mock ID

            const publicKeyCredentialCreationOptions = {
                // Relying Party (Your website/app) Info
                rp: { id: window.location.hostname, name: "WebAuthn Demo" },
                // User Info
                user: {
                    id: userId,
                    name: username,
                    displayName: username,
                },
                // Cryptographic Challenge (Must be securely generated by server)
                challenge: challenge,
                // Credential Parameters (Require public key algorithm)
                pubKeyCredParams: [{ type: 'public-key', alg: -7 }], // ES256
                // Timeout and other optional settings
                timeout: 60000, 
                attestation: 'none'
            };

            try {
                // This triggers the native OS/device prompt (fingerprint/face scan)
                const credential = await navigator.credentials.create({
                    publicKey: publicKeyCredentialCreationOptions
                });
                
                // --- SERVER STEP 1 (Mock) ---
                // The server receives the credential object and stores the ID and public key.
                registeredCredentialId = arrayBufferToBase64Url(credential.rawId);
                authButton.disabled = false;
                log(`‚úÖ Registration Successful! Credential ID stored (Mock DB): ${registeredCredentialId}`);
                log("You can now click 'Authenticate'.");

            } catch (err) {
                log(`‚ùå Registration Failed: ${err.message}. User likely cancelled the biometric prompt.`, 'error');
                console.error(err);
            }
        });

        // 3. Authenticate (Log In)
        authButton.addEventListener('click', async () => {
            const username = usernameInput.value.trim();
            if (!username || !registeredCredentialId) {
                log("Please register a Passkey first.", 'error');
                return;
            }
            log(`Attempting to authenticate Passkey for: ${username}...`);

            // Generate a fresh challenge (real world: generated by server)
            const challenge = window.crypto.getRandomValues(new Uint8Array(32));

            const publicKeyCredentialRequestOptions = {
                // Cryptographic Challenge (Must be securely generated by server)
                challenge: challenge,
                // List of credentials the user might have (to speed up auth)
                allowCredentials: [{
                    type: 'public-key',
                    id: base64UrlToArrayBuffer(registeredCredentialId) 
                }],
                timeout: 60000,
            };

            try {
                // This triggers the native OS/device prompt (fingerprint/face scan)
                const assertion = await navigator.credentials.get({
                    publicKey: publicKeyCredentialRequestOptions
                });

                // --- SERVER STEP 2 (Mock) ---
                // The server receives the assertion, verifies the signature using the stored public key,
                // and confirms the authentication was successful.
                const credentialIdReturned = arrayBufferToBase64Url(assertion.rawId);

                if (credentialIdReturned === registeredCredentialId) {
                    log(`üéâ Authentication Successful! Logged in as: ${username}.`, 'info');
                    // In a real app, you would issue a session token here.
                } else {
                    log(`Authentication failed: Credential ID mismatch.`, 'error');
                }

            } catch (err) {
                log(`‚ùå Authentication Failed: ${err.message}. User likely cancelled the biometric prompt or tried the wrong finger.`, 'error');
                console.error(err);
            }
        });

    </script>
</body>
</html>
