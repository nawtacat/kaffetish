<!DOCTYPE html>
<html>
<head>
  <title>Biometric + Chord Auth</title>
  <style>
    body {
      margin: 0;
      background: #050505;
      color: #00ffcc; /* Cyan/Teal for a more "Bio" feel */
      font-family: 'Courier New', monospace;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center; 
      height: 100vh;
      width: 100vw; 
      overflow: hidden; 
      touch-action: none;
    }

    /* Start Overlay */
    #start-overlay {
      position: absolute;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.95);
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
    }
    #start-btn {
      padding: 20px 40px;
      font-size: 24px;
      background: #00ffcc;
      color: #000;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-family: monospace;
      font-weight: bold;
      letter-spacing: 2px;
    }

    /* --- BIOMETRIC SCANNER VISUALS --- */
    #scanner-container {
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      width: 300px; height: 300px;
      border: 1px dashed #333;
      border-radius: 50%;
      pointer-events: none; /* Let touches pass through */
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0.5;
      transition: all 0.5s;
    }
    
    #fingerprint-icon {
      width: 120px;
      height: 160px;
      border: 4px solid #333;
      border-radius: 60px;
      position: relative;
      overflow: hidden;
      transition: border-color 0.3s;
    }

    /* The scanning laser line */
    #scan-line {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 4px;
      background: #00ffcc;
      box-shadow: 0 0 10px #00ffcc;
      opacity: 0;
    }

    .scanning #scan-line {
      opacity: 1;
      animation: scanMove 1.5s infinite linear;
    }

    .scanning #fingerprint-icon {
      border-color: #00ffcc;
      background: rgba(0, 255, 204, 0.05);
    }
    
    .verified #fingerprint-icon {
      border-color: #0f0;
      background: rgba(0, 255, 0, 0.1);
      box-shadow: 0 0 20px rgba(0,255,0,0.2);
    }

    @keyframes scanMove {
      0% { top: 0%; }
      50% { top: 100%; }
      100% { top: 0%; }
    }

    /* --- CHORD ZONES --- */
    #zones {
      position: relative;
      width: 100vw; 
      height: 100vh; 
      z-index: 10;
    }

    .zone {
      position: absolute;
      width: 80px; 
      height: 80px; 
      border-radius: 50%;
      background: rgba(20, 20, 20, 0.8);
      border: 1px solid #444;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      user-select: none; 
      color: #555; 
      transition: all 0.1s;
    }

    .zone.active {
      background: #00ffcc; 
      color: #000; 
      box-shadow: 0 0 15px #00ffcc;
      transform: scale(1.1);
    }

    /* --- HUD ELEMENTS --- */
    #top-hud {
      position: absolute;
      top: 40px;
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      pointer-events: none;
      z-index: 20;
    }

    #step-indicators {
      display: flex;
      gap: 15px;
      margin-bottom: 10px;
    }

    .step-dot {
      width: 15px; height: 15px;
      border: 2px solid #333;
      border-radius: 50%;
      transition: background 0.3s, border-color 0.3s;
    }
    .step-dot.filled { background: #00ffcc; border-color: #00ffcc; }
    .step-dot.error { background: #f00; border-color: #f00; }
    .step-dot.success { background: #0f0; border-color: #0f0; }

    #status-text {
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: #888;
    }
    
    #bio-status {
      position: absolute;
      bottom: 40px;
      font-size: 12px;
      color: #444;
      z-index: 20;
      pointer-events: none;
    }

  </style>
</head>
<body>

  <div id="start-overlay">
    <button id="start-btn">INITIALIZE SYSTEM</button>
  </div>

  <div id="top-hud">
    <div id="step-indicators">
      <div class="step-dot" id="dot-0"></div>
      <div class="step-dot" id="dot-1"></div>
      <div class="step-dot" id="dot-2"></div>
      <div class="step-dot" id="dot-3"></div>
    </div>
    <div id="status-text">Awaiting Input</div>
  </div>

  <div id="scanner-container">
    <div id="fingerprint-icon">
      <div id="scan-line"></div>
    </div>
  </div>
  <div id="bio-status">BIOMETRICS: STANDBY</div>

  <div id="zones"></div>

  <audio id="sfx-scan" src="https://kaffetish.club/trash/scifi_loop.mp3" loop></audio>
  <audio id="sfx-blip" src="https://kaffetish.club/trash/usercorrect.mp3"></audio>
  <audio id="sfx-denied" src="https://kaffetish.club/trash/wronguserorpass.mp3"></audio>
  <audio id="sfx-grant" src="https://kaffetish.club/trash/passcorrect.mp3"></audio>

  <script>
    /* --- CONFIGURATION --- */
    // The target sequence of 4 chords
    // '1'=Thumb, '2'=Index, etc. '12' = Thumb+Index chord.
    const TARGET_SEQUENCE = ['12', '3', '4', '15']; 
    
    // UI Constants
    const VISUAL_BUTTON_CENTER_X = window.innerWidth / 2; 
    const VISUAL_BUTTON_CENTER_Y = window.innerHeight / 2; 
    const BUTTON_PLACEMENT_RADIUS = 220; 
    const ZONE_BUTTON_SIZE = 80;
    const BUTTON_ANGLES_DEGREES = [180, 110, 70, 30, 0]; // 5 fingers

    // --- STATE MANAGEMENT ---
    let currentSequenceIndex = 0;
    let biometricVerified = false;
    let isScanning = false;
    let inputLocked = false;
    
    // --- ELEMENTS ---
    const zonesContainer = document.getElementById('zones'); 
    const scannerContainer = document.getElementById('scanner-container');
    const bioStatusText = document.getElementById('bio-status');
    const mainStatusText = document.getElementById('status-text');
    const stepDots = [
      document.getElementById('dot-0'),
      document.getElementById('dot-1'),
      document.getElementById('dot-2'),
      document.getElementById('dot-3')
    ];

    // --- AUDIO ---
    const sfxScan = document.getElementById('sfx-scan');
    sfxScan.volume = 0.2; 
    const sfxBlip = document.getElementById('sfx-blip');
    const sfxDenied = document.getElementById('sfx-denied');
    const sfxGrant = document.getElementById('sfx-grant');

    // --- INITIALIZATION ---
    document.getElementById('start-btn').addEventListener('click', () => {
      document.getElementById('start-overlay').style.display = 'none';
      // Unlock Audio context
      [sfxScan, sfxBlip, sfxDenied, sfxGrant].forEach(a => {
        a.play().then(() => a.pause()).catch(()=>{});
        a.currentTime=0;
      });
      mainStatusText.textContent = "SECURE CHANNEL OPEN";
      setupVisualButtons();
    });

    // --- BIOMETRIC SIMULATION ---
    function startBiometricScan() {
      if (isScanning || biometricVerified) return;
      isScanning = true;
      
      // Update UI
      scannerContainer.classList.add('scanning');
      bioStatusText.textContent = "BIOMETRICS: ANALYZING...";
      bioStatusText.style.color = "#00ffcc";
      sfxScan.play();

      // Simulate a 3 second scan process
      setTimeout(() => {
        completeBiometricScan();
      }, 3000);
    }

    function completeBiometricScan() {
      isScanning = false;
      biometricVerified = true;
      
      // Update UI
      scannerContainer.classList.remove('scanning');
      scannerContainer.classList.add('verified');
      bioStatusText.textContent = "BIOMETRICS: VERIFIED";
      bioStatusText.style.color = "#0f0";
      sfxScan.pause();
      sfxScan.currentTime = 0;

      // Check if we were waiting for this
      checkFinalSuccess();
    }

    // --- INPUT LOGIC ---
    function handleChordInput(chord) {
      if (inputLocked) return;

      // Trigger biometrics on first input if not started
      startBiometricScan();

      const expectedChord = TARGET_SEQUENCE[currentSequenceIndex];

      if (chord === expectedChord) {
        // Correct Chord
        playOneShot(sfxBlip);
        stepDots[currentSequenceIndex].classList.add('filled');
        currentSequenceIndex++;
        
        mainStatusText.textContent = `SEQUENCE ${currentSequenceIndex}/4 OK`;

        if (currentSequenceIndex === TARGET_SEQUENCE.length) {
          checkFinalSuccess();
        }
      } else {
        // Wrong Chord
        handleFailure();
      }
    }

    function checkFinalSuccess() {
      // Logic: Needs complete sequence AND biometric verification
      if (currentSequenceIndex === TARGET_SEQUENCE.length) {
        if (biometricVerified) {
          grantAccess();
        } else {
          mainStatusText.textContent = "WAITING FOR BIO...";
        }
      }
    }

    function grantAccess() {
      inputLocked = true;
      mainStatusText.textContent = "ACCESS GRANTED";
      mainStatusText.style.color = "#0f0";
      playOneShot(sfxGrant);
      stepDots.forEach(d => d.classList.add('success'));
      
      // Visual celebration
      document.body.style.background = "#021105";
      zonesContainer.style.opacity = "0.2";
    }

    function handleFailure() {
      playOneShot(sfxDenied);
      mainStatusText.textContent = "SEQUENCE MISMATCH";
      mainStatusText.style.color = "#f00";
      stepDots.forEach(d => {
        d.classList.remove('filled');
        d.classList.add('error');
      });

      // Reset
      currentSequenceIndex = 0;
      setTimeout(() => {
        stepDots.forEach(d => d.classList.remove('error'));
        mainStatusText.textContent = "RETRY SEQUENCE";
        mainStatusText.style.color = "#888";
      }, 800);
    }

    function playOneShot(audio) {
      audio.currentTime = 0;
      audio.play().catch(e => console.log(e));
    }

    // --- TOUCH & ZONE LOGIC (Reused from previous system) ---
    // (Simplified for brevity, same core logic)
    
    const fieldAngleRanges = {
      finger_1_min: 140.0, finger_1_max: 270.5, 
      finger_2_min: 83.5,  finger_2_max: 140.0,  
      finger_3_min: 50.5,  finger_3_max: 83.5,   
      finger_4_min: 17.5,  finger_4_max: 50.5,   
      finger_5_lower_max: 17.5, finger_5_upper_min: 270.5 
    };

    const ZONES_ELEMENTS_BY_FINGER = {};
    const fingersInCurrentPotentialChord = new Set();
    const touchesCurrentlyDown = new Set();
    const activeTouchEventToButtonElement = new Map();

    function setupVisualButtons() {
        BUTTON_ANGLES_DEGREES.forEach((deg, i) => {
            const fingerNumber = String(i + 1);
            const rad = (deg * Math.PI) / 180;
            const x = VISUAL_BUTTON_CENTER_X + BUTTON_PLACEMENT_RADIUS * Math.cos(rad) - ZONE_BUTTON_SIZE / 2;
            const y = VISUAL_BUTTON_CENTER_Y - BUTTON_PLACEMENT_RADIUS * Math.sin(rad) - ZONE_BUTTON_SIZE / 2;

            const zoneElement = document.createElement('div');
            zoneElement.className = 'zone';
            zoneElement.style.left = `${x}px`;
            zoneElement.style.top = `${y}px`;
            zoneElement.textContent = fingerNumber;    
            zonesContainer.appendChild(zoneElement);
            ZONES_ELEMENTS_BY_FINGER[fingerNumber] = zoneElement;
        });
    }

    function getFingerNumberForTouchPoint(touchClientX, touchClientY) {
        const screenCenterX = window.innerWidth / 2;
        const screenCenterY = window.innerHeight / 2;
        let angleRad = Math.atan2(screenCenterY - touchClientY, touchClientX - screenCenterX);
        let angleDeg = angleRad * (180 / Math.PI);
        if (angleDeg < 0) angleDeg += 360; 

        if (angleDeg >= fieldAngleRanges.finger_1_min && angleDeg <= fieldAngleRanges.finger_1_max) return '1';
        if (angleDeg >= fieldAngleRanges.finger_2_min && angleDeg <  fieldAngleRanges.finger_2_max) return '2';
        if (angleDeg >= fieldAngleRanges.finger_3_min && angleDeg <  fieldAngleRanges.finger_3_max) return '3';
        if (angleDeg >= fieldAngleRanges.finger_4_min && angleDeg <  fieldAngleRanges.finger_4_max) return '4';
        if (angleDeg <  fieldAngleRanges.finger_5_lower_max || angleDeg > fieldAngleRanges.finger_5_upper_min) return '5';
        return null; 
    }

    // Event Listeners
    document.body.addEventListener('touchstart', (e) => {
        if(e.target.id === 'start-btn') return;
        e.preventDefault(); 
        for (let touch of e.changedTouches) {
            const fingerNumber = getFingerNumberForTouchPoint(touch.clientX, touch.clientY);
            if (fingerNumber) {
                const btn = ZONES_ELEMENTS_BY_FINGER[fingerNumber];
                if (btn) btn.classList.add('active');
                fingersInCurrentPotentialChord.add(fingerNumber); 
                touchesCurrentlyDown.add(touch.identifier);
                if (btn) activeTouchEventToButtonElement.set(touch.identifier, btn);
            }
        }
    }, { passive: false });

    document.body.addEventListener('touchend', (e) => {
        if(e.target.id === 'start-btn') return;
        e.preventDefault();
        
        for (let touch of e.changedTouches) {
            if (touchesCurrentlyDown.has(touch.identifier)) {
                const btn = activeTouchEventToButtonElement.get(touch.identifier);
                if (btn) btn.classList.remove('active'); // Simplification: remove immediately on lift for visual snap
                activeTouchEventToButtonElement.delete(touch.identifier);
                touchesCurrentlyDown.delete(touch.identifier);
            }
        }

        // Only commit chord if ALL fingers are lifted
        if (touchesCurrentlyDown.size === 0 && fingersInCurrentPotentialChord.size > 0) {
            const chord = [...fingersInCurrentPotentialChord].sort().join('');
            handleChordInput(chord);
            fingersInCurrentPotentialChord.clear();
            Object.values(ZONES_ELEMENTS_BY_FINGER).forEach(btn => btn.classList.remove('active'));
        }
    }, { passive: false });

    // Keyboard support (1-5)
    const keysDown = new Set();
    document.addEventListener('keydown', e => {
        if(['1','2','3','4','5'].includes(e.key) && !e.repeat) {
            keysDown.add(e.key);
            fingersInCurrentPotentialChord.add(e.key);
            ZONES_ELEMENTS_BY_FINGER[e.key].classList.add('active');
        }
    });
    document.addEventListener('keyup', e => {
        if(['1','2','3','4','5'].includes(e.key)) {
            keysDown.delete(e.key);
            ZONES_ELEMENTS_BY_FINGER[e.key].classList.remove('active');
            if(keysDown.size === 0 && fingersInCurrentPotentialChord.size > 0) {
                const chord = [...fingersInCurrentPotentialChord].sort().join('');
                handleChordInput(chord);
                fingersInCurrentPotentialChord.clear();
            }
        }
    });

  </script>
</body>
</html>
