<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <!-- iOS Add to Home Screen meta -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Jagger">
  <link rel="apple-touch-icon" href="data:image/png;base64,ICON_PLACEHOLDER">
  <title>Jagger — Standalone Offline Audio</title>
  <meta name="theme-color" content="#ADD8E6">
  <style>
    :root{
      --brand:#ADD8E6; --text:#0f172a; --muted:#f1f5f9; --border:#e2e8f0;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:-apple-system,system-ui,Segoe UI,Roboto,Helvetica,Arial; color:var(--text);}
    header{position:sticky;top:0;background:linear-gradient(180deg,#fff,rgba(255,255,255,.85));backdrop-filter:blur(8px);border-bottom:1px solid var(--border)}
    .container{max-width:880px;margin:0 auto;padding:20px}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:28px;height:28px;border-radius:8px;background:#ADD8E6;display:inline-block;position:relative;overflow:hidden}
    .logo:after{content:"";position:absolute;left:9px;top:6px;border-left:12px solid #fff;border-top:8px solid transparent;border-bottom:8px solid transparent}
    h1{font-size:18px;margin:0}
    .card{border:1px solid var(--border);border-radius:16px;padding:16px;margin-top:14px;box-shadow:0 10px 24px rgba(0,0,0,.05)}
    .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    button, label.button{appearance:none;border:none;background:var(--brand);color:#003b5c;padding:9px 13px;border-radius:12px;font-weight:700;box-shadow:0 6px 18px rgba(173,216,230,.5);}
    button.secondary{background:#e2e8f0;color:#0f172a;box-shadow:none}
    #fileInput{display:none}
    .small{font-size:12px;color:#64748b}
    .drag{border:2px dashed #94a3b8;border-radius:14px;padding:22px;text-align:center;background:var(--muted);color:#475569}
    .drag.dragover{border-color:#0ea5e9;background:#e0f2fe;color:#0369a1}
    .hint{background:#fff7ed;border:1px dashed #fdba74;color:#9a3412;padding:12px;border-radius:12px;margin-top:10px}
    audio{width:100%;margin-top:8px}
    ul{list-style:none;margin:0;padding:0}
    .track{display:flex;justify-content:space-between;align-items:center;gap:12px;border:1px solid var(--border);border-radius:12px;padding:10px 12px;margin:10px 0}
    .track-title{font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:60vw}
    .track-meta{font-size:12px;color:#475569}
    footer{text-align:center;color:#64748b;font-size:12px;padding:30px}
  </style>
</head>
<body>
  <header>
    <div class="container">
      <div class="brand">
        <span class="logo" aria-hidden="true"></span>
        <h1>Jagger — Offline Audio (Single File)</h1>
      </div>
    </div>
  </header>

  <main class="container">
    <div class="card">
      <div class="controls">
        <label for="fileInput" class="button">Upload audio</label>
        <button id="clearAll" class="secondary">Clear all</button>
        <span class="small">Files stay on this device (IndexedDB).</span>
      </div>
      <div id="drop" class="drag" style="margin-top:12px;">
        Drag & drop audio files here (MP3, M4A, WAV, OGG, etc.)
      </div>
      <div id="a2hs" class="hint" hidden>
        iPhone tip: Open in Safari → Share → <b>Add to Home Screen</b>. Open from Home Screen for the best offline experience.
      </div>
      <div id="persistHint" class="hint" hidden>
        Storage: we requested persistent space so your tracks aren't auto-cleared. Keep free space on your device.
      </div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 8px 0;">Now Playing</h3>
      <audio id="player" controls preload="metadata" playsinline></audio>
    </div>

    <div class="card">
      <h3 style="margin:0 0 8px 0;">Your Library</h3>
      <ul id="playlist"></ul>
    </div>
  </main>

  <footer>Jagger • Single-file web app • Works offline</footer>

  <input id="fileInput" type="file" accept="audio/*" multiple />

  <!-- Inline service worker source (will be registered via Blob URL) -->
  <script id="sw-src" type="text/plain">
    const CACHE_NAME = 'jagger-onefile-v1';
    const APP_SHELL = ['.']; // cache this document
    self.addEventListener('install', (event) => {
      event.waitUntil(caches.open(CACHE_NAME).then((c) => c.addAll(APP_SHELL)));
      self.skipWaiting();
    });
    self.addEventListener('activate', (event) => {
      event.waitUntil(caches.keys().then(keys => Promise.all(keys.map(k => k !== CACHE_NAME && caches.delete(k)))));
      self.clients.claim();
    });
    self.addEventListener('fetch', (event) => {
      const url = new URL(event.request.url);
      if (url.origin === self.location.origin) {
        event.respondWith(
          caches.match(event.request).then((cached) => cached || fetch(event.request).then((resp) => {
            const copy = resp.clone();
            caches.open(CACHE_NAME).then(cache => cache.put(event.request, copy));
            return resp;
          }).catch(() => cached))
        );
      }
    });
  </script>

  <script>
    // --- Minimal IndexedDB helpers ---
    const dbName = 'jagger-audio-onefile';
    const storeName = 'tracks';
    let db, currentId = null;

    const $ = (s) => document.querySelector(s);
    const on = (el,ev,fn)=> el.addEventListener(ev,fn);
    const fmtBytes = (b)=>{
      if (b===0) return '0 B';
      const u=['B','KB','MB','GB']; let i=0;
      while (b>=1024 && i<u.length-1){b/=1024;i++;}
      return b.toFixed(i?1:0)+' '+u[i];
    };

    function openDB(){
      return new Promise((res,rej)=>{
        const r = indexedDB.open(dbName,1);
        r.onupgradeneeded = (e)=>{
          const db = e.target.result;
          const os = db.createObjectStore(storeName, { keyPath:'id', autoIncrement:true });
          os.createIndex('addedAt','addedAt',{unique:false});
        };
        r.onsuccess = ()=> res(r.result);
        r.onerror = ()=> rej(r.error);
      });
    }
    function idbAdd(t){
      return new Promise((res,rej)=>{
        const tx = db.transaction(storeName,'readwrite');
        tx.oncomplete = ()=> res(true);
        tx.onerror = ()=> rej(tx.error);
        tx.objectStore(storeName).add(t);
      });
    }
    function idbAll(){
      return new Promise((res,rej)=>{
        const tx = db.transaction(storeName,'readonly');
        const q = tx.objectStore(storeName).getAll();
        q.onsuccess = ()=> res(q.result||[]);
        q.onerror = ()=> rej(q.error);
      });
    }
    function idbGet(id){
      return new Promise((res,rej)=>{
        const tx = db.transaction(storeName,'readonly');
        const q = tx.objectStore(storeName).get(Number(id));
        q.onsuccess = ()=> res(q.result||null);
        q.onerror = ()=> rej(q.error);
      });
    }
    function idbDel(id){
      return new Promise((res,rej)=>{
        const tx = db.transaction(storeName,'readwrite');
        tx.oncomplete = ()=> res(true);
        tx.onerror = ()=> rej(tx.error);
        tx.objectStore(storeName).delete(Number(id));
      });
    }

    function render(list){
      const ul = $('#playlist');
      ul.innerHTML='';
      if (!list.length){
        ul.innerHTML = '<li class="small">No tracks yet. Use Upload or drag & drop.</li>';
        return;
      }
      for (const t of list.sort((a,b)=>b.addedAt-a.addedAt)){
        const li = document.createElement('li');
        li.className='track';
        li.innerHTML = `
          <div>
            <div class="track-title" title="${{t.name}}">${{t.name}}</div>
            <div class="track-meta">${{fmtBytes(t.size)}} • ${{t.type||'audio'}}</div>
          </div>
          <div>
            <button class="secondary play" data-id="${{t.id}}">Play</button>
            <button class="secondary del" data-id="${{t.id}}">Delete</button>
          </div>`;
        ul.appendChild(li);
      }
    }

    async function loadAndRender(){
      render(await idbAll());
    }

    async function handleFiles(files){
      const hint = $('#persistHint');
      for (const f of files){
        if (!f.type.startsWith('audio/')) continue;
        const buf = await f.arrayBuffer();
        const blob = new Blob([buf], {type: f.type || 'audio/mpeg'});
        await idbAdd({ name:f.name, size:f.size, type:f.type, addedAt:Date.now(), blob });
      }
      await loadAndRender();
      hint.hidden = false;
      if (navigator.storage && navigator.storage.persist) {
        try { await navigator.storage.persist(); } catch (e) {}
      }
    }

    function setupDnD(){
      const drop = $('#drop');
      ['dragenter','dragover'].forEach(evt => on(drop,evt,(e)=>{e.preventDefault(); drop.classList.add('dragover');}));
      ['dragleave','drop'].forEach(evt => on(drop,evt,(e)=>{e.preventDefault(); drop.classList.remove('dragover');}));
      on(drop,'drop', async (e)=>{ await handleFiles(e.dataTransfer.files); });
    }

    function playTrack(t){
      const audio = $('#player');
      const url = URL.createObjectURL(t.blob);
      audio.src = url;
      currentId = t.id;
      audio.play().catch(()=>{});
    }

    // Register SW from inline source via Blob URL (single-file trick)
    async function registerSW(){
      if (!('serviceWorker' in navigator)) return;
      try {
        const src = document.getElementById('sw-src').textContent;
        const blob = new Blob([src], { type: 'application/javascript' });
        const url = URL.createObjectURL(blob);
        await navigator.serviceWorker.register(url, { scope: './' });
      } catch (e) {
        console.warn('SW registration failed', e);
      }
    }

    async function boot(){
      // A2HS guidance for iPhone
      const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
      if (!isStandalone && /iphone|ipad|ipod/i.test(navigator.userAgent)) document.getElementById('a2hs').hidden = false;

      await registerSW();
      db = await openDB();
      await loadAndRender();
      setupDnD();

      document.getElementById('fileInput').addEventListener('change', async (e)=>{ await handleFiles(e.target.files); e.target.value=''; });
      document.getElementById('playlist').addEventListener('click', async (e)=>{
        const btn = e.target.closest('button'); if(!btn) return;
        const id = btn.dataset.id;
        if (btn.classList.contains('play')) { const t = await idbGet(id); if (t) playTrack(t); }
        if (btn.classList.contains('del'))  { await idbDel(id); if (Number(id)===currentId) { const a=document.getElementById('player'); a.pause(); a.removeAttribute('src'); a.load(); } await loadAndRender(); }
      });
      document.getElementById('clearAll').addEventListener('click', async ()=>{
        if (!confirm('Delete all tracks from this device?')) return;
        const tx = db.transaction(storeName,'readwrite'); tx.objectStore(storeName).clear();
        await loadAndRender(); const a=document.getElementById('player'); a.pause(); a.removeAttribute('src'); a.load();
      });
    }

    document.addEventListener('DOMContentLoaded', boot);
  </script>
</body>
</html>
