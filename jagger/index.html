
<!doctype html>
<html lang="en" class="h-full bg-[#f6fbff]">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Jagger — Audio</title>

  <!-- iOS PWA friendliness -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="Jagger" />
  <link rel="apple-touch-icon" href="/icons/icon-192.png" />
  <meta name="theme-color" content="#62b6ff" />

  <!-- Manifest & SW -->
  <link rel="manifest" href="/manifest.webmanifest" />
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js');
      });
    }
  </script>

  <!-- Tailwind CDN (keeps the project single‑file simple) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: {
              50: '#f0f8ff', 100: '#e0f1ff', 200: '#bfe2ff', 300: '#9ed3ff',
              400: '#7dc4ff', 500: '#62b6ff', 600: '#3ea3ff', 700: '#1f8def',
              800: '#1971c2', 900: '#145a9a'
            }
          }
        }
      }
    }
  </script>

  <style>
    /* Subtle frosted player bar */
    .glass { backdrop-filter: saturate(120%) blur(12px); }
    .scroll-thin::-webkit-scrollbar { height: 6px; width: 6px; }
    .scroll-thin::-webkit-scrollbar-thumb { background: #cfe6ff; border-radius: 9999px; }
  </style>
</head>
<body class="h-full text-slate-800">
  <div id="dropzone" class="fixed inset-0 hidden items-center justify-center bg-brand-500/20 z-[60]">
    <div class="rounded-2xl bg-white p-8 shadow-xl border border-brand-200 text-center">
      <p class="text-xl font-semibold text-brand-800">Drop audio files to import</p>
      <p class="text-slate-500 mt-1">MP3 / M4A work best on iPhone</p>
    </div>
  </div>

  <div class="mx-auto max-w-6xl min-h-full grid grid-rows-[auto,1fr,auto] gap-4 p-4 pb-28">
    <!-- Top bar -->
    <header class="rounded-2xl bg-white/80 glass border border-brand-100 px-4 py-3 flex items-center justify-between shadow-sm">
      <div class="flex items-center gap-3">
        <div class="h-9 w-9 rounded-xl bg-brand-500 grid place-content-center text-white font-bold">J</div>
        <h1 class="text-lg font-semibold">Jagger</h1>
      </div>
      <div class="flex items-center gap-2">
        <label class="relative">
          <input id="search" type="search" placeholder="Search library…" class="w-56 md:w-72 rounded-xl border border-brand-100 bg-brand-50/60 px-3 py-2 pr-9 outline-none focus:ring-2 focus:ring-brand-300" />
          <svg class="w-4 h-4 absolute right-3 top-1/2 -translate-y-1/2 text-brand-700" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
        </label>
        <button id="btn-import" class="rounded-xl bg-brand-600 text-white px-3 py-2 font-medium hover:bg-brand-700 active:bg-brand-800">Import</button>
        <input id="file" type="file" accept="audio/*" multiple class="hidden" />
      </div>
    </header>

    <!-- Main layout -->
    <main class="grid grid-cols-1 md:grid-cols-[240px,1fr] gap-4">
      <!-- Sidebar -->
      <aside class="rounded-2xl bg-white border border-brand-100 p-3 space-y-3 h-fit md:h-[calc(100vh-12rem)] overflow-auto scroll-thin">
        <section>
          <h2 class="text-sm font-semibold text-brand-800 mb-2">Playlists</h2>
          <ul id="playlists" class="space-y-1 text-sm">
            <!-- dynamic -->
          </ul>
          <button id="new-playlist" class="mt-2 w-full rounded-xl border border-brand-200 px-3 py-2 hover:bg-brand-50">+ New playlist</button>
        </section>
        <hr class="border-brand-100"/>
        <section class="text-xs text-slate-500 leading-relaxed">
          <p class="mb-1">Tip: Tap **Import** to add songs. Jagger works offline after first load.</p>
          <p>Files are stored locally on your device. You can clear them in Settings.</p>
          <button id="btn-settings" class="mt-3 w-full rounded-xl border border-brand-200 px-3 py-2 hover:bg-brand-50 text-sm">Settings</button>
        </section>
      </aside>

      <!-- Library -->
      <section class="rounded-2xl bg-white border border-brand-100 p-0 overflow-hidden">
        <div class="p-3 flex items-center justify-between">
          <h2 class="text-base font-semibold">Library</h2>
          <div class="flex items-center gap-2 text-sm">
            <button id="btn-shuffle-all" class="rounded-lg border border-brand-200 px-3 py-1.5 hover:bg-brand-50">Shuffle all</button>
            <button id="btn-clear-library" class="rounded-lg border border-rose-200 text-rose-600 px-3 py-1.5 hover:bg-rose-50">Clear library</button>
          </div>
        </div>
        <div id="library" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3 p-3">
          <!-- Cards injected here -->
        </div>
      </section>
    </main>

    <!-- Player Bar -->
    <footer class="fixed left-0 right-0 bottom-0 z-50">
      <div class="mx-auto max-w-6xl m-4 rounded-2xl glass bg-white/80 border border-brand-100 shadow-lg">
        <div class="flex items-center gap-4 px-4 py-3">
          <img id="art" class="h-12 w-12 rounded-xl object-cover bg-brand-100 border border-brand-200" alt="artwork" />
          <div class="min-w-0 flex-1">
            <div class="truncate font-medium" id="now-title">Not playing</div>
            <div class="truncate text-sm text-slate-500" id="now-artist">—</div>
            <input id="seek" type="range" min="0" max="100" value="0" class="w-full accent-brand-600" />
            <div class="flex justify-between text-[11px] text-slate-500 -mt-1">
              <span id="tcur">0:00</span>
              <span id="tdur">0:00</span>
            </div>
          </div>
          <div class="flex items-center gap-3">
            <button id="prev" class="p-2 rounded-xl hover:bg-brand-50" aria-label="Previous">
              <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 20L9 12l10-8v16z"/><path d="M5 19V5"/></svg>
            </button>
            <button id="play" class="p-3 rounded-2xl bg-brand-600 text-white hover:bg-brand-700 active:bg-brand-800" aria-label="Play/Pause">
              <svg id="play-icon" class="w-6 h-6" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
            </button>
            <button id="next" class="p-2 rounded-xl hover:bg-brand-50" aria-label="Next">
              <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 4l10 8-10 8V4z"/><path d="M19 5v14"/></svg>
            </button>
            <button id="btn-shuffle" class="p-2 rounded-xl hover:bg-brand-50" aria-label="Shuffle">
              <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 20l3-3-3-3"/><path d="M3 7h5l4 5 4 5h5"/><path d="M18 4l3 3-3 3"/><path d="M3 17h5"/></svg>
            </button>
            <button id="btn-repeat" class="p-2 rounded-xl hover:bg-brand-50" aria-label="Repeat">
              <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12a7 7 0 0 1 12-4h-1"/><path d="M21 12a7 7 0 0 1-12 4h1"/><path d="M13 5l-2-2 2-2"/><path d="M11 21l2 2-2 2"/></svg>
            </button>
          </div>
        </div>
      </div>
    </footer>

    <input id="hidden-audio" type="audio" playsinline class="hidden" />
  </div>

  <script type="module">
    import { idbOpen, idbPutMany, idbGetAll, idbDeleteAll } from './jagger-idb.js';

    const $ = (s)=>document.querySelector(s);
    const $$ = (s)=>document.querySelectorAll(s);

    const audio = $('#hidden-audio');
    const art = $('#art');
    const nowTitle = $('#now-title');
    const nowArtist = $('#now-artist');
    const tcur = $('#tcur');
    const tdur = $('#tdur');
    const seek = $('#seek');

    const btnImport = $('#btn-import');
    const fileInput = $('#file');
    const btnShuffleAll = $('#btn-shuffle-all');
    const btnClearLib = $('#btn-clear-library');
    const libraryEl = $('#library');
    const searchEl = $('#search');
    const dropzone = $('#dropzone');

    const prevBtn = $('#prev');
    const playBtn = $('#play');
    const playIcon = $('#play-icon');
    const nextBtn = $('#next');
    const shuffleBtn = $('#btn-shuffle');
    const repeatBtn = $('#btn-repeat');

    let DB, LIB = [], QUEUE = [], INDEX = -1, SHUFFLE=false, REPEAT='none'; // none|one|all

    // ---------- Helpers ----------
    const fmt = s=> {
      if (!Number.isFinite(s)) return '0:00';
      const m = Math.floor(s/60), ss = Math.floor(s%60).toString().padStart(2,'0');
      return `${m}:${ss}`;
    };

    async function loadLibrary() {
      DB = await idbOpen('jagger', 1);
      LIB = await idbGetAll(DB, 'tracks');
      renderLibrary();
    }

    function renderLibrary(filter='') {
      libraryEl.innerHTML = '';
      const q = filter.trim().toLowerCase();
      const rows = (q ? LIB.filter(t => (t.title+t.artist).toLowerCase().includes(q)) : LIB);
      for (const t of rows) {
        const card = document.createElement('button');
        card.className = 'group text-left p-3 rounded-xl border border-brand-100 hover:border-brand-300 hover:bg-brand-50/50 transition';
        card.innerHTML = `
          <div class="aspect-square w-full rounded-lg bg-brand-100 border border-brand-200 overflow-hidden">
            ${t.artwork ? `<img src="${t.artwork}" class="w-full h-full object-cover">` : ''}
          </div>
          <div class="mt-2 truncate font-medium">${t.title || 'Untitled'}</div>
          <div class="truncate text-sm text-slate-500">${t.artist || 'Unknown'}</div>`;
        card.onclick = ()=> playFromLibrary(t.id);
        libraryEl.appendChild(card);
      }
    }

    function setNowPlaying(meta) {
      nowTitle.textContent = meta.title || 'Unknown title';
      nowArtist.textContent = meta.artist || 'Unknown artist';
      if (meta.artwork) art.src = meta.artwork; else art.removeAttribute('src');
      if ('mediaSession' in navigator) {
        try {
          navigator.mediaSession.metadata = new MediaMetadata({
            title: meta.title || 'Unknown',
            artist: meta.artist || 'Unknown',
            album: meta.album || 'Jagger',
            artwork: meta.artwork ? [{ src: meta.artwork, sizes: '512x512', type: 'image/png' }] : []
          });
        } catch {}
      }
    }

    function updatePlayIcon() {
      playIcon.innerHTML = audio.paused
        ? '<path d="M8 5v14l11-7z"/>'
        : '<path d="M6 4h4v16H6zM14 4h4v16h-4z"/>'
    }

    function buildQueueFromLib(startId) {
      const base = [...LIB];
      if (SHUFFLE) base.sort(()=>Math.random()-0.5);
      INDEX = base.findIndex(t=>t.id===startId);
      QUEUE = base;
    }

    async function playFromLibrary(id) {
      buildQueueFromLib(id);
      await playAt(INDEX);
    }

    async function playAt(i) {
      if (i<0 || i>=QUEUE.length) return;
      INDEX = i;
      const tr = QUEUE[INDEX];
      audio.src = tr.blobUrl || tr.url; // blobUrl for stored IndexedDB blobs
      await audio.play();
      setNowPlaying(tr);
      updatePlayIcon();
    }

    function nextTrack() {
      if (REPEAT==='one') return playAt(INDEX);
      let i = INDEX + 1;
      if (i>=QUEUE.length) {
        if (REPEAT==='all') i = 0; else return audio.pause();
      }
      playAt(i);
    }

    function prevTrack() {
      let i = INDEX - 1;
      if (i<0) i = 0;
      playAt(i);
    }

    // ---------- Events ----------
    audio.addEventListener('timeupdate', ()=>{
      seek.max = Math.max(1, Math.floor(audio.duration||0));
      seek.value = Math.floor(audio.currentTime||0);
      tcur.textContent = fmt(audio.currentTime);
      tdur.textContent = fmt(audio.duration);
    });
    audio.addEventListener('ended', nextTrack);
    seek.addEventListener('input', ()=>{ audio.currentTime = Number(seek.value)||0; });

    playBtn.onclick = ()=> { audio.paused ? audio.play() : audio.pause(); };
    audio.addEventListener('play', updatePlayIcon);
    audio.addEventListener('pause', updatePlayIcon);
    nextBtn.onclick = nextTrack;
    prevBtn.onclick = prevTrack;

    shuffleBtn.onclick = ()=>{ SHUFFLE = !SHUFFLE; shuffleBtn.classList.toggle('bg-brand-50', SHUFFLE); };
    repeatBtn.onclick = ()=>{
      REPEAT = (REPEAT==='none') ? 'one' : (REPEAT==='one' ? 'all' : 'none');
      repeatBtn.classList.toggle('bg-brand-50', REPEAT!=='none');
      repeatBtn.title = `Repeat: ${REPEAT}`;
    };

    // Media Session actions (Lock screen / Control Center)
    if ('mediaSession' in navigator) {
      try {
        navigator.mediaSession.setActionHandler('play', ()=> audio.play());
        navigator.mediaSession.setActionHandler('pause', ()=> audio.pause());
        navigator.mediaSession.setActionHandler('previoustrack', prevTrack);
        navigator.mediaSession.setActionHandler('nexttrack', nextTrack);
        navigator.mediaSession.setActionHandler('seekto', e=>{ if (e.seekTime!=null) audio.currentTime = e.seekTime; });
      } catch {}
    }

    // Import (button + input)
    btnImport.onclick = ()=> fileInput.click();
    fileInput.onchange = async (e)=> handleFiles(e.target.files);

    // Drag‑and‑drop overlay
    ;['dragenter','dragover'].forEach(ev=>document.addEventListener(ev, e=>{ e.preventDefault(); dropzone.classList.remove('hidden'); dropzone.classList.add('flex'); }, false));
    ;['dragleave','drop'].forEach(ev=>document.addEventListener(ev, e=>{ e.preventDefault(); dropzone.classList.add('hidden'); dropzone.classList.remove('flex'); }, false));
    document.addEventListener('drop', e=>{ handleFiles(e.dataTransfer.files); });

    // Search
    searchEl.addEventListener('input', ()=> renderLibrary(searchEl.value));

    // Clear library
    btnClearLib.onclick = async ()=>{
      if (!confirm('Remove all imported songs from this device?')) return;
      await idbDeleteAll(DB, 'tracks');
      LIB = [];
      renderLibrary();
      audio.pause(); audio.src=''; INDEX=-1; QUEUE=[];
    };

    // Shuffle all
    btnShuffleAll.onclick = ()=>{
      if (!LIB.length) return;
      SHUFFLE = true; buildQueueFromLib(LIB[0].id); playAt(0);
    };

    // File handling → read metadata (basic), artwork (if any), store blob
    async function handleFiles(fileList) {
      const arr = Array.from(fileList || []);
      const rows = [];
      for (const f of arr) {
        if (!f.type.startsWith('audio/')) continue;
        const blobUrl = URL.createObjectURL(f);
        const title = f.name.replace(/\.[^.]+$/, '');
        const track = {
          id: crypto.randomUUID(),
          title, artist: 'Unknown', album: 'Jagger',
          artwork: '',
          size: f.size, type: f.type, blob: f, blobUrl
        };
        rows.push(track);
      }
      await idbPutMany(DB, 'tracks', rows);
      // Refresh LIB to get persistent Blob URLs
      LIB = await idbGetAll(DB, 'tracks');
      // Recreate blob URLs
      for (const t of LIB) t.blobUrl = URL.createObjectURL(t.blob);
      renderLibrary(searchEl.value);
    }

    // Request persistent storage when available (helps on iOS/iPadOS)
    if (navigator.storage && navigator.storage.persist) {
      try { await navigator.storage.persist(); } catch {}
    }

    // Kick off
    loadLibrary();
  </script>

  <!-- Simple IndexedDB helper as an ES module (in a separate file) -->
  <script type="module" src="/jagger-idb.js"></script>
</body>
</html>
