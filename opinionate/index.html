<!DOCTYPE html>
<html lang="en">
<head>
  <!--
    KAFFETISH – Bold Profile/Signup (Desktop + Mobile)
    - Keeps your original Firebase logic & element IDs intact
    - Dramatic, creative UI with animated gradients, glass panels, and micro-interactions
    - Fully responsive, accessible, and dark-mode aware
  -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Profile | Kaffetish</title>

  <!-- Fonts / Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,500;0,700;1,400&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>

  <style>
    :root{
      --bg:#0f0e0f;
      --ink:#191817;
      --ink-contrast:#0e0d0d;
      --paper:#ffffff;
      --muted:#8b8a88;
      --brand:#ff3a44;
      --brand-2:#6b6bff;
      --brand-3:#00d1b2;
      --glass: rgba(255,255,255,.06);
      --stroke: rgba(255,255,255,.14);
      --shadow: 0 10px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.06);
      --radius-xl: 22px;
      --radius-lg: 16px;
      --radius-md: 12px;
      --radius-sm: 10px;
      --font-ui:'Poppins', system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji", "Segoe UI Symbol";
      --font-display:'Lora', serif;
      --focus-ring: 0 0 0 3px rgba(255,58,68,.25), 0 0 0 1px rgba(255,58,68,.6);
      --ok:#35d399;
      --warn:#ffd166;
    }
    body.dark-mode{
      --bg:#0a0a0b;
      --ink:#f1f0ee;
      --ink-contrast:#faf9f7;
      --paper:#121214;
      --muted:#a7a5a2;
      --glass: rgba(255,255,255,.07);
      --stroke: rgba(255,255,255,.16);
      --shadow: 0 14px 40px rgba(0,0,0,.55), inset 0 1px 0 rgba(255,255,255,.05);
    }

    /* Base */
    *,*::before,*::after{ box-sizing:border-box }
    html,body{ height:100% }
    body{
      margin:0;
      color:var(--ink);
      font-family:var(--font-ui);
      background: radial-gradient(1200px 1200px at 10% -10%, #351218 0%, transparent 55%),
                  radial-gradient(900px 900px at 120% 20%, #14163f 0%, transparent 45%),
                  radial-gradient(1200px 900px at 40% 120%, #003a33 0%, transparent 45%),
                  var(--bg);
      background-attachment: fixed;
      line-height:1.5;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    /* Subtle animated gradient veil */
    .veil{
      position:fixed; inset:0;
      pointer-events:none;
      background:
        conic-gradient(from 0deg at 50% 50%,
          rgba(255,58,68,.12), rgba(0,0,0,0) 18%,
          rgba(0,209,178,.11) 40%,
          rgba(0,0,0,0) 60%,
          rgba(107,107,255,.12) 82%,
          rgba(0,0,0,0) 100%);
      filter: blur(60px) saturate(1.2);
      opacity:.7;
      animation: swirl 18s linear infinite;
      z-index:0;
    }
    @keyframes swirl{
      to{ transform: rotate(360deg) }
    }
    @media (prefers-reduced-motion: reduce){
      .veil{ animation: none }
    }

    /* Header */
    .app-header{
      position:sticky; top:0; z-index:20;
      backdrop-filter: blur(10px);
      background: linear-gradient(to bottom, rgba(0,0,0,.35), rgba(0,0,0,0));
      border-bottom:1px solid var(--stroke);
    }
    .header-content{
      max-width:1200px; margin:0 auto; height:68px;
      display:flex; align-items:center; justify-content:space-between;
      padding:0 18px;
    }
    .logo{
      display:flex; align-items:center; gap:10px;
      font-family:var(--font-display);
      color:#fff; letter-spacing:.5px;
      font-size:1.35rem; text-decoration:none;
      text-shadow:0 1px 0 rgba(0,0,0,.3);
    }
    .logo .pill{
      display:inline-flex; align-items:center; justify-content:center;
      width:28px; height:28px; border-radius:8px;
      background: linear-gradient(135deg,var(--brand), #ff6f75 30%, #ffa6ab 100%);
      box-shadow: 0 6px 18px rgba(255,58,68,.35);
      color:white;
    }
    .header-actions{
      display:flex; gap:8px; align-items:center;
    }
    .icon-btn{
      display:inline-flex; align-items:center; justify-content:center;
      width:40px; height:40px; border-radius:10px;
      background:var(--glass);
      border:1px solid var(--stroke);
      color:#fff; cursor:pointer;
      transition: transform .15s ease, background .2s ease, border-color .2s ease;
      box-shadow: var(--shadow);
    }
    .icon-btn:hover{ transform: translateY(-2px); border-color: rgba(255,255,255,.35) }

    /* Layout */
    main{
      max-width:1200px; margin: clamp(12px,3vh,36px) auto;
      padding: 0 18px 60px;
      position:relative; z-index:1;
    }

    .stage{
      display:grid;
      grid-template-columns: 1.05fr .95fr;
      gap:22px;
    }
    @media (max-width: 980px){
      .stage{ grid-template-columns: 1fr; gap:18px }
    }

    /* Left: Statement / Hero */
    .panel-hero{
      position:relative;
      border-radius: var(--radius-xl);
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      box-shadow: var(--shadow);
      padding: clamp(18px, 4.2vw, 36px);
      overflow:hidden;
      min-height: 420px;
      display:flex; flex-direction:column; justify-content:space-between;
    }
    .k-badge{
      display:inline-flex; gap:8px; align-items:center;
      background: rgba(255,255,255,.08);
      color:#fff; border:1px solid var(--stroke);
      border-radius:999px; padding:8px 12px; font-size:.86rem; font-weight:600;
      backdrop-filter: blur(8px);
      width:max-content;
    }
    .headline{
      margin: clamp(6px,2vh,12px) 0 clamp(10px,2.2vh,16px);
      font-family:var(--font-display);
      color:#fff; letter-spacing:-.5px;
      font-size: clamp(30px, 5vw, 58px);
      line-height:1.03;
      text-wrap:balance;
    }
    .headline .accent{
      background: linear-gradient(90deg, #ffb3b6 0%, #ffffff 60%, #9fded3 100%);
      -webkit-background-clip:text; background-clip:text;
      color:transparent;
      text-shadow:none;
    }
    .lede{
      color:#e7e6e3; max-width:56ch;
      opacity:.9;
    }

    /* Floating cards (visual candy) */
    .float-deck{
      position:absolute; right:-40px; bottom:-40px;
      width: min(520px, 55%);
      aspect-ratio: 4/3;
      pointer-events:none;
      filter: drop-shadow(0 24px 40px rgba(0,0,0,.45));
    }
    .float-card{
      position:absolute; inset:auto;
      width:68%; height:56%;
      background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.03));
      border:1px solid var(--stroke);
      border-radius:18px;
      transform: rotate(-8deg) translate(12px, -10px);
      animation: bob 10s ease-in-out infinite;
      backdrop-filter: blur(6px);
    }
    .float-card:nth-child(2){
      width:72%; height:58%;
      left:12%; top:-6%;
      transform: rotate(7deg);
      animation-delay: -2s;
    }
    .float-card:nth-child(3){
      width:58%; height:48%;
      right:10%; bottom:2%;
      transform: rotate(2deg);
      animation-delay: -5s;
    }
    @keyframes bob{
      0%,100%{ transform: translateY(0) rotate(var(--r,0deg)) }
      50%{ transform: translateY(-8px) rotate(calc(var(--r,0deg) + .6deg)) }
    }
    @media (max-width:980px){ .float-deck{ display:none } }

    /* Right: Interactive area (Signup/Profile) */
    .panel-glass{
      border-radius: var(--radius-xl);
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.035));
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panel-body{
      padding: clamp(16px, 4.2vw, 36px);
    }

    /* Tabs illusion: we keep your views and just switch visibility */
    .tab-title{
      display:flex; align-items:center; gap:10px;
      color:#fff; font-weight:700; letter-spacing:.3px; font-size:1.05rem;
      margin-bottom: 4px;
    }
    .tab-sub{
      color:#e8e6e3; opacity:.86; margin-bottom: 22px;
      font-size:.98rem;
    }

    /* Forms */
    .form-grid{ display:grid; grid-template-columns:1fr 1fr; gap:16px }
    .form-group{ display:flex; flex-direction:column; gap:8px }
    .form-group.full-width{ grid-column: 1 / -1 }
    label{ color:#e9e7e4; font-weight:600; font-size:.92rem }
    .field{
      display:flex; align-items:center; gap:10px;
      background: rgba(255,255,255,.06);
      border:1px solid var(--stroke);
      padding:12px 14px; border-radius: var(--radius-md);
      color:#fff;
      transition: border-color .2s ease, box-shadow .2s ease, transform .05s ease;
    }
    .field:focus-within{
      border-color: rgba(255,58,68,.55);
      box-shadow: var(--focus-ring);
    }
    .field input, .field select{
      all:unset; color:#fff; flex:1; min-width:0; font-size:1rem;
    }
    .hint{ color:#cfcfcb; font-size:.82rem }

    .btn{
      --btn-bg: linear-gradient(135deg, var(--brand), #ff7a82);
      --btn-bd: rgba(255,255,255,.22);
      display:inline-flex; align-items:center; justify-content:center; gap:10px;
      padding:14px 16px; width:100%;
      border-radius: 14px; border:1px solid var(--btn-bd);
      color:#fff; font-weight:800; letter-spacing:.3px; text-transform:uppercase; font-size:.92rem;
      background: var(--btn-bg);
      box-shadow: 0 10px 22px rgba(255,58,68,.35), inset 0 1px 0 rgba(255,255,255,.25);
      cursor:pointer; transition: transform .15s ease, filter .2s ease;
    }
    .btn:hover{ transform: translateY(-2px) }
    .btn:disabled{ filter:grayscale(.5) brightness(.8); cursor:not-allowed }
    .btn.secondary{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid var(--stroke); text-transform:none; font-weight:700;
      box-shadow: var(--shadow);
    }

    .spinner{ width:1.15em; height:1.15em; border-radius:50%;
      border:2px solid rgba(255,255,255,.35); border-top-color:#fff;
      animation: spin .7s linear infinite; }
    @keyframes spin{ to{ transform: rotate(360deg) } }

    .message-box{
      display:none; margin-top:14px; padding:12px 14px;
      border-radius:12px; font-size:.92rem; font-weight:600;
      border:1px solid var(--stroke); color:#111;
    }
    .message-box.success{
      background: rgba(53,211,153,.15); border-color: rgba(53,211,153,.45); color:#dff7ee;
    }
    .message-box.error{
      background: rgba(255,58,68,.18); border-color: rgba(255,58,68,.5); color:#ffeef0;
    }
    .message-box.warning{
      background: rgba(255,209,102,.16); border-color: rgba(255,209,102,.5); color:#fff6e1;
    }

    /* Profile grid */
    .profile-info-grid{
      display:grid; grid-template-columns: 120px 1fr; gap: 10px 18px; align-items:center;
      background: rgba(255,255,255,.04);
      border:1px solid var(--stroke);
      border-radius: 16px;
      padding:16px;
    }
    .profile-info-grid dt{
      color:#cfcfcb; font-weight:700; text-align:right;
    }
    .profile-info-grid dd{
      color:#fff; margin:0; font-weight:600; word-break:break-word;
    }
    .status-verified{ color: var(--ok) }
    .status-unverified{ color: var(--warn) }
    .status-unverified .resend-btn{
      background:none; border:none; color:#fff; text-decoration:underline; cursor:pointer; margin-left:8px;
      font-weight:700;
    }

    /* Views (ids kept) */
    .view{ display:block }
    .view.hidden{ display:none }

    /* Loading view */
    #loading-view{
      display:flex; align-items:center; justify-content:center;
      min-height: 220px;
    }
    .loading-card{
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
      border:1px solid var(--stroke); border-radius: 16px; padding:18px 20px;
      color:#eae9e6; box-shadow: var(--shadow);
      display:flex; align-items:center; gap:12px;
    }

    /* Mobile tweaks */
    @media (max-width: 980px){
      .panel-hero{ min-height: 260px }
      .headline{ font-size: clamp(28px, 9vw, 44px) }
      .form-grid{ grid-template-columns: 1fr }
      .profile-info-grid{ grid-template-columns: 1fr; }
      .profile-info-grid dt{ text-align:left }
    }

    /* Selection */
    ::selection{ background: #ff5164; color:#fff }

    /* Accessibility focus */
    :focus-visible{
      outline: none; box-shadow: var(--focus-ring);
    }
  </style>
</head>
<body>
  <div class="veil" aria-hidden="true"></div>

  <!-- Header -->
  <header class="app-header">
    <div class="header-content">
      <a class="logo" href="/" aria-label="Kaffetish Home">
        <span class="pill"><i class="fa-solid fa-mug-hot"></i></span>
        <span>Kaffetish</span>
      </a>
      <div class="header-actions">
        <button id="mode-toggle" class="icon-btn" title="Toggle theme" aria-label="Toggle theme">
          <i class="fa-solid fa-moon"></i>
        </button>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main>
    <div class="stage">
      <!-- Statement / Hero -->
      <section class="panel-hero" aria-label="Why to create an account">
        <span class="k-badge"><i class="fa-regular fa-bookmark"></i> Keep Your Mind Palace</span>
        <h1 class="headline">
          Save highlights. <span class="accent">Own your reading.</span> Sync everywhere.
        </h1>
        <p class="lede">
          Build a personal library of quotes, notes, and moments of clarity. Your reading trail stays with you across devices—private, portable, and beautifully organized.
        </p>

        <!-- floating cards -->
        <div class="float-deck" aria-hidden="true">
          <div class="float-card" style="--r:-8deg"></div>
          <div class="float-card" style="--r:7deg"></div>
          <div class="float-card" style="--r:2deg"></div>
        </div>
      </section>

      <!-- Interactive Panel -->
      <section class="panel-glass">
        <!-- SIGNUP VIEW -->
        <div id="signup-view" class="view hidden">
          <div class="panel-body" role="region" aria-labelledby="signup-title">
            <div class="tab-title" id="signup-title">
              <i class="fa-solid fa-user-plus"></i> Create your account
            </div>
            <div class="tab-sub">Takes less than a minute. Anonymous session will be linked securely.</div>

            <form id="signup-form" novalidate>
              <div class="form-grid">
                <div class="form-group">
                  <label for="firstName">First name</label>
                  <div class="field">
                    <i class="fa-regular fa-user"></i>
                    <input id="firstName" name="firstName" type="text" autocomplete="given-name" required placeholder="Ada" />
                  </div>
                </div>

                <div class="form-group">
                  <label for="lastName">Last name</label>
                  <div class="field">
                    <i class="fa-regular fa-id-card"></i>
                    <input id="lastName" name="lastName" type="text" autocomplete="family-name" required placeholder="Lovelace" />
                  </div>
                </div>

                <div class="form-group full-width">
                  <label for="country">Country</label>
                  <div class="field">
                    <i class="fa-solid fa-earth-europe"></i>
                    <select id="country" name="country" required aria-describedby="country-hint"></select>
                  </div>
                  <div id="country-hint" class="hint">Used to personalize content—never shared.</div>
                </div>

                <div class="form-group full-width">
                  <label for="email">Email address</label>
                  <div class="field">
                    <i class="fa-regular fa-envelope"></i>
                    <input id="email" name="email" type="email" required autocomplete="email" placeholder="you@domain.com" />
                  </div>
                </div>

                <div class="form-group full-width">
                  <label for="password">Password</label>
                  <div class="field">
                    <i class="fa-solid fa-key"></i>
                    <input id="password" name="password" type="password" minlength="6" required autocomplete="new-password" placeholder="Min. 6 characters" />
                  </div>
                </div>
              </div>

              <button id="submit-button" type="submit" class="btn" style="margin-top: 10px">
                <span id="button-text">Create My Account</span>
                <div id="button-spinner" class="spinner" style="display:none"></div>
              </button>
            </form>

            <div id="signup-message-box" class="message-box" aria-live="polite"></div>
          </div>
        </div>

        <!-- PROFILE VIEW -->
        <div id="profile-view" class="view hidden">
          <div class="panel-body" role="region" aria-labelledby="profile-title">
            <div class="tab-title" id="profile-title">
              <i class="fa-solid fa-circle-user"></i> Your profile
            </div>
            <div class="tab-sub">Manage account details or log out anytime.</div>

            <dl class="profile-info-grid" style="margin-bottom:16px">
              <dt>Name</dt><dd id="profile-name">…</dd>
              <dt>Country</dt><dd id="profile-country">…</dd>
              <dt>Email</dt><dd id="profile-email">…</dd>
              <dt>Status</dt><dd id="profile-status">…</dd>
            </dl>

            <div id="profile-message-box" class="message-box" aria-live="polite"></div>

            <button id="logout-button" class="btn secondary" style="margin-top:14px">
              <i class="fa-solid fa-right-from-bracket"></i> Log Out
            </button>
          </div>
        </div>

        <!-- LOADING VIEW -->
        <div id="loading-view" class="view hidden">
          <div class="panel-body">
            <div class="loading-card">
              <div class="spinner" aria-hidden="true"></div>
              <div>Loading profile…</div>
            </div>
          </div>
        </div>
      </section>
    </div>
  </main>

  <!-- Firebase + App -->
  <script type="module">
    // Firebase imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signInAnonymously,
      linkWithCredential,
      EmailAuthProvider,
      updateProfile,
      sendEmailVerification,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import {
      getFirestore,
      doc,
      setDoc,
      getDoc
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    // Paste your actual configuration from the Firebase console here
    const firebaseConfig = {
      apiKey: "AIzaSyAbnPpcIt88B0jIAoLUdC71zmQDvR_fdu8",
      authDomain: "physmathacademy-722b3.firebaseapp.com",
      projectId: "physmathacademy-722b3",
      storageBucket: "physmathacademy-722b3.appspot.com",
      messagingSenderId: "1093640992262",
      appId: "1:1093640992262:web:35b1bf4d2364bcf745f587"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    // --- DOM Cache ---
    const DOM = {
      body: document.body,
      modeToggle: document.getElementById("mode-toggle"),

      signupView: document.getElementById("signup-view"),
      profileView: document.getElementById("profile-view"),
      loadingView: document.getElementById("loading-view"),

      signupForm: document.getElementById("signup-form"),
      submitButton: document.getElementById("submit-button"),
      buttonText: document.getElementById("button-text"),
      buttonSpinner: document.getElementById("button-spinner"),

      signupMessageBox: document.getElementById("signup-message-box"),
      profileMessageBox: document.getElementById("profile-message-box"),

      logoutButton: document.getElementById("logout-button"),
      countrySelect: document.getElementById("country"),
    };

    // --- Helpers ---
    function showView(viewId){
      [DOM.signupView, DOM.profileView, DOM.loadingView].forEach(v=>{
        v.classList.toggle('hidden', v.id !== viewId);
      });
    }

    function setMode(mode){
      DOM.body.classList.toggle('dark-mode', mode === 'dark');
      DOM.modeToggle.querySelector('i').className = `fa-solid fa-${mode === 'light' ? 'moon' : 'sun'}`;
      localStorage.setItem('kaffetishMode', mode);
    }

    function showMessage(box, type, text){
      box.textContent = text;
      box.className = `message-box ${type}`;
      box.style.display = 'block';
    }

    function setLoadingState(isLoading){
      DOM.submitButton.disabled = isLoading;
      DOM.buttonText.style.display = isLoading ? 'none' : 'inline';
      DOM.buttonSpinner.style.display = isLoading ? 'inline-block' : 'none';
    }

    async function populateCountries(){
      try{
        const response = await fetch('https://restcountries.com/v3.1/all?fields=name');
        if(!response.ok) throw new Error('Failed to fetch countries');
        const countries = await response.json();
        const sorted = countries.map(c=>c.name.common).sort((a,b)=>a.localeCompare(b));

        const frag = document.createDocumentFragment();
        const placeholder = document.createElement('option');
        placeholder.value = "";
        placeholder.textContent = "Select your country";
        placeholder.disabled = true;
        placeholder.selected = true;
        frag.appendChild(placeholder);

        for(const name of sorted){
          const opt = document.createElement('option');
          opt.value = name; opt.textContent = name;
          frag.appendChild(opt);
        }
        DOM.countrySelect.innerHTML = "";
        DOM.countrySelect.appendChild(frag);
      }catch(err){
        console.error(err);
        DOM.countrySelect.innerHTML = '<option value="">Could not load countries</option>';
      }
    }

    // --- Handlers ---
    async function handleSignup(e){
      e.preventDefault();
      setLoadingState(true);
      DOM.signupMessageBox.style.display='none';

      const { firstName, lastName, country, email, password } = e.target.elements;
      const displayName = `${firstName.value.trim()} ${lastName.value.trim()}`.trim();

      try{
        const credential = EmailAuthProvider.credential(email.value, password.value);
        await linkWithCredential(auth.currentUser, credential);
        await updateProfile(auth.currentUser, { displayName });

        const ref = doc(db, "users", auth.currentUser.uid);
        await setDoc(ref, { displayName, email: email.value, country: country.value }, { merge:true });

        await sendEmailVerification(auth.currentUser);
        showMessage(DOM.signupMessageBox, 'success', 'Success! Check your inbox to verify your email.');
        e.target.reset();
      }catch(error){
        const messages = {
          'auth/email-already-in-use':'This email is already taken.',
          'auth/weak-password':'Password must be at least 6 characters.',
          'auth/invalid-email':'Please enter a valid email address.'
        };
        showMessage(DOM.signupMessageBox, 'error', messages[error.code] || 'An unexpected error occurred.');
      }finally{
        setLoadingState(false);
      }
    }

    async function handleResendVerification(){
      try{
        await sendEmailVerification(auth.currentUser);
        showMessage(DOM.profileMessageBox, 'success', 'Verification email sent!');
      }catch(err){
        showMessage(DOM.profileMessageBox, 'error', 'Failed to send email. Please try again.');
      }
    }

    async function renderProfile(user){
      document.getElementById('profile-name').textContent = user.displayName || 'Not set';
      document.getElementById('profile-email').textContent = user.email;

      try{
        const ref = doc(db, "users", user.uid);
        const snap = await getDoc(ref);
        if(snap.exists()){
          document.getElementById('profile-country').textContent = snap.data().country || 'Not set';
        }else{
          document.getElementById('profile-country').textContent = 'Not set';
        }
      }catch(err){
        console.error(err);
        document.getElementById('profile-country').textContent = 'Could not load';
      }

      const statusEl = document.getElementById('profile-status');
      DOM.profileMessageBox.style.display='none';

      if(user.emailVerified){
        statusEl.innerHTML = `<span class="status-verified"><i class="fa-solid fa-circle-check"></i> Verified</span>`;
      }else{
        statusEl.innerHTML = `<span class="status-unverified"><i class="fa-solid fa-circle-exclamation"></i> Unverified <button class="resend-btn" id="resend-verification">Resend Email</button></span>`;
        showMessage(DOM.profileMessageBox, 'warning', 'Please check your inbox (and spam folder) to verify your email.');
      }
    }

    // --- Init ---
    function init(){
      // Theme
      setMode(localStorage.getItem('kaffetishMode') || 'dark');

      // Populate country list
      populateCountries();

      // Events
      DOM.modeToggle.addEventListener('click', ()=>{
        setMode(DOM.body.classList.contains('dark-mode') ? 'light' : 'dark');
      });
      DOM.signupForm.addEventListener('submit', handleSignup);
      DOM.logoutButton.addEventListener('click', ()=>signOut(auth));
      DOM.profileView.addEventListener('click', (e)=>{
        if(e.target && e.target.id === 'resend-verification') handleResendVerification();
      });

      // Auth state
      onAuthStateChanged(auth, (user)=>{
        if(user){
          if(user.isAnonymous){
            showView('signup-view');
          }else{
            renderProfile(user);
            showView('profile-view');
          }
        }else{
          showView('loading-view');
          signInAnonymously(auth).catch(err=>{
            console.error('Anonymous sign-in failed:', err);
            showMessage(DOM.loadingView, 'error', 'Could not initialize session.');
          });
        }
      });
    }

    init();
  </script>
</body>
</html>
