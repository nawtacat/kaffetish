<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Profile | Kaffetish</title>
  <link rel="manifest" href="/manifest.json" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,500;0,700;1,400&family=Poppins:wght@400;500;600&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />

  <style>
    :root{
      --bg:#FDFBF7;
      --ink:#2C2B2A;
      --accent:#FF3A44;
      --subtle:#8A8886;
      --border-color:#EAE8E4;
      --shadow-color:rgba(44,43,42,.10);
      --font-main:'Lora', serif;
      --font-ui:'Poppins', sans-serif;
      --success:#28a745;
      --warning:#ffc107;
    }
    body.dark-mode{
      --bg:#21201F;
      --ink:#EAE8E4;
      --subtle:#999591;
      --border-color:#3A3837;
      --shadow-color:rgba(0,0,0,.25);
      --success:#3ddc63;
      --warning:#f3ca5c;
    }

    ::selection{ background-color:var(--accent); color:#fff; opacity:.9 }

    /* Base */
    *{ box-sizing:border-box; margin:0; padding:0 }
    html,body{ height:100% }
    body{
      font-family:var(--font-ui);
      background:var(--bg);
      color:var(--ink);
      transition: background-color .3s ease, color .3s ease;
      padding-top:60px;
    }

    /* Header (copied style language) */
    .app-header{
      position:fixed; inset:0 0 auto 0; height:60px; z-index:1000;
      background-color: color-mix(in srgb, var(--bg) 85%, transparent);
      backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
      border-bottom:1px solid var(--border-color);
      transition: background-color .3s ease, border-color .3s ease;
    }
    .header-content{
      max-width:1200px; height:100%; margin:0 auto; padding:0 24px;
      display:flex; align-items:center; justify-content:space-between;
    }
    .logo{
      display:flex; align-items:baseline;
      font-size:1.6rem; font-weight:500; letter-spacing:-.5px;
      color:var(--accent); font-family:var(--font-main);
      text-decoration:none;
    }
    .logo .tagline{
      font-size:.6em; font-style:italic; font-weight:400; color:var(--subtle);
      letter-spacing:normal; margin-left:8px;
    }
    body.dark-mode .logo{ color:var(--ink) }

    .header-actions{ display:flex; align-items:center; gap:16px }
    .header-actions button{
      background:transparent; border:none; color:var(--subtle); border-radius:6px;
      padding:8px 10px; cursor:pointer; font-size:1rem;
      transition: color .2s ease, background-color .2s ease;
    }
    .header-actions button:hover{
      color:var(--ink); background-color: color-mix(in srgb, var(--border-color) 60%, transparent);
    }

    /* Main container */
    main{ padding:48px 24px; max-width:1200px; margin:0 auto }

    /* Two-column card layout (desktop), stacked on mobile */
    .grid{
      display:grid; grid-template-columns: 1.1fr .9fr; gap:24px;
    }
    @media (max-width: 992px){
      main{ padding:24px 16px }
      .grid{ grid-template-columns: 1fr; gap:16px }
      .logo .tagline{ display:none }
    }

    /* Left panel: copy/benefits */
    .panel{
      border:1px solid var(--border-color);
      border-radius:16px;
      background-color: color-mix(in srgb, var(--border-color) 20%, transparent);
      box-shadow: 0 8px 20px var(--shadow-color);
    }
    .panel-body{ padding:28px }
    .panel h2{
      font-family:var(--font-main);
      font-size:2.2rem; font-weight:500;
      margin:0 0 8px 0;
      letter-spacing:-.3px;
    }
    .panel p.lede{
      color:var(--subtle); line-height:1.7; margin-top:8px; max-width:60ch;
    }
    .benefits{
      display:grid; grid-template-columns: 1fr 1fr; gap:14px 18px; margin-top:22px;
    }
    .benefit{
      display:flex; gap:10px; align-items:flex-start; color:var(--ink);
      font-size:.95rem;
    }
    .benefit i{ color:var(--accent); margin-top:2px }

    @media (max-width: 992px){
      .benefits{ grid-template-columns: 1fr }
    }

    /* Right panel: forms/profile */
    .card{
      border:1px solid var(--border-color);
      border-radius:16px;
      background:var(--bg);
      box-shadow: 0 8px 20px var(--shadow-color);
    }
    .card-header{
      padding:20px 24px; border-bottom:1px solid var(--border-color);
      display:flex; align-items:center; gap:10px; font-weight:600;
    }
    .card-body{ padding:24px }

    /* Form fields (consistent with search-input in library) */
    .form-grid{ display:grid; grid-template-columns: 1fr 1fr; gap:18px }
    .form-group{ display:flex; flex-direction:column; gap:8px }
    .form-group.full{ grid-column: 1 / -1 }
    label{ font-weight:500; font-size:.92rem }
    .field{
      position:relative;
    }
    .field input, .field select{
      width:100%; padding:12px 14px 12px 44px; font-size:1rem;
      font-family:var(--font-ui); border:1px solid var(--border-color);
      border-radius:12px; background-color:var(--bg); color:var(--ink);
      transition: border-color .2s, box-shadow .2s;
    }
    .field input:focus, .field select:focus{
      outline:none; border-color:var(--accent);
      box-shadow:0 0 0 3px color-mix(in srgb, var(--accent) 20%, transparent);
    }
    .field .fa{
      position:absolute; left:14px; top:50%; transform:translateY(-50%);
      color:var(--subtle);
    }
    .hint{ color:var(--subtle); font-size:.85rem }

    /* Buttons */
    .btn{
      width:100%; padding:14px 16px; border:none; border-radius:12px;
      font-size:1rem; font-weight:600; cursor:pointer;
      display:flex; align-items:center; justify-content:center; gap:10px;
      transition: transform .15s ease, background-color .2s ease;
    }
    .btn-primary{
      background:var(--accent); color:#fff;
      box-shadow: 0 8px 18px rgba(255,58,68,.25);
    }
    .btn-primary:hover:not(:disabled){
      transform: translateY(-2px);
      background-color: color-mix(in srgb, var(--accent) 85%, black);
    }
    .btn-primary:disabled{ filter: grayscale(.2) opacity(.8); cursor:not-allowed }
    .btn-secondary{
      background:transparent; color:var(--subtle);
      border:1px solid var(--border-color);
    }
    .btn-secondary:hover{ background-color: color-mix(in srgb, var(--border-color) 60%, transparent); color:var(--ink) }

    .spinner{
      width:1.15em; height:1.15em; border-radius:50%;
      border:2px solid rgba(255,255,255,.35); border-top-color:#fff;
      animation: spin .8s linear infinite;
    }
    @keyframes spin{ to{ transform: rotate(360deg) } }

    /* Messages */
    .message-box{
      display:none; margin-top:14px; padding:12px 14px; border-radius:12px; font-size:.92rem;
      border:1px solid color-mix(in srgb, var(--border-color) 70%, var(--accent));
    }
    .message-box.success{
      background-color: color-mix(in srgb, var(--success) 15%, transparent);
      color: color-mix(in srgb, var(--success) 90%, black);
      border-color: color-mix(in srgb, var(--success) 45%, transparent);
    }
    .message-box.error{
      background-color: color-mix(in srgb, var(--accent) 15%, transparent);
      color: color-mix(in srgb, var(--accent) 90%, black);
      border-color: color-mix(in srgb, var(--accent) 45%, transparent);
    }
    .message-box.warning{
      background-color: color-mix(in srgb, var(--warning) 25%, transparent);
      color: color-mix(in srgb, var(--warning) 95%, black);
      border-color: color-mix(in srgb, var(--warning) 45%, transparent);
    }

    /* Profile list */
    .profile-info-grid{
      display:grid; grid-template-columns: 120px 1fr; gap:8px 18px; align-items:center;
    }
    .profile-info-grid dt{ font-weight:500; color:var(--subtle); text-align:right }
    .profile-info-grid dd{ margin:0; font-weight:600; word-break:break-word }
    .status-verified{ color:var(--success) }
    .status-unverified{ color:var(--warning) }
    .status-unverified .resend-btn{
      background:none; border:none; color:var(--accent); text-decoration:underline; cursor:pointer; margin-left:8px;
      font-weight:600;
    }

    /* Views */
    .view{ display:block }
    .view.hidden{ display:none }

    /* Loading */
    #loading-view{
      display:flex; align-items:center; justify-content:center;
      min-height:220px;
    }
    .loading-inline{
      display:flex; gap:10px; align-items:center; color:var(--subtle);
      border:1px solid var(--border-color); border-radius:12px; padding:12px 14px;
      background-color: color-mix(in srgb, var(--border-color) 20%, transparent);
    }

    @media (max-width: 992px){
      .profile-info-grid{ grid-template-columns: 1fr }
      .profile-info-grid dt{ text-align:left }
    }
  </style>
</head>
<body>
  <header class="app-header">
    <div class="header-content">
      <a class="logo" href="/" aria-label="Kaffetish Home">
        Kaffetish <span class="tagline">explained by the librarian</span>
      </a>
      <div class="header-actions">
        <button id="mode-toggle" title="Toggle Theme" aria-label="Toggle Theme"><i class="fa-solid fa-moon"></i></button>
      </div>
    </div>
  </header>

  <main>
    <div class="grid">
      <!-- LEFT: Copy / Benefits -->
      <section class="panel" aria-label="Why create an account">
        <div class="panel-body">
          <h2>Save your progress</h2>
          <p class="lede">Create a permanent account to sync highlights, notes, and reading history across all your devices.</p>

          <div class="benefits">
            <div class="benefit"><i class="fa-solid fa-bookmark"></i> Keep quotes and notes organized.</div>
            <div class="benefit"><i class="fa-solid fa-cloud-arrow-up"></i> Cloud sync between mobile and desktop.</div>
            <div class="benefit"><i class="fa-solid fa-lock"></i> Private by default — you control sharing.</div>
            <div class="benefit"><i class="fa-solid fa-clock-rotate-left"></i> Pick up exactly where you left off.</div>
          </div>
        </div>
      </section>

      <!-- RIGHT: Interactive Card -->
      <section class="card">
        <!-- SIGNUP VIEW -->
        <div id="signup-view" class="view hidden" role="region" aria-labelledby="signup-title">
          <div class="card-header" id="signup-title">
            <i class="fa-solid fa-user-plus"></i> Create your account
          </div>
          <div class="card-body">
            <form id="signup-form" novalidate>
              <div class="form-grid">
                <div class="form-group">
                  <label for="firstName">First name</label>
                  <div class="field">
                    <i class="fa-regular fa-user fa"></i>
                    <input id="firstName" name="firstName" type="text" autocomplete="given-name" required placeholder="Ada" />
                  </div>
                </div>

                <div class="form-group">
                  <label for="lastName">Last name</label>
                  <div class="field">
                    <i class="fa-regular fa-id-card fa"></i>
                    <input id="lastName" name="lastName" type="text" autocomplete="family-name" required placeholder="Lovelace" />
                  </div>
                </div>

                <div class="form-group full">
                  <label for="country">Country</label>
                  <div class="field">
                    <i class="fa-solid fa-earth-europe fa"></i>
                    <select id="country" name="country" required aria-describedby="country-hint"></select>
                  </div>
                  <div id="country-hint" class="hint">Used to personalize content — never shared.</div>
                </div>

                <div class="form-group full">
                  <label for="email">Email address</label>
                  <div class="field">
                    <i class="fa-regular fa-envelope fa"></i>
                    <input id="email" name="email" type="email" required autocomplete="email" placeholder="you@domain.com" />
                  </div>
                </div>

                <div class="form-group full">
                  <label for="password">Password</label>
                  <div class="field">
                    <i class="fa-solid fa-key fa"></i>
                    <input id="password" name="password" type="password" minlength="6" required autocomplete="new-password" placeholder="Min. 6 characters" />
                  </div>
                </div>
              </div>

              <button id="submit-button" type="submit" class="btn btn-primary" style="margin-top:12px">
                <span id="button-text">Create My Account</span>
                <div id="button-spinner" class="spinner" style="display:none"></div>
              </button>
            </form>

            <div id="signup-message-box" class="message-box" aria-live="polite"></div>
          </div>
        </div>

        <!-- PROFILE VIEW -->
        <div id="profile-view" class="view hidden" role="region" aria-labelledby="profile-title">
          <div class="card-header" id="profile-title">
            <i class="fa-solid fa-circle-user"></i> Your profile
          </div>
          <div class="card-body">
            <dl class="profile-info-grid" style="margin-bottom:16px">
              <dt>Name</dt><dd id="profile-name">…</dd>
              <dt>Country</dt><dd id="profile-country">…</dd>
              <dt>Email</dt><dd id="profile-email">…</dd>
              <dt>Status</dt><dd id="profile-status">…</dd>
            </dl>

            <div id="profile-message-box" class="message-box" aria-live="polite"></div>

            <button id="logout-button" class="btn btn-secondary" style="margin-top:14px">
              <i class="fa-solid fa-right-from-bracket"></i> Log Out
            </button>
          </div>
        </div>

        <!-- LOADING VIEW -->
        <div id="loading-view" class="view hidden">
          <div class="card-body">
            <div class="loading-inline">
              <div class="spinner" aria-hidden="true" style="border-color:rgba(0,0,0,.15); border-top-color:var(--accent)"></div>
              <div>Loading profile…</div>
            </div>
          </div>
        </div>
      </section>
    </div>
  </main>

  <!-- App (keeps your original logic/IDs) -->
  <script type="module">
    // Firebase imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import {
      getAuth, onAuthStateChanged, signInAnonymously,
      linkWithCredential, EmailAuthProvider, updateProfile,
      sendEmailVerification, signOut
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import {
      getFirestore, doc, setDoc, getDoc
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    // Your config (as provided)
    const firebaseConfig = {
      apiKey: "AIzaSyAbnPpcIt88B0jIAoLUdC71zmQDvR_fdu8",
      authDomain: "physmathacademy-722b3.firebaseapp.com",
      projectId: "physmathacademy-722b3",
      storageBucket: "physmathacademy-722b3.appspot.com",
      messagingSenderId: "1093640992262",
      appId: "1:1093640992262:web:35b1bf4d2364bcf745f587"
    };

    // Init
    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    // DOM
    const DOM = {
      body: document.body,
      modeToggle: document.getElementById('mode-toggle'),
      signupView: document.getElementById('signup-view'),
      profileView: document.getElementById('profile-view'),
      loadingView: document.getElementById('loading-view'),
      signupForm: document.getElementById('signup-form'),
      submitButton: document.getElementById('submit-button'),
      buttonText: document.getElementById('button-text'),
      buttonSpinner: document.getElementById('button-spinner'),
      signupMessageBox: document.getElementById('signup-message-box'),
      profileMessageBox: document.getElementById('profile-message-box'),
      logoutButton: document.getElementById('logout-button'),
      countrySelect: document.getElementById('country'),
    };

    // Helpers
    function showView(viewId){
      [DOM.signupView, DOM.profileView, DOM.loadingView].forEach(v=>{
        v.classList.toggle('hidden', v.id !== viewId);
      });
    }

    function setMode(mode){
      DOM.body.classList.toggle('dark-mode', mode === 'dark');
      DOM.modeToggle.querySelector('i').className = `fa-solid ${mode === 'light' ? 'fa-moon' : 'fa-sun'}`;
      localStorage.setItem('kaffetishMode', mode);
    }

    function showMessage(box, type, text){
      box.textContent = text;
      box.className = `message-box ${type}`;
      box.style.display = 'block';
    }

    function setLoadingState(isLoading){
      DOM.submitButton.disabled = isLoading;
      DOM.buttonText.style.display = isLoading ? 'none' : 'inline';
      DOM.buttonSpinner.style.display = isLoading ? 'inline-block' : 'none';
    }

    async function populateCountries(){
      try{
        const res = await fetch('https://restcountries.com/v3.1/all?fields=name');
        if(!res.ok) throw new Error('Failed to fetch countries');
        const countries = await res.json();
        const sorted = countries.map(c=>c.name.common).sort((a,b)=>a.localeCompare(b));
        const frag = document.createDocumentFragment();
        const placeholder = document.createElement('option');
        placeholder.value=""; placeholder.textContent="Select your country";
        placeholder.disabled = true; placeholder.selected = true;
        frag.appendChild(placeholder);
        for(const name of sorted){
          const opt = document.createElement('option');
          opt.value = name; opt.textContent = name;
          frag.appendChild(opt);
        }
        DOM.countrySelect.innerHTML = "";
        DOM.countrySelect.appendChild(frag);
      }catch(e){
        console.error(e);
        DOM.countrySelect.innerHTML = '<option value="">Could not load countries</option>';
      }
    }

    // Handlers
    async function handleSignup(e){
      e.preventDefault();
      setLoadingState(true);
      DOM.signupMessageBox.style.display='none';

      const { firstName, lastName, country, email, password } = e.target.elements;
      const displayName = `${firstName.value.trim()} ${lastName.value.trim()}`.trim();

      try{
        const cred = EmailAuthProvider.credential(email.value, password.value);
        await linkWithCredential(auth.currentUser, cred);
        await updateProfile(auth.currentUser, { displayName });

        const ref = doc(db, "users", auth.currentUser.uid);
        await setDoc(ref, { displayName, email: email.value, country: country.value }, { merge:true });

        await sendEmailVerification(auth.currentUser);
        showMessage(DOM.signupMessageBox, 'success', 'Success! Please check your email to verify your account.');
        e.target.reset();
      }catch(error){
        const messages = {
          'auth/email-already-in-use':'This email is already taken.',
          'auth/weak-password':'Password must be at least 6 characters.',
          'auth/invalid-email':'Please enter a valid email address.'
        };
        showMessage(DOM.signupMessageBox, 'error', messages[error.code] || 'An unexpected error occurred.');
      }finally{
        setLoadingState(false);
      }
    }

    async function handleResendVerification(){
      try{
        await sendEmailVerification(auth.currentUser);
        showMessage(DOM.profileMessageBox, 'success', 'Verification email sent!');
      }catch{
        showMessage(DOM.profileMessageBox, 'error', 'Failed to send email. Please try again.');
      }
    }

    async function renderProfile(user){
      document.getElementById('profile-name').textContent = user.displayName || 'Not set';
      document.getElementById('profile-email').textContent = user.email;

      try{
        const ref = doc(db, "users", user.uid);
        const snap = await getDoc(ref);
        document.getElementById('profile-country').textContent =
          snap.exists() ? (snap.data().country || 'Not set') : 'Not set';
      }catch{
        document.getElementById('profile-country').textContent = 'Could not load';
      }

      const statusEl = document.getElementById('profile-status');
      DOM.profileMessageBox.style.display='none';
      if(user.emailVerified){
        statusEl.innerHTML = `<span class="status-verified"><i class="fa-solid fa-circle-check"></i> Verified</span>`;
      }else{
        statusEl.innerHTML = `<span class="status-unverified"><i class="fa-solid fa-circle-exclamation"></i> Unverified <button class="resend-btn" id="resend-verification">Resend Email</button></span>`;
        showMessage(DOM.profileMessageBox, 'warning', 'Please check your inbox (and spam folder) to verify your email.');
      }
    }

    // Init
    function init(){
      // Theme
      setMode(localStorage.getItem('kaffetishMode') || 'light');

      // Countries
      populateCountries();

      // Events
      DOM.modeToggle.addEventListener('click', ()=>{
        setMode(DOM.body.classList.contains('dark-mode') ? 'light' : 'dark');
      });
      DOM.signupForm.addEventListener('submit', handleSignup);
      DOM.logoutButton.addEventListener('click', ()=>signOut(auth));
      DOM.profileView.addEventListener('click', (e)=>{
        if(e.target && e.target.id === 'resend-verification') handleResendVerification();
      });

      // Auth state
      onAuthStateChanged(auth, (user)=>{
        if(user){
          if(user.isAnonymous){
            showView('signup-view');
          }else{
            renderProfile(user);
            showView('profile-view');
          }
        }else{
          showView('loading-view');
          signInAnonymously(auth).catch(err=>{
            console.error('Anonymous sign-in failed:', err);
            // fallback inline message (keeps layout consistent)
            const p = document.createElement('div');
            p.className = 'message-box error';
            p.style.display='block';
            p.textContent = 'Could not initialize session.';
            DOM.loadingView.querySelector('.card-body')?.appendChild(p);
          });
        }
      });
    }

    init();
  </script>
</body>
</html>
