<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Kaffetish - User Profile</title>

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,500;0,700;1,400&family=Poppins:wght@400;500;600&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />

  <style>
      :root {
      --bg: #FDFBF7;
      --ink: #2C2B2A;
      --accent: #FF3A44;
      --subtle: #8A8886;
      --border-color: #EAE8E4;
      --shadow-color: rgba(44, 43, 42, 0.1);
      --success: #28a745;
      --font-main: 'Lora', serif;
      --font-ui: 'Poppins', sans-serif;
    }
    body.dark-mode {
      --bg: #1e1d1c;
      --ink: #EAE8E4;
      --subtle: #999591;
      --border-color: #3A3837;
      --shadow-color: rgba(0, 0, 0, 0.3);
    }
    ::selection { background-color: var(--accent); color: white; opacity: 0.9; }
    body {
      font-family: var(--font-ui); background-color: var(--bg); color: var(--ink);
      transition: background-color 0.3s ease, color 0.3s ease;
      margin: 0; padding: 40px 24px; display: flex; justify-content: center; align-items: center;
      min-height: 100vh; box-sizing: border-box; overflow-x: hidden;
    }
    body::before {
      content: ''; position: fixed; top: -20%; left: -10%; width: 50vw; height: 50vw;
      background: radial-gradient(circle, color-mix(in srgb, var(--accent) 5%, transparent) 0%, transparent 70%);
      z-index: -1; opacity: 0.5; transform: rotate(15deg);
    }
    .loading-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background-color: var(--bg); z-index: 9999; display: flex; justify-content: center; align-items: center;
      transition: opacity 0.3s ease;
    }
    .spinner {
      border: 4px solid var(--border-color); border-top: 4px solid var(--accent);
      border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

    main { width: 100%; max-width: 950px; animation: fadeIn 0.8s ease-out both; }

    .profile-container {
      display: grid; grid-template-columns: 3fr 4fr;
      width: 100%; background-color: color-mix(in srgb, var(--border-color) 20%, transparent);
      border: 1px solid var(--border-color); border-radius: 24px; overflow: hidden;
      box-shadow: 0 20px 50px -10px var(--shadow-color);
    }
    .benefits-panel {
      padding: 64px 48px; display: flex; flex-direction: column; justify-content: center;
      background: linear-gradient(165deg, color-mix(in srgb, var(--border-color) 45%, transparent), color-mix(in srgb, var(--border-color) 15%, transparent));
      border-right: 1px solid var(--border-color);
    }
    .benefits-panel h2 {
      font-family: var(--font-main); font-size: 2.8rem; font-weight: 500; margin: 0 0 16px 0;
      line-height: 1.2; letter-spacing: -1px;
    }
    .benefits-panel p { color: var(--subtle); font-size: 1rem; line-height: 1.7; margin: 0 0 40px 0; }
    .benefit-item { display: flex; align-items: center; gap: 20px; margin-bottom: 24px; font-size: 1rem; }
    .benefit-item i { color: var(--accent); font-size: 1.2rem; width: 24px; text-align: center; transition: transform 0.3s ease; }
    .benefit-item:hover i { transform: scale(1.2); }

    .form-panel { padding: 64px; }
    .form-panel h3 {
      font-family: var(--font-main); font-size: 1.8rem; font-weight: 500;
      margin: 0 0 40px 0; text-align: left; position: relative;
    }
    .form-panel h3::after {
      content: ''; position: absolute; left: 0; bottom: -12px; width: 50px; height: 3px;
      background-color: var(--accent); border-radius: 3px;
    }

    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
    .form-field.full-width { grid-column: 1 / -1; }
    .form-field label { display: block; font-size: 0.85rem; font-weight: 500; margin-bottom: 8px; color: var(--subtle); }
    .form-field input, .form-field select {
      width: 100%; padding: 12px 14px; font-size: 1rem; font-family: var(--font-ui);
      border: 1px solid var(--border-color); border-radius: 8px; background-color: var(--bg);
      color: var(--ink); box-sizing: border-box; transition: border-color 0.2s, box-shadow 0.2s;
      -webkit-appearance: none; -moz-appearance: none; appearance: none;
    }
    .form-field input:disabled {
        background-color: color-mix(in srgb, var(--border-color) 40%, transparent);
        color: var(--subtle);
        cursor: not-allowed;
    }
    .select-wrapper { position: relative; }
    .select-wrapper::after {
      content: '\f078'; font-family: 'Font Awesome 6 Free'; font-weight: 900; position: absolute; top: 50%; right: 16px;
      transform: translateY(-50%); color: var(--subtle); pointer-events: none; transition: transform 0.2s ease;
    }
    .select-wrapper:focus-within::after { transform: translateY(-50%) rotate(180deg); }
    .form-field input:focus, .form-field select:focus {
      outline: none; border-color: var(--accent);
      box-shadow: 0 0 0 4px color-mix(in srgb, var(--accent) 20%, transparent);
    }

    .form-actions { margin-top: 32px; display: flex; justify-content: space-between; align-items: center; gap: 16px; }
    .btn {
      font-family: var(--font-ui); font-size: 1rem; font-weight: 500;
      padding: 12px 24px; border-radius: 8px; border: none; cursor: pointer; transition: all 0.2s ease;
    }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-primary { background-color: var(--accent); color: white; }
    .btn-primary:not(:disabled):hover {
      background-color: color-mix(in srgb, var(--accent) 90%, black);
      transform: translateY(-3px);
      box-shadow: 0 6px 20px color-mix(in srgb, var(--accent) 40%, transparent);
    }
    .btn-secondary { background-color: transparent; color: var(--subtle); border: 1px solid var(--border-color); }
    .btn-secondary:not(:disabled):hover { color: var(--ink); border-color: var(--ink); background-color: color-mix(in srgb, var(--border-color) 60%, transparent); }
    .form-message { margin-top: 20px; padding: 12px; border-radius: 8px; font-size: 0.9rem; text-align: center; display: none; }
    .form-message.success { background-color: color-mix(in srgb, var(--success) 15%, transparent); color: color-mix(in srgb, var(--success) 90%, black); border: 1px solid color-mix(in srgb, var(--success) 30%, transparent); }
    .form-message.error { background-color: color-mix(in srgb, var(--accent) 15%, transparent); color: var(--accent); border: 1px solid color-mix(in srgb, var(--accent) 30%, transparent); }

    #profile-view { display: none; }

    @media (max-width: 900px) {
      body { padding: 24px 16px; }
      body::before { display: none; }
      main { padding: 0; }
      .profile-container { grid-template-columns: 1fr; box-shadow: 0 10px 30px var(--shadow-color); }
      .benefits-panel { display: none; }
      .form-panel { padding: 32px 24px; }
      .form-panel h3, .benefits-panel h2 { font-size: 1.6rem; }
      .form-grid { grid-template-columns: 1fr; }
      .form-actions { flex-direction: column-reverse; gap: 12px; }
      .btn { width: 100%; }
    }
  </style>
</head>
<body>
  <div class="loading-overlay" id="loading-overlay"><div class="spinner"></div></div>

  <main>
    <div class="profile-container" id="profile-view">
      <div class="benefits-panel">
        <h2>Your Profile</h2>
        <p>Manage your account details and preferences. Your progress is always saved.</p>
        <div class="benefit-item"><i class="fa-solid fa-user-check"></i><span id="welcome-message">Welcome!</span></div>
        <div class="benefit-item"><i class="fa-solid fa-envelope"></i><span id="profile-email-display">your.email@example.com</span></div>
      </div>
      <div class="form-panel">
        <h3>Account Settings</h3>
        <form id="profile-form" novalidate>
          <div class="form-grid">
            <div class="form-field"><label for="profile-name">Name</label><input type="text" id="profile-name" required></div>
            <div class="form-field"><label for="profile-surname">Surname</label><input type="text" id="profile-surname" required></div>
            <div class="form-field full-width"><label for="profile-continent">Continent</label><div class="select-wrapper"><select id="profile-continent" required></select></div></div>
            <div class="form-field full-width"><label for="profile-email">Email (cannot be changed)</label><input type="email" id="profile-email" disabled></div>
          </div>
          <div class="form-message" id="profile-message"></div>
          <p style="text-align: center; margin-top: 24px; margin-bottom: 0;">
            <a href="https://kaffetish.club" style="color: var(--accent); text-decoration: none; font-weight: 500;">
              Back to Kaffetish.club
            </a>
          </p>
          <div class="form-actions">
            <button type="button" id="logout-button" class="btn btn-secondary">Log Out</button>
            <button type="submit" class="btn btn-primary">Save Changes</button>
          </div>
        </form>
      </div>
    </div>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAbnPpcIt88B0jIAoLUdC71zmQDvR_fdu8",
      authDomain: "physmathacademy-722b3.firebaseapp.com",
      projectId: "physmathacademy-722b3",
      storageBucket: "physmathacademy-722b3.appspot.com",
      messagingSenderId: "1093640992262",
      appId: "1:1093640992262:web:3552a4205dc5df869a84da",
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const loadingOverlay = document.getElementById('loading-overlay');
    const profileView = document.getElementById('profile-view');
    const profileForm = document.getElementById('profile-form');
    const profileMessage = document.getElementById('profile-message');
    const logoutButton = document.getElementById('logout-button');
    const continentSelect = document.getElementById('profile-continent');
    let currentUserId = null;

    const showLoading = (isLoading) => {
      loadingOverlay.style.opacity = isLoading ? '1' : '0';
      loadingOverlay.style.pointerEvents = isLoading ? 'all' : 'none';
    };

    const showMessage = (element, message, isError = true) => {
      element.textContent = message;
      element.className = 'form-message';
      element.classList.add(isError ? 'error' : 'success');
      element.style.display = 'block';
      setTimeout(() => { element.style.display = 'none'; }, 4000);
    };

    const fetchAndPopulateContinents = async (selectedValue) => {
        try {
            const response = await fetch('https://restcountries.com/v3.1/all?fields=continents');
            if (!response.ok) throw new Error('Network response failed');
            const data = await response.json();
            const continents = new Set(data.flatMap(country => country.continents));
            const sortedContinents = Array.from(continents).sort();
            
            continentSelect.innerHTML = '<option value="">Select a continent</option>';
            sortedContinents.forEach(c => {
                const option = document.createElement('option');
                option.value = c;
                option.textContent = c;
                if (c === selectedValue) {
                    option.selected = true;
                }
                continentSelect.appendChild(option);
            });
        } catch (error) {
            console.error("Failed to fetch continents:", error);
            showMessage(profileMessage, 'Could not load continent data.');
        }
    };

    onAuthStateChanged(auth, async (user) => {
      if (user && user.emailVerified) {
        currentUserId = user.uid;
        const userDocRef = doc(db, "kaffetish-users", user.uid);
        try {
          const docSnap = await getDoc(userDocRef);
          if (docSnap.exists()) {
            const userData = docSnap.data();
            document.getElementById('profile-name').value = userData.name || '';
            document.getElementById('profile-surname').value = userData.surname || '';
            document.getElementById('profile-email').value = userData.email || '';
            document.getElementById('welcome-message').textContent = `Welcome, ${userData.name || 'User'}!`;
            document.getElementById('profile-email-display').textContent = userData.email;
            
            await fetchAndPopulateContinents(userData.continent);
            
            profileView.style.display = 'grid';
          } else {
            console.error("User is verified but has no document in kaffetish-users!");
            showMessage(profileMessage, "Could not find your profile data. Please try logging out and in again.");
          }
        } catch (error) {
          console.error("Error fetching user data:", error);
          showMessage(profileMessage, "Error loading your profile.");
        } finally {
            showLoading(false);
        }
      } else {
        window.location.href = '../register/';
      }
    });

    profileForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!currentUserId) {
            showMessage(profileMessage, "Authentication error. Please log in again.");
            return;
        }

        const submitButton = profileForm.querySelector('button[type="submit"]');
        submitButton.disabled = true;
        submitButton.textContent = 'Saving...';

        const updatedData = {
            name: document.getElementById('profile-name').value,
            surname: document.getElementById('profile-surname').value,
            continent: document.getElementById('profile-continent').value,
        };

        try {
            const userDocRef = doc(db, "kaffetish-users", currentUserId);
            await updateDoc(userDocRef, updatedData);
            showMessage(profileMessage, "Profile updated successfully!", false);
            document.getElementById('welcome-message').textContent = `Welcome, ${updatedData.name}!`;
        } catch (error) {
            console.error("Error updating profile:", error);
            showMessage(profileMessage, "Failed to update profile.");
        } finally {
            submitButton.disabled = false;
            submitButton.textContent = 'Save Changes';
        }
    });

    logoutButton.addEventListener('click', async () => {
        try {
            await signOut(auth);
            // onAuthStateChanged will handle the redirect.
        } catch (error) {
            console.error("Logout Error:", error);
            showMessage(profileMessage, "Failed to log out.");
        }
    });
  </script>
</body>
</html>
