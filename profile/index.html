<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Profile | Kaffetish</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,500;0,700;1,400&family=Poppins:wght@400;500;600&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />

    <style>
        :root {
            --bg: #FDFBF7;
            --ink: #2C2B2A;
            --accent: #FF3A44;
            --subtle: #8A8886;
            --border-color: #EAE8E4;
            --shadow-color: rgba(44, 43, 42, 0.1);
            --font-main: 'Lora', serif;
            --font-ui: 'Poppins', sans-serif;
            --success: #28a745;
            --warning: #ffc107;
        }

        body.dark-mode {
            --bg: #21201F;
            --ink: #EAE8E4;
            --subtle: #999591;
            --border-color: #3A3837;
            --shadow-color: rgba(0, 0, 0, 0.25);
            --success: #3ddc63;
            --warning: #f3ca5c;
        }

        ::selection { background-color: var(--accent); color: white; opacity: 0.9; }

        body {
            font-family: var(--font-ui);
            background-color: var(--bg);
            color: var(--ink);
            transition: background-color 0.3s ease, color 0.3s ease;
            margin: 0;
            padding-top: 60px;
        }

        .app-header {
            position: fixed; top: 0; left: 0; width: 100%; height: 60px;
            background-color: color-mix(in srgb, var(--bg) 85%, transparent);
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--border-color); z-index: 1000;
        }
        .header-content {
            max-width: 1200px; height: 100%; margin: 0 auto; padding: 0 24px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .logo-link { text-decoration: none; }
        .logo {
            font-size: 1.6rem; font-weight: 500; letter-spacing: -0.5px;
            color: var(--accent); font-family: var(--font-main);
        }
        body.dark-mode .logo { color: var(--ink); }
        .header-actions { display: flex; align-items: center; gap: 16px; }
        .header-actions button {
            background: transparent; border: none; color: var(--subtle); border-radius: 6px;
            padding: 8px 10px; cursor: pointer; font-size: 1rem;
            transition: color 0.2s ease, background-color 0.2s ease;
        }
        .header-actions button:hover { color: var(--ink); background-color: color-mix(in srgb, var(--border-color) 60%, transparent); }

        main { 
            padding: 80px 48px;
            max-width: 1024px; /* A bit wider for the open layout */
            margin: 0 auto;
            box-sizing: border-box;
        }

        .page-header {
            margin-bottom: 80px; /* More space below header */
            max-width: 600px;
        }
        .page-header h1 {
            font-family: var(--font-main);
            font-size: 3.8rem;
            font-weight: 500;
            margin: 0 0 16px 0;
            line-height: 1.1;
            letter-spacing: -1.5px;
        }
        .page-header p {
            font-size: 1.1rem;
            color: var(--subtle);
            line-height: 1.7;
            max-width: 500px;
        }

        .content-layout {
            display: grid;
            grid-template-columns: 0.8fr 1.2fr; /* Ratio for info vs form */
            gap: 100px; /* Generous gap for a bold look */
            align-items: flex-start;
        }

        .info-block .icon {
            font-size: 2.8rem;
            color: var(--accent);
            margin-bottom: 20px;
        }
        .info-block h3 {
            font-family: var(--font-main);
            font-size: 1.8rem;
            font-weight: 500;
            margin: 0 0 12px 0;
        }
        .info-block p {
            color: var(--subtle);
            line-height: 1.6;
        }

        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
        .form-group { margin-bottom: 24px; }
        .form-group.full-width { grid-column: 1 / -1; }

        .form-group label {
            display: block; font-weight: 500;
            margin-bottom: 8px; font-size: 0.9rem;
        }
        .form-group input, .form-group select {
            width: 100%; padding: 12px 16px; font-size: 1rem;
            font-family: var(--font-ui); border: 1px solid var(--border-color);
            border-radius: 8px; background-color: var(--bg); color: var(--ink);
            box-sizing: border-box; transition: border-color 0.2s, box-shadow 0.2s;
        }
        .form-group input:focus, .form-group select:focus {
            outline: none; border-color: var(--accent);
            box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent) 20%, transparent);
        }

        .btn {
            width: 100%; padding: 14px; border: none; border-radius: 8px;
            font-size: 1rem; font-weight: 600; cursor: pointer;
            transition: all 0.2s;
            display: flex; justify-content: center; align-items: center; gap: 10px;
        }
        .btn-primary { background-color: var(--accent); color: white; }
        .btn-primary:hover { background-color: color-mix(in srgb, var(--accent) 85%, black); transform: translateY(-2px); }
        .btn-primary:disabled { background-color: var(--subtle); cursor: not-allowed; transform: none; }
        .btn-secondary { background-color: transparent; color: var(--subtle); border: 1px solid var(--border-color); margin-top: 16px; }
        .btn-secondary:hover { background-color: var(--border-color); color: var(--ink); }

        .message-box {
            padding: 12px 16px; border-radius: 8px; margin-top: 24px;
            font-size: 0.9rem; text-align: center; display: none;
        }
        .message-box.error { background-color: color-mix(in srgb, var(--accent) 15%, transparent); color: color-mix(in srgb, var(--accent) 90%, black); border: 1px solid color-mix(in srgb, var(--accent) 30%, transparent); }
        .message-box.success { background-color: color-mix(in srgb, var(--success) 15%, transparent); color: color-mix(in srgb, var(--success) 90%, black); border: 1px solid color-mix(in srgb, var(--success) 30%, transparent); }
        .message-box.warning { background-color: color-mix(in srgb, var(--warning) 25%, transparent); color: color-mix(in srgb, var(--warning) 95%, black); border: 1px solid color-mix(in srgb, var(--warning) 40%, transparent); }
        body.dark-mode .message-box.warning { color: var(--ink); }

        .spinner {
            width: 1.2em; height: 1.2em; border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.3); border-top-color: #fff;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .profile-details-area {
            max-width: 450px;
        }

        .profile-info-grid { display: grid; grid-template-columns: 100px 1fr; gap: 20px; align-items: center; }
        .profile-info-grid dt { font-weight: 500; color: var(--subtle); text-align: right; }
        .profile-info-grid dd { margin: 0; font-weight: 500; font-size: 1.1rem; }
        .status-verified { color: var(--success); }
        .status-unverified { color: var(--warning); }
        .status-unverified button { font-size: 0.85rem; margin-left: 8px; background: none; border: none; color: var(--accent); cursor: pointer; text-decoration: underline; padding: 2px; }

        .hidden { display: none; }
        
        @media (max-width: 820px) {
            main { padding: 40px 24px; }
            .page-header { margin-bottom: 50px; }
            .page-header h1 { font-size: 2.8rem; }
            .content-layout { grid-template-columns: 1fr; gap: 50px; }
            .info-block { text-align: center; }
            .info-block .icon { margin-left: auto; margin-right: auto; }
            .profile-info-grid dt { text-align: left; }
        }
    </style>
</head>
<body>
    <header class="app-header">
        <div class="header-content">
            <a href="/" class="logo-link"><h1 class="logo">Kaffetish</h1></a>
            <div class="header-actions">
                <button id="mode-toggle" title="Toggle Theme"><i class="fa-solid fa-moon"></i></button>
            </div>
        </div>
    </header>

    <main>
        <div id="signup-view" class="hidden">
            <div class="page-header">
                <h1>Save Your Progress</h1>
            </div>
            <div class="content-layout">
                <div class="info-block">
                    <i class="icon fa-solid fa-cloud-arrow-up"></i>
                    <h3>Securely Sync Your Data</h3>
                    <p>Your reading journey is important. Create an account to ensure all your progress is backed up and available wherever you read next.</p>
                </div>
                <div>
                    <form id="signup-form">
                        <div class="form-grid">
                            <div class="form-group"><label for="firstName">First Name</label><input type="text" id="firstName" required autocomplete="given-name"></div>
                            <div class="form-group"><label for="lastName">Last Name</label><input type="text" id="lastName" required autocomplete="family-name"></div>
                        </div>
                        <div class="form-group full-width"><label for="country">Country</label><select id="country" required autocomplete="country-name"></select></div>
                        <hr style="border:0; height:1px; background-color: var(--border-color); margin: 10px 0 24px;">
                        <div class="form-group full-width"><label for="email">Email Address</label><input type="email" id="email" required autocomplete="email"></div>
                        <div class="form-group full-width"><label for="password">Password (min. 6 characters)</label><input type="password" id="password" required minlength="6" autocomplete="new-password"></div>
                        <button type="submit" id="submit-button" class="btn btn-primary">
                            <span id="button-text">Create My Account</span>
                            <div id="button-spinner" class="spinner" style="display: none;"></div>
                        </button>
                    </form>
                    <div id="signup-message-box" class="message-box"></div>
                </div>
            </div>
        </div>

        <div id="profile-view" class="hidden">
            <div class="page-header">
                <h1>Welcome Back</h1>
                <p>Manage your account details and review your verification status. You can log out at any time.</p>
            </div>
            <div class="content-layout">
                <div class="info-block">
                    <i class="icon fa-solid fa-user-check"></i>
                    <h3>Account Overview</h3>
                    <p>All your reading progress, notes, and highlights are safely connected to this account.</p>
                </div>
                <div class="profile-details-area">
                    <dl class="profile-info-grid">
                        <dt>Name</dt><dd id="profile-name">...</dd>
                        <dt>Country</dt><dd id="profile-country">...</dd>
                        <dt>Email</dt><dd id="profile-email">...</dd>
                        <dt>Status</dt><dd id="profile-status">...</dd>
                    </dl>
                    <div id="profile-message-box" class="message-box"></div>
                    <button id="logout-button" class="btn btn-secondary">Log Out</button>
                </div>
            </div>
        </div>

        <div id="loading-view" style="text-align: center; padding: 60px;">
            <p style="font-size: 1.1rem; color: var(--subtle);">Loading Profile...</p>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously, linkWithCredential, EmailAuthProvider, updateProfile, sendEmailVerification, signOut } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAbnPpcIt88B0jIAoLUdC71zmQDvR_fdu8",
            authDomain: "physmathacademy-722b3.firebaseapp.com",
            projectId: "physmathacademy-722b3",
            storageBucket: "physmathacademy-722b3.appspot.com",
            messagingSenderId: "1093640992262",
            appId: "1:1093640992262:web:35b1bf4d2364bcf745f587"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const DOM = {
            body: document.body,
            modeToggle: document.getElementById('mode-toggle'),
            signupView: document.getElementById('signup-view'),
            profileView: document.getElementById('profile-view'),
            loadingView: document.getElementById('loading-view'),
            signupForm: document.getElementById('signup-form'),
            submitButton: document.getElementById('submit-button'),
            buttonText: document.getElementById('button-text'),
            buttonSpinner: document.getElementById('button-spinner'),
            signupMessageBox: document.getElementById('signup-message-box'),
            profileMessageBox: document.getElementById('profile-message-box'),
            logoutButton: document.getElementById('logout-button'),
            countrySelect: document.getElementById('country'),
        };

        function setMode(mode) {
            DOM.body.classList.toggle("dark-mode", mode === 'dark');
            DOM.modeToggle.querySelector('i').className = `fa-solid ${mode === 'light' ? 'fa-moon' : 'fa-sun'}`;
            localStorage.setItem("kaffetishMode", mode);
        }

        function showView(view) {
            [DOM.signupView, DOM.profileView, DOM.loadingView].forEach(v => v.classList.add('hidden'));
            if(view) view.classList.remove('hidden');
        }
        
        function showMessage(box, type, text) {
            box.textContent = text;
            box.className = `message-box ${type}`;
            box.style.display = 'block';
        }

        function setLoadingState(isLoading) {
            DOM.submitButton.disabled = isLoading;
            DOM.buttonText.style.display = isLoading ? 'none' : 'block';
            DOM.buttonSpinner.style.display = isLoading ? 'block' : 'none';
        }

        async function populateCountries() {
            try {
                const response = await fetch('https://restcountries.com/v3.1/all?fields=name');
                const countries = await response.json();
                const sorted = countries.map(c => c.name.common).sort();
                DOM.countrySelect.innerHTML = '<option value="" disabled selected>Select your country</option>';
                sorted.forEach(name => DOM.countrySelect.innerHTML += `<option value="${name}">${name}</option>`);
            } catch (error) {
                console.error("Country fetch error:", error);
            }
        }

        async function handleSignup(e) {
            e.preventDefault();
            setLoadingState(true);
            DOM.signupMessageBox.style.display = 'none';
            const { firstName, lastName, country, email, password } = e.target.elements;
            const displayName = `${firstName.value.trim()} ${lastName.value.trim()}`;
            try {
                const credential = EmailAuthProvider.credential(email.value, password.value);
                await linkWithCredential(auth.currentUser, credential);
                await updateProfile(auth.currentUser, { displayName });
                const userDocRef = doc(db, "users", auth.currentUser.uid);
                await setDoc(userDocRef, { displayName, email: email.value, country: country.value }, { merge: true });
                await sendEmailVerification(auth.currentUser);
                showMessage(DOM.signupMessageBox, 'success', 'Success! Please check your email to verify your account.');
                DOM.signupForm.reset();
            } catch (error) {
                let msg = 'An unexpected error occurred.';
                if (error.code === 'auth/email-already-in-use') msg = 'This email is already taken.';
                else if (error.code === 'auth/weak-password') msg = 'Password must be at least 6 characters.';
                else if (error.code === 'auth/invalid-email') msg = 'Please enter a valid email address.';
                showMessage(DOM.signupMessageBox, 'error', msg);
            } finally {
                setLoadingState(false);
            }
        }

        async function renderProfile(user) {
            document.getElementById('profile-name').textContent = user.displayName || 'Not set';
            document.getElementById('profile-email').textContent = user.email;
            
            const userDocRef = doc(db, "users", user.uid);
            const userDoc = await getDoc(userDocRef);
            if (userDoc.exists()) {
                document.getElementById('profile-country').textContent = userDoc.data().country || 'Not set';
            }

            const statusEl = document.getElementById('profile-status');
            if (user.emailVerified) {
                statusEl.innerHTML = '<span class="status-verified"><i class="fa-solid fa-circle-check"></i> Verified</span>';
                DOM.profileMessageBox.style.display = 'none';
            } else {
                statusEl.innerHTML = `<span class="status-unverified"><i class="fa-solid fa-circle-exclamation"></i> Unverified</span> <button id="resend-verification">Resend Email</button>`;
                showMessage(DOM.profileMessageBox, 'warning', 'Please check your inbox (and spam folder) to verify your email.');
                document.getElementById('resend-verification').addEventListener('click', async () => {
                    try {
                        await sendEmailVerification(auth.currentUser);
                        showMessage(DOM.profileMessageBox, 'success', 'Verification email sent!');
                    } catch (err) { showMessage(DOM.profileMessageBox, 'error', 'Failed to send email. Please try again.'); }
                });
            }
        }

        function init() {
            setMode(localStorage.getItem("kaffetishMode") || 'light');
            DOM.modeToggle.addEventListener("click", () => setMode(DOM.body.classList.contains('dark-mode') ? 'light' : 'dark'));
            populateCountries();
            DOM.signupForm.addEventListener('submit', handleSignup);
            DOM.logoutButton.addEventListener('click', () => signOut(auth));

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    if (user.isAnonymous) {
                        showView(DOM.signupView);
                    } else {
                        renderProfile(user);
                        showView(DOM.profileView);
                    }
                } else {
                    signInAnonymously(auth).catch(console.error);
                }
            });
        }

        init();
    </script>
</body>
</html>
