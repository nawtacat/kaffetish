<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Kaffetish - User Profile</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,500;0,700;1,400&family=Poppins:wght@400;500;600&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    
    <style>
        :root {
            --bg: #FDFBF7;
            --ink: #2C2B2A;
            --accent: #FF3A44;
            --subtle: #8A8886;
            --border-color: #EAE8E4;
            --shadow-color: rgba(44, 43, 42, 0.1);
            --success: #28a745;
            --font-main: 'Lora', serif;
            --font-ui: 'Poppins', sans-serif;
        }

        body.dark-mode {
            --bg: #1e1d1c; /* Slightly darker for more depth */
            --ink: #EAE8E4;
            --subtle: #999591;
            --border-color: #3A3837;
            --shadow-color: rgba(0, 0, 0, 0.3);
        }

        ::selection { background-color: var(--accent); color: white; opacity: 0.9; }

        body {
            font-family: var(--font-ui);
            background-color: var(--bg);
            color: var(--ink);
            transition: background-color 0.3s ease, color 0.3s ease;
            margin: 0;
            padding: 100px 24px; /* More padding for desktop */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            box-sizing: border-box;
            overflow-x: hidden;
        }

        /* --- Creative Background Effects (Desktop Only) --- */
        body::before {
            content: '';
            position: fixed;
            top: -20%;
            left: -10%;
            width: 50vw;
            height: 50vw;
            background: radial-gradient(circle, color-mix(in srgb, var(--accent) 5%, transparent) 0%, transparent 70%);
            z-index: -1;
            opacity: 0.5;
            transform: rotate(15deg);
        }

        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--bg); z-index: 9999;
            display: flex; justify-content: center; align-items: center;
            transition: opacity 0.3s ease;
        }
        .spinner {
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--accent);
            border-radius: 50%;
            width: 40px; height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Header --- */
        .app-header {
            position: fixed; top: 0; left: 0; width: 100%; height: 60px;
            background-color: color-mix(in srgb, var(--bg) 85%, transparent);
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--border-color); z-index: 1000;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .header-content {
            max-width: 1200px; height: 100%; margin: 0 auto; padding: 0 24px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .logo {
            display: flex; align-items: baseline; font-size: 1.6rem;
            font-weight: 500; letter-spacing: -0.5px;
            color: var(--accent); font-family: var(--font-main);
            text-decoration: none;
        }
        body.dark-mode .logo { color: var(--ink); }
        .header-actions { display: flex; align-items: center; gap: 16px; }
        .header-actions button {
            background: transparent; border: none; color: var(--subtle); border-radius: 6px;
            padding: 8px 10px; cursor: pointer; font-size: 1rem;
            transition: color 0.2s ease, background-color 0.2s ease;
        }
        .header-actions button:hover { color: var(--ink); background-color: color-mix(in srgb, var(--border-color) 60%, transparent); }

        /* --- Main Content --- */
        main {
            width: 100%;
            max-width: 950px; /* Slightly wider for new layout */
            animation: fadeIn 0.8s ease-out both;
        }

        .profile-container {
            display: grid;
            grid-template-columns: 3fr 4fr; /* BOLD: Asymmetrical layout */
            width: 100%;
            background-color: color-mix(in srgb, var(--border-color) 20%, transparent);
            border: 1px solid var(--border-color);
            border-radius: 24px;
            overflow: hidden;
            box-shadow: 0 20px 50px -10px var(--shadow-color);
        }

        /* --- Left Panel (Benefits/Welcome) - CREATIVE REIMAGINING --- */
        .benefits-panel {
            padding: 64px 48px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            background: linear-gradient(165deg, color-mix(in srgb, var(--border-color) 45%, transparent), color-mix(in srgb, var(--border-color) 15%, transparent));
            border-right: 1px solid var(--border-color);
        }
        .benefits-panel h2 {
            font-family: var(--font-main);
            font-size: 2.8rem; /* BOLD: Larger heading */
            font-weight: 500;
            margin: 0 0 16px 0;
            line-height: 1.2;
            letter-spacing: -1px;
        }
        .benefits-panel p {
            color: var(--subtle);
            font-size: 1rem;
            line-height: 1.7;
            margin: 0 0 40px 0;
        }
        .benefit-item {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 24px;
            font-size: 1rem;
        }
        .benefit-item i {
            color: var(--accent);
            font-size: 1.2rem;
            width: 24px;
            text-align: center;
            transition: transform 0.3s ease;
        }
        .benefit-item:hover i {
            transform: scale(1.2);
        }
        
        /* --- Right Panel (Form) --- */
        .form-panel {
            padding: 64px;
        }
        .form-panel h3 {
            font-family: var(--font-main);
            font-size: 1.8rem; /* BOLD: Larger heading */
            font-weight: 500;
            margin: 0 0 40px 0;
            text-align: left;
            position: relative;
        }
        .form-panel h3::after {
            content: ''; position: absolute; left: 0; bottom: -12px;
            width: 50px; height: 3px; background-color: var(--accent);
            border-radius: 3px;
        }

        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
        .form-field.full-width { grid-column: 1 / -1; }
        .form-field label { display: block; font-size: 0.85rem; font-weight: 500; margin-bottom: 8px; color: var(--subtle); }
        .form-field input, .form-field select {
            width: 100%; padding: 12px 14px; font-size: 1rem;
            font-family: var(--font-ui); border: 1px solid var(--border-color);
            border-radius: 8px; background-color: var(--bg);
            color: var(--ink); box-sizing: border-box;
            transition: border-color 0.2s, box-shadow 0.2s;
            -webkit-appearance: none; -moz-appearance: none; appearance: none;
        }
        .select-wrapper { position: relative; }
        .select-wrapper::after {
            content: '\f078'; font-family: 'Font Awesome 6 Free';
            font-weight: 900; position: absolute; top: 50%; right: 16px;
            transform: translateY(-50%); color: var(--subtle);
            pointer-events: none; transition: transform 0.2s ease;
        }
        .select-wrapper:focus-within::after { transform: translateY(-50%) rotate(180deg); }
        .form-field input:focus, .form-field select:focus {
            outline: none; border-color: var(--accent);
            box-shadow: 0 0 0 4px color-mix(in srgb, var(--accent) 20%, transparent);
        }
        
        /* --- Buttons & Messages --- */
        .form-actions { margin-top: 32px; display: flex; justify-content: space-between; align-items: center; gap: 16px; }
        .btn {
            font-family: var(--font-ui); font-size: 1rem; font-weight: 500;
            padding: 12px 24px; border-radius: 8px; border: none;
            cursor: pointer; transition: all 0.2s ease;
        }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background-color: var(--accent); color: white; }
        .btn-primary:not(:disabled):hover {
            background-color: color-mix(in srgb, var(--accent) 90%, black);
            transform: translateY(-3px);
            box-shadow: 0 6px 20px color-mix(in srgb, var(--accent) 40%, transparent);
        }
        .btn-secondary { background-color: transparent; color: var(--subtle); }
        .btn-secondary:not(:disabled):hover { color: var(--accent); }
        .form-message { margin-top: 20px; padding: 12px; border-radius: 8px; font-size: 0.9rem; text-align: center; display: none; }
        .form-message.success { background-color: color-mix(in srgb, var(--success) 15%, transparent); color: color-mix(in srgb, var(--success) 90%, black); border: 1px solid color-mix(in srgb, var(--success) 30%, transparent); }
        .form-message.error { background-color: color-mix(in srgb, var(--accent) 15%, transparent); color: var(--accent); border: 1px solid color-mix(in srgb, var(--accent) 30%, transparent); }
        .auth-toggle { text-align: center; margin-top: 24px; font-size: 0.9rem; color: var(--subtle); }
        .auth-toggle a { color: var(--accent); font-weight: 500; cursor: pointer; text-decoration: none; }
        .auth-toggle a:hover { text-decoration: underline; }

        /* --- Hide/Show Views --- */
        #profile-view, #login-view { display: none; }
        
        /* --- Responsive Design for Mobile --- */
        @media (max-width: 900px) {
            body { padding: 80px 16px; }
            body::before { display: none; } /* Remove background effect on mobile */
            main { padding: 0; }
            .profile-container { grid-template-columns: 1fr; box-shadow: 0 10px 30px var(--shadow-color); }
            .benefits-panel { display: none; } 
            .form-panel { padding: 32px 24px; }
            .form-panel h3, .benefits-panel h2 { font-size: 1.6rem; } /* Normalize font sizes */
            .form-grid { grid-template-columns: 1fr; }
            .form-actions { flex-direction: column-reverse; }
            .btn { width: 100%; }
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loading-overlay"><div class="spinner"></div></div>
    <header class="app-header">
        <div class="header-content">
            <a href="https://kaffetish.club/" class="logo">Kaffetish</a>
            <div class="header-actions">
                 <button id="mode-toggle" title="Toggle Theme"><i class="fa-solid fa-moon"></i></button>
            </div>
        </div>
    </header>

    <main>
        <!-- REGISTRATION VIEW -->
        <div class="profile-container" id="register-view">
            <div class="benefits-panel">
                <h2>Create Your Account</h2>
                <p>Join our community to save your reading progress and curate a personal collection.</p>
                <div class="benefit-item"><i class="fa-solid fa-bookmark"></i><span>Save your reading progress</span></div>
                <div class="benefit-item"><i class="fa-solid fa-book-open"></i><span>Access your library anywhere</span></div>
                <div class="benefit-item"><i class="fa-solid fa-star"></i><span>Curate personal collections</span></div>
            </div>
            <div class="form-panel">
                <h3>Register</h3>
                <form id="register-form" novalidate>
                    <div class="form-grid">
                        <div class="form-field"><label for="reg-name">Name</label><input type="text" id="reg-name" required></div>
                        <div class="form-field"><label for="reg-surname">Surname</label><input type="text" id="reg-surname" required></div>
                        <div class="form-field full-width"><label for="reg-email">Email</label><input type="email" id="reg-email" required></div>
                        <div class="form-field full-width"><label for="reg-continent">Continent</label><div class="select-wrapper"><select id="reg-continent" required></select></div></div>
                        <div class="form-field"><label for="reg-password">Password</label><input type="password" id="reg-password" required minlength="8"></div>
                        <div class="form-field"><label for="reg-password-confirm">Confirm Password</label><input type="password" id="reg-password-confirm" required minlength="8"></div>
                    </div>
                    <div class="form-message" id="register-message"></div>
                    <div class="form-actions"><button type="submit" class="btn btn-primary">Create Account</button></div>
                    <p class="auth-toggle">Already have an account? <a id="show-login">Sign In</a></p>
                </form>
            </div>
        </div>

        <!-- LOGIN VIEW -->
        <div class="profile-container" id="login-view">
            <div class="benefits-panel">
                 <h2>Welcome Back</h2>
                 <p>Sign in to access your personal library and continue where you left off.</p>
                 <div class="benefit-item"><i class="fa-solid fa-arrow-right-to-bracket"></i><span>Quick & Secure Login</span></div>
                 <div class="benefit-item"><i class="fa-solid fa-cloud"></i><span>Your progress is synced</span></div>
            </div>
            <div class="form-panel">
                 <h3>Sign In</h3>
                 <form id="login-form" novalidate>
                     <div class="form-grid">
                         <div class="form-field full-width"><label for="login-email">Email</label><input type="email" id="login-email" required></div>
                         <div class="form-field full-width"><label for="login-password">Password</label><input type="password" id="login-password" required></div>
                     </div>
                     <div class="form-message" id="login-message"></div>
                     <div class="form-actions"><button type="submit" class="btn btn-primary">Sign In</button></div>
                     <p class="auth-toggle">Don't have an account? <a id="show-register">Register</a></p>
                 </form>
            </div>
        </div>

        <!-- PROFILE SETTINGS VIEW -->
        <div class="profile-container" id="profile-view">
            <div class="benefits-panel">
                <h2>Your Profile</h2>
                <p>Manage your account details and preferences. Your progress is always saved.</p>
                <div class="benefit-item"><i class="fa-solid fa-user-check"></i><span id="welcome-message">Welcome!</span></div>
                <div class="benefit-item"><i class="fa-solid fa-envelope"></i><span id="profile-email-display">your.email@example.com</span></div>
            </div>
            <div class="form-panel">
                <h3>Account Settings</h3>
                <form id="profile-form" novalidate>
                     <div class="form-grid">
                        <div class="form-field"><label for="profile-name">Name</label><input type="text" id="profile-name" required></div>
                        <div class="form-field"><label for="profile-surname">Surname</label><input type="text" id="profile-surname" required></div>
                        <div class="form-field full-width"><label for="profile-continent">Continent</label><div class="select-wrapper"><select id="profile-continent" required></select></div></div>
                        <div class="form-field full-width"><label for="profile-email">Email (cannot be changed)</label><input type="email" id="profile-email" disabled></div>
                    </div>
                    <div class="form-message" id="profile-message"></div>
                    <div class="form-actions">
                        <button type="button" id="logout-button" class="btn btn-secondary">Log Out</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </main>

<script type="module">
/* =========================
   FIREBASE + AUTH PERSISTENCE
   ========================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import {
  getAuth,
  setPersistence,
  browserLocalPersistence,
  createUserWithEmailAndPassword,
  sendEmailVerification,
  signInWithEmailAndPassword,
  onAuthStateChanged,
  signOut,
} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import {
  getFirestore,
  doc,
  setDoc,
  getDoc,
  updateDoc,
} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAbnPpcIt88B0jIAoLUdC71zmQDvR_fdu8",
  authDomain: "physmathacademy-722b3.firebaseapp.com",
  projectId: "physmathacademy-722b3",
  storageBucket: "physmathacademy-722b3.appspot.com",
  messagingSenderId: "1093640992262",
  appId: "1:1093640992262:web:3552a4205dc5df869a84da",
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// Expose for debug
window.auth = auth;
window.db = db;

/* =========================
   DOM CACHING & UTILITIES
   ========================= */
const DOM = {
  body: document.body,
  loadingOverlay: document.getElementById("loading-overlay"),

  // Views
  registerView: document.getElementById("register-view"),
  loginView: document.getElementById("login-view"),
  profileView: document.getElementById("profile-view"),

  // Forms & fields
  registerForm: document.getElementById("register-form"),
  loginForm: document.getElementById("login-form"),
  profileForm: document.getElementById("profile-form"),

  regName: document.getElementById("reg-name"),
  regSurname: document.getElementById("reg-surname"),
  regEmail: document.getElementById("reg-email"),
  regContinent: document.getElementById("reg-continent"),
  regPassword: document.getElementById("reg-password"),
  regPasswordConfirm: document.getElementById("reg-password-confirm"),

  loginEmail: document.getElementById("login-email"),
  loginPassword: document.getElementById("login-password"),

  profileName: document.getElementById("profile-name"),
  profileSurname: document.getElementById("profile-surname"),
  profileContinent: document.getElementById("profile-continent"),
  profileEmail: document.getElementById("profile-email"),

  // Messages
  registerMessage: document.getElementById("register-message"),
  loginMessage: document.getElementById("login-message"),
  profileMessage: document.getElementById("profile-message"),

  // Other UI
  showLoginLink: document.getElementById("show-login"),
  showRegisterLink: document.getElementById("show-register"),
  welcomeMessage: document.getElementById("welcome-message"),
  profileEmailDisplay: document.getElementById("profile-email-display"),
  logoutButton: document.getElementById("logout-button"),
  modeToggle: document.getElementById("mode-toggle"),
};

const state = {
  mode: localStorage.getItem("kaffetishMode") || "light",
  // If we just attempted a login during this page session:
  justTriedLogin: false,
};

const continents = [
  "Africa",
  "Antarctica",
  "Asia",
  "Europe",
  "North America",
  "Australia/Oceania",
  "South America",
];

function populateContinents() {
  const opts = continents.map((c) => `<option value="${c}">${c}</option>`).join("");
  DOM.regContinent.innerHTML =
    `<option value="" disabled selected>Select your continent</option>` + opts;
  DOM.profileContinent.innerHTML = opts;
}

function setMode(mode) {
  state.mode = mode;
  DOM.body.classList.toggle("dark-mode", mode === "dark");
  const icon = DOM.modeToggle?.querySelector("i");
  if (icon) icon.className = `fa-solid ${mode === "light" ? "fa-moon" : "fa-sun"}`;
  localStorage.setItem("kaffetishMode", mode);
}

function showView(which /* 'login' | 'register' | 'profile' */) {
  DOM.registerView.style.display = "none";
  DOM.loginView.style.display = "none";
  DOM.profileView.style.display = "none";
  const el = {
    login: DOM.loginView,
    register: DOM.registerView,
    profile: DOM.profileView,
  }[which];
  if (el) el.style.display = "grid";
}

function showMessage(el, text, type /* 'success'|'error' */) {
  el.textContent = text;
  el.className = `form-message ${type}`;
  el.style.display = "block";
}
function hideMessage(el) {
  el.style.display = "none";
}

function setLoading(form, isLoading) {
  const btn = form?.querySelector('button[type="submit"]');
  if (!btn) return;
  const map = {
    "register-form": "Create Account",
    "login-form": "Sign In",
    "profile-form": "Save Changes",
  };
  btn.disabled = isLoading;
  btn.textContent = isLoading ? "Processing..." : map[form.id] || "Submit";
}

/* =========================
   RENDER FOR AUTH STATE
   ========================= */
async function renderForUser(user) {
  // Always hide overlay at the end
  const done = () => {
    DOM.loadingOverlay.style.opacity = "0";
    setTimeout(() => (DOM.loadingOverlay.style.display = "none"), 300);
  };

  try {
    if (user) {
      // If we have a user, try to load profile fields.
      const snap = await getDoc(doc(db, "users", user.uid));
      if (snap.exists()) {
        const data = snap.data();
        DOM.welcomeMessage.textContent = `Welcome, ${data.name}!`;
        DOM.profileEmailDisplay.textContent = user.email || "";
        DOM.profileName.value = data.name || "";
        DOM.profileSurname.value = data.surname || "";
        DOM.profileContinent.value = data.continent || "";
        DOM.profileEmail.value = user.email || "";
      } else {
        // User doc missing: create a minimal one so profile loads reliably
        const minimal = {
          name: user.displayName || "Reader",
          surname: "",
          continent: "",
          email: user.email || "",
          createdAt: Date.now(),
        };
        await setDoc(doc(db, "users", user.uid), minimal, { merge: true });
        DOM.welcomeMessage.textContent = `Welcome, ${minimal.name}!`;
        DOM.profileEmailDisplay.textContent = minimal.email;
        DOM.profileName.value = minimal.name;
        DOM.profileSurname.value = minimal.surname;
        DOM.profileContinent.value = minimal.continent;
        DOM.profileEmail.value = minimal.email;
      }
      showView("profile");
    } else {
      // No user: show login
      showView("login");
      DOM.loginForm?.reset();
    }
  } catch (e) {
    console.error("renderForUser error:", e);
    // Fallback to login view if something odd happens.
    showView("login");
  } finally {
    done();
  }
}

/* =========================
   FORM HANDLERS
   ========================= */
async function handleRegister(e) {
  e.preventDefault();
  hideMessage(DOM.registerMessage);

  const name = DOM.regName.value.trim();
  const surname = DOM.regSurname.value.trim();
  const email = DOM.regEmail.value.trim();
  const continent = DOM.regContinent.value;
  const password = DOM.regPassword.value;
  const confirmPassword = DOM.regPasswordConfirm.value;

  if (!name || !surname || !email || !continent || !password) {
    return showMessage(DOM.registerMessage, "Please fill in all fields.", "error");
  }
  if (password !== confirmPassword) {
    return showMessage(DOM.registerMessage, "Passwords do not match.", "error");
  }
  if (password.length < 8) {
    return showMessage(DOM.registerMessage, "Password must be at least 8 characters.", "error");
  }

  setLoading(DOM.registerForm, true);
  try {
    const cred = await createUserWithEmailAndPassword(auth, email, password);
    await setDoc(doc(db, "users", cred.user.uid), { name, surname, continent, email }, { merge: true });
    await sendEmailVerification(cred.user);
    showMessage(
      DOM.registerMessage,
      "Success! A verification link has been sent to your email.",
      "success"
    );
    DOM.registerForm.reset();
    // After registration, keep them signed in. They'll still need to verify before login form allows new sign-ins.
    showView("profile");
  } catch (error) {
    console.error("Register error:", error);
    let msg = "An unexpected error occurred. Please try again.";
    if (error.code === "auth/email-already-in-use") msg = "This email is already registered. Please Sign In.";
    else if (error.code === "auth/weak-password") msg = "The password is too weak.";
    showMessage(DOM.registerMessage, msg, "error");
  } finally {
    setLoading(DOM.registerForm, false);
  }
}

async function handleLogin(e) {
  e.preventDefault();
  hideMessage(DOM.loginMessage);

  const email = DOM.loginEmail.value.trim();
  const password = DOM.loginPassword.value.trim();

  if (!email || !password) {
    return showMessage(DOM.loginMessage, "Please enter both email and password.", "error");
  }

  setLoading(DOM.loginForm, true);
  try {
    state.justTriedLogin = true; // mark that this transition is from an explicit login
    const cred = await signInWithEmailAndPassword(auth, email, password);

    // If email not verified, sign out and tell the user. We do this *only* on login attempts,
    // not on page refresh (which could incorrectly boot a verified session).
    if (!cred.user.emailVerified) {
      await signOut(auth);
      showMessage(
        DOM.loginMessage,
        "Your email is not verified. Please check your inbox for the verification link.",
        "error"
      );
      state.justTriedLogin = false;
      return;
    }

    // Auth state listener will render profile
  } catch (error) {
    console.error("Login error:", error);
    let msg = "An unexpected error occurred. Please try again.";
    if (error.code && error.code.includes("auth/invalid-credential")) {
      msg = "Invalid email or password.";
    }
    showMessage(DOM.loginMessage, msg, "error");
  } finally {
    setLoading(DOM.loginForm, false);
  }
}

async function handleProfileUpdate(e) {
  e.preventDefault();
  hideMessage(DOM.profileMessage);

  const name = DOM.profileName.value.trim();
  const surname = DOM.profileSurname.value.trim();
  const continent = DOM.profileContinent.value;

  if (!name || !surname || !continent) {
    return showMessage(DOM.profileMessage, "Fields cannot be empty.", "error");
  }

  const user = auth.currentUser;
  if (!user) return showMessage(DOM.profileMessage, "Not signed in.", "error");

  setLoading(DOM.profileForm, true);
  try {
    await updateDoc(doc(db, "users", user.uid), { name, surname, continent });
    showMessage(DOM.profileMessage, "Profile updated successfully!", "success");
    DOM.welcomeMessage.textContent = `Welcome, ${name}!`;
  } catch (e2) {
    console.error("Profile update error:", e2);
    showMessage(DOM.profileMessage, "Failed to update profile. Please try again.", "error");
  } finally {
    setLoading(DOM.profileForm, false);
  }
}

/* =========================
   INIT (ORDER MATTERS!)
   ========================= */
async function init() {
  // Theme & selects first (safe)
  setMode(state.mode);
  populateContinents();

  // Wire UI events
  DOM.modeToggle?.addEventListener("click", () =>
    setMode(state.mode === "light" ? "dark" : "light")
  );
  DOM.showLoginLink?.addEventListener("click", () => showView("login"));
  DOM.showRegisterLink?.addEventListener("click", () => showView("register"));
  DOM.registerForm?.addEventListener("submit", handleRegister);
  DOM.loginForm?.addEventListener("submit", handleLogin);
  DOM.profileForm?.addEventListener("submit", handleProfileUpdate);
  DOM.logoutButton?.addEventListener("click", () => signOut(auth));

  // 1) Ensure long-lived persistence BEFORE any sign-in attempts or listeners.
  await setPersistence(auth, browserLocalPersistence);

  // 2) Attach the listener BEFORE waiting for initial state so future changes render.
  onAuthStateChanged(auth, async (user) => {
    // If we just tried logging in with an unverified email, the handler above already showed a message.
    // Otherwise render for whatever user we have (including restored sessions).
    await renderForUser(user);
  });

  // 3) Wait until Firebase restores session from storage (prevents "always logged out on refresh" flicker).
  if (typeof auth.authStateReady === "function") {
    try {
      await auth.authStateReady();
    } catch (e) {
      // Older SDKs may not have authStateReady; it's safe to ignore.
      console.warn("authStateReady not available or failed; proceeding.", e);
    }
  }
}

// Delay UI until DOM is ready; overlay is visible until renderForUser runs.
document.addEventListener("DOMContentLoaded", () => {
  init().catch((e) => {
    console.error("Init error:", e);
    // Fail-safe: show login if init fails
    showView("login");
    DOM.loadingOverlay.style.opacity = "0";
    setTimeout(() => (DOM.loadingOverlay.style.display = "none"), 300);
  });
});
</script>

</body>
</html>
