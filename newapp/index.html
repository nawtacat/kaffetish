<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PDF Read Aloud + Karaoke Transcript</title>
  <style>
    :root { --bg:#0b0d12; --panel:#111522; --muted:#8b93a7; --text:#e9ecf5; --accent:#6ee7ff; --accent2:#a78bfa; }
    *{ box-sizing:border-box; }
    body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background: radial-gradient(1200px 800px at 20% 0%, rgba(167,139,250,.18), transparent 50%),
                  radial-gradient(1000px 700px at 90% 20%, rgba(110,231,255,.18), transparent 50%),
                  var(--bg);
      color:var(--text);
    }
    header{
      padding:20px 18px 10px;
      display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap;
    }
    header h1{ margin:0; font-size:18px; letter-spacing:.2px; }
    header .hint{ color:var(--muted); font-size:12px; }
    .wrap{ max-width:1100px; margin:0 auto; padding:12px 18px 24px; }
    .grid{
      display:grid; grid-template-columns: 380px 1fr; gap:14px;
    }
    @media (max-width: 980px){ .grid{ grid-template-columns: 1fr; } }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border: 1px solid rgba(255,255,255,.08);
      border-radius:14px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
      overflow:hidden;
    }
    .card .hd{
      padding:12px 12px;
      display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap;
      border-bottom: 1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.12);
    }
    .card .bd{ padding:12px; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .btn{
      appearance:none; border:none; border-radius:10px;
      padding:10px 12px; font-weight:600; color:var(--text);
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.12);
      cursor:pointer;
    }
    .btn.primary{
      background: linear-gradient(90deg, rgba(110,231,255,.22), rgba(167,139,250,.22));
      border-color: rgba(255,255,255,.16);
    }
    .btn:disabled{ opacity:.45; cursor:not-allowed; }
    input[type="file"]{
      width:100%;
      padding:10px; border-radius:10px;
      background: rgba(255,255,255,.04);
      border: 1px dashed rgba(255,255,255,.16);
      color:var(--muted);
    }
    label{ font-size:12px; color:var(--muted); display:block; margin-bottom:6px; }
    select, input[type="range"], input[type="number"]{
      width:100%;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.12);
      border-radius:10px;
      color:var(--text);
      padding:9px 10px;
    }
    .mini{ font-size:12px; color:var(--muted); }
    .stat{
      font-size:12px; color:var(--muted);
      display:flex; gap:8px; align-items:center; flex-wrap:wrap;
    }
    .pill{
      display:inline-flex; gap:6px; align-items:center;
      padding:6px 10px; border-radius:999px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
    }

    /* Transcript */
    #transcript{
      height: 72vh;
      overflow:auto;
      padding: 18px;
      line-height: 1.9;
      font-size: 16px;
      background: rgba(0,0,0,.10);
    }
    #transcript .word{
      padding: 1px 2px;
      border-radius: 6px;
      transition: background .08s ease, color .08s ease;
      cursor: text;
      user-select: text;
    }
    #transcript .word.current{
      background: rgba(110,231,255,.22);
      outline: 1px solid rgba(110,231,255,.35);
      color: #f5fbff;
    }
    #transcript .word.past{ color: rgba(233,236,245,.75); }
    #transcript .pagebreak{
      display:block;
      height:1px;
      background: rgba(255,255,255,.08);
      margin: 14px 0;
    }

    /* Small footer */
    footer{ color:var(--muted); font-size:12px; padding:16px 2px 0; }
    a{ color: var(--accent); }
  </style>
</head>
<body>
  <header>
    <div>
      <h1>PDF → Read Aloud + Karaoke Transcript</h1>
      <div class="hint">Local-only demo: extracts PDF text in your browser and reads it aloud.</div>
    </div>
    <div class="stat">
      <span class="pill">Status: <span id="status">Idle</span></span>
      <span class="pill">Words: <span id="wordCount">0</span></span>
      <span class="pill">Page text: <span id="pageCount">0</span></span>
    </div>
  </header>

  <div class="wrap">
    <div class="grid">
      <section class="card">
        <div class="hd">
          <strong>Controls</strong>
          <span class="mini">Tip: use Chrome/Edge for best boundary events</span>
        </div>
        <div class="bd">
          <label>1) Upload PDF</label>
          <input id="pdfFile" type="file" accept="application/pdf" />

          <div style="height:12px"></div>

          <label>2) Voice</label>
          <select id="voiceSelect"></select>
          <div class="mini" id="voiceNote" style="margin-top:6px;"></div>

          <div style="height:12px"></div>

          <div class="row">
            <div style="flex:1; min-width:160px;">
              <label>Rate</label>
              <input id="rate" type="range" min="0.7" max="1.4" step="0.05" value="1.0" />
              <div class="mini">Current: <span id="rateVal">1.0</span></div>
            </div>
            <div style="flex:1; min-width:160px;">
              <label>Pitch</label>
              <input id="pitch" type="range" min="0.6" max="1.4" step="0.05" value="1.0" />
              <div class="mini">Current: <span id="pitchVal">1.0</span></div>
            </div>
          </div>

          <div style="height:12px"></div>

          <label>Chunk size (words per utterance)</label>
          <input id="chunkWords" type="number" min="40" max="220" value="120" />
          <div class="mini">
            Smaller chunks = more reliable highlighting & controls, but can sound slightly more “segmented”.
          </div>

          <div style="height:14px"></div>

          <div class="row">
            <button class="btn primary" id="btnParse" disabled>Extract Text</button>
            <button class="btn primary" id="btnPlay" disabled>Play</button>
            <button class="btn" id="btnPause" disabled>Pause</button>
            <button class="btn" id="btnResume" disabled>Resume</button>
            <button class="btn" id="btnStop" disabled>Stop</button>
          </div>

          <div style="height:14px"></div>

          <div class="row">
            <button class="btn" id="btnDownloadTxt" disabled>Download transcript (.txt)</button>
            <button class="btn" id="btnDownloadAudio" disabled title="See note below">Download audio (limited)</button>
          </div>

          <div class="mini" style="margin-top:10px;">
            <strong>Audio file note:</strong> browsers generally do <em>not</em> let you export Web Speech audio as MP3/WAV.
            The “Download audio” button provides a <em>best-effort</em> fallback using <code>MediaRecorder</code> only if your
            browser/OS exposes an audio track (often it won’t).
            For reliable audio export you’d typically need a small backend TTS service.
          </div>
        </div>
      </section>

      <section class="card">
        <div class="hd">
          <strong>Transcript</strong>
          <div class="mini">Words highlight as they’re spoken</div>
        </div>
        <div id="transcript" aria-live="polite"></div>
      </section>
    </div>

    <footer>
      Uses <a href="https://mozilla.github.io/pdf.js/" target="_blank" rel="noreferrer noopener">PDF.js</a> (loaded from CDN) + Web Speech API.
      Works entirely in-browser.
    </footer>
  </div>

  <!-- PDF.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.10.38/pdf.min.js"></script>

  <script>
    // ---------- UI refs ----------
    const $ = (id) => document.getElementById(id);
    const statusEl = $("status");
    const wordCountEl = $("wordCount");
    const pageCountEl = $("pageCount");

    const pdfFileEl = $("pdfFile");
    const voiceSelect = $("voiceSelect");
    const voiceNote = $("voiceNote");

    const rateEl = $("rate");
    const pitchEl = $("pitch");
    const rateVal = $("rateVal");
    const pitchVal = $("pitchVal");
    const chunkWordsEl = $("chunkWords");

    const btnParse = $("btnParse");
    const btnPlay = $("btnPlay");
    const btnPause = $("btnPause");
    const btnResume = $("btnResume");
    const btnStop = $("btnStop");
    const btnDownloadTxt = $("btnDownloadTxt");
    const btnDownloadAudio = $("btnDownloadAudio");

    const transcriptEl = $("transcript");

    // ---------- State ----------
    let fullText = "";
    let words = [];                 // array of word strings
    let wordSpans = [];             // array of span elements for highlighting
    let isParsed = false;

    // Speech state
    let utterQueue = [];            // [{text, startWordIndex}]
    let currentUtterIdx = 0;
    let currentGlobalWord = 0;
    let speaking = false;
    let paused = false;

    // Recording (best-effort)
    let recorder = null;
    let recordedChunks = [];
    let recordStream = null;

    // ---------- Helpers ----------
    function setStatus(s) { statusEl.textContent = s; }

    function clearTranscript() {
      transcriptEl.innerHTML = "";
      wordSpans = [];
    }

    function normalizeText(t) {
      // Light cleanup: keep punctuation but normalize whitespace
      return t
        .replace(/\s+/g, " ")
        .replace(/\u00A0/g, " ")
        .trim();
    }

    function splitIntoWords(t) {
      // Split while keeping punctuation attached to words for nicer reading.
      // This keeps "hello," as one token.
      return t.split(/\s+/).filter(Boolean);
    }

    function renderTranscript(wordArray) {
      clearTranscript();
      const frag = document.createDocumentFragment();
      wordArray.forEach((w, i) => {
        const span = document.createElement("span");
        span.className = "word";
        span.textContent = w + " ";
        span.dataset.idx = String(i);
        frag.appendChild(span);
        wordSpans.push(span);
      });
      transcriptEl.appendChild(frag);
    }

    function highlightWord(idx) {
      // Unhighlight previous
      const prev = transcriptEl.querySelector(".word.current");
      if (prev) {
        prev.classList.remove("current");
        prev.classList.add("past");
      }
      const el = wordSpans[idx];
      if (!el) return;
      el.classList.add("current");

      // Keep current word roughly centered
      const r = el.getBoundingClientRect();
      const cr = transcriptEl.getBoundingClientRect();
      if (r.top < cr.top + 60 || r.bottom > cr.bottom - 60) {
        el.scrollIntoView({ block: "center", behavior: "smooth" });
      }
    }

    function buildUtterancesFromWords(wordArray, chunkSize) {
      const chunks = [];
      for (let i = 0; i < wordArray.length; i += chunkSize) {
        const slice = wordArray.slice(i, i + chunkSize);
        chunks.push({ text: slice.join(" "), startWordIndex: i });
      }
      return chunks;
    }

    function enableControlsAfterParse() {
      btnPlay.disabled = false;
      btnStop.disabled = false;
      btnPause.disabled = false;
      btnResume.disabled = false
