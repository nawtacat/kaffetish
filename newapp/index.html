<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Lyrics Reader v2</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <style>
        :root {
            --bg-color: #121212;
            --text-color: #b3b3b3;
            --highlight-color: #ffffff;
            --accent-color: #1DB954;
        }

        body {
            font-family: 'Segoe UI', Tahoma, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        header {
            padding: 15px 25px;
            background: #181818;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
            border-bottom: 1px solid #333;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .controls { display: flex; gap: 10px; align-items: center; }
        
        button {
            background: var(--accent-color);
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
        }

        button:disabled { background: #444; color: #888; }

        input[type="number"] {
            background: #282828;
            border: 1px solid #444;
            color: white;
            padding: 5px;
            width: 50px;
            border-radius: 4px;
        }

        #lyrics-container {
            flex: 1;
            overflow-y: auto;
            padding: 40px 15%;
            text-align: center;
            scroll-behavior: smooth;
        }

        .page-marker {
            color: var(--accent-color);
            font-size: 0.9rem;
            margin: 50px 0 20px 0;
            display: block;
            border-top: 1px solid #333;
            padding-top: 10px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .word {
            font-size: 2.2rem;
            font-weight: 700;
            display: inline-block;
            margin: 4px 8px;
            opacity: 0.2;
            transition: transform 0.2s;
        }

        .word.active {
            color: var(--highlight-color);
            opacity: 1;
            transform: scale(1.15);
        }

        .word.read { opacity: 0.6; }
    </style>
</head>
<body>

<header>
    <input type="file" id="pdf-upload" accept=".pdf">
    
    <div class="controls">
        <button id="play-btn" disabled>▶ Play</button>
        <button id="pause-btn" disabled>⏸ Pause</button>
        <button id="stop-btn" disabled>⏹ Stop</button>
    </div>

    <div class="controls">
        <label>Jump to Page:</label>
        <input type="number" id="page-jump" value="1" min="1">
        <button id="jump-btn" disabled>Go</button>
    </div>
</header>

<div id="lyrics-container">
    <p id="status">Upload a PDF to begin...</p>
</div>

<script>
    const pdfjsLib = window['pdfjs-dist/build/pdf'];
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

    const container = document.getElementById('lyrics-container');
    const playBtn = document.getElementById('play-btn');
    const pauseBtn = document.getElementById('pause-btn');
    const stopBtn = document.getElementById('stop-btn');
    const jumpBtn = document.getElementById('jump-btn');
    const pageInput = document.getElementById('page-jump');

    let synth = window.speechSynthesis;
    let pagesData = []; // Array of { pageNum, words: [] }
    let utterance = null;
    let allWordsSpans = []; // Flat list for indexing
    let fullText = "";

    // Fix for some browsers: Pre-load voices
    synth.getVoices();

    document.getElementById('pdf-upload').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        document.getElementById('status').innerText = "Loading PDF...";
        const reader = new FileReader();
        
        reader.onload = async function() {
            const pdf = await pdfjsLib.getDocument(new Uint8Array(this.result)).promise;
            pagesData = [];
            allWordsSpans = [];
            container.innerHTML = "";
            fullText = "";

            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const content = await page.getTextContent();
                const text = content.items.map(s => s.str).join(" ");
                
                const words = text.split(/\s+/).filter(w => w.length > 0);
                pagesData.push({ pageNum: i, words: words });
                renderPage(i, words);
                fullText += text + " ";
            }

            playBtn.disabled = false;
            stopBtn.disabled = false;
            jumpBtn.disabled = false;
            document.getElementById('status').innerText = "";
        };
        reader.readAsArrayBuffer(file);
    });

    function renderPage(num, words) {
        const marker = document.createElement('div');
        marker.className = 'page-marker';
        marker.id = `page-top-${num}`;
        marker.innerText = `— Page ${num} —`;
        container.appendChild(marker);

        words.forEach(word => {
            const span = document.createElement('span');
            span.className = 'word';
            span.innerText = word;
            container.appendChild(span);
            allWordsSpans.push(span);
        });
    }

    function speak(startIndex = 0) {
        synth.cancel(); // Stop current speech

        // Create text starting from the requested index
        const remainingText = allWordsSpans.slice(startIndex).map(s => s.innerText).join(" ");
        utterance = new SpeechSynthesisUtterance(remainingText);
        
        utterance.onboundary = (event) => {
            if (event.name === 'word') {
                const charIndex = event.charIndex;
                const wordsBefore = remainingText.substring(0, charIndex).split(/\s+/).length - 1;
                const absoluteIndex = startIndex + wordsBefore;
                highlightWord(absoluteIndex);
            }
        };

        utterance.onend = () => resetHighlights();
        
        synth.speak(utterance);
        pauseBtn.disabled = false;
    }

    function highlightWord(index) {
        allWordsSpans.forEach((span, i) => {
            span.classList.remove('active');
            if (i < index) span.classList.add('read');
            else span.classList.remove('read');
        });

        if (allWordsSpans[index]) {
            allWordsSpans[index].classList.add('active');
            allWordsSpans[index].scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }

    function resetHighlights() {
        allWordsSpans.forEach(s => s.classList.remove('active', 'read'));
    }

    // Control Handlers
    playBtn.addEventListener('click', () => {
        if (synth.paused) synth.resume();
        else speak(0);
    });

    pauseBtn.addEventListener('click', () => synth.pause());
    
    stopBtn.addEventListener('click', () => {
        synth.cancel();
        resetHighlights();
    });

    jumpBtn.addEventListener('click', () => {
        const pageNum = parseInt(pageInput.value);
        const pageMarker = document.getElementById(`page-top-${pageNum}`);
        
        if (pageMarker) {
            // Find the index of the first word on this page
            let wordIndex = 0;
            for(let i=0; i < pageNum - 1; i++) {
                wordIndex += pagesData[i].words.length;
            }
            speak(wordIndex);
        } else {
            alert("Page not found");
        }
    });

</script>
</body>
</html>
