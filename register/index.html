<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Kaffetish - Register/Login</title>

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,500;0,700;1,400&family=Poppins:wght@400;500;600&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />

  <style>
    :root {
      --bg: #FDFBF7;
      --ink: #2C2B2A;
      --accent: #FF3A44;
      --subtle: #8A8886;
      --border-color: #EAE8E4;
      --shadow-color: rgba(44, 43, 42, 0.1);
      --success: #28a745;
      --font-main: 'Lora', serif;
      --font-ui: 'Poppins', sans-serif;
    }
    body.dark-mode {
      --bg: #1e1d1c;
      --ink: #EAE8E4;
      --subtle: #999591;
      --border-color: #3A3837;
      --shadow-color: rgba(0, 0, 0, 0.3);
    }
    ::selection { background-color: var(--accent); color: white; opacity: 0.9; }
    body {
      font-family: var(--font-ui); background-color: var(--bg); color: var(--ink);
      transition: background-color 0.3s ease, color 0.3s ease;
      margin: 0; padding: 100px 24px; display: flex; justify-content: center; align-items: center;
      min-height: 100vh; box-sizing: border-box; overflow-x: hidden;
    }
    body::before {
      content: ''; position: fixed; top: -20%; left: -10%; width: 50vw; height: 50vw;
      background: radial-gradient(circle, color-mix(in srgb, var(--accent) 5%, transparent) 0%, transparent 70%);
      z-index: -1; opacity: 0.5; transform: rotate(15deg);
    }
    .loading-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background-color: var(--bg); z-index: 9999; display: flex; justify-content: center; align-items: center;
      transition: opacity 0.3s ease;
    }
    .spinner {
      border: 4px solid var(--border-color); border-top: 4px solid var(--accent);
      border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

    .app-header {
      position: fixed; top: 0; left: 0; width: 100%; height: 60px;
      background-color: color-mix(in srgb, var(--bg) 85%, transparent);
      backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--border-color); z-index: 1000;
      transition: background-color 0.3s ease, border-color 0.3s ease;
    }
    .header-content {
      max-width: 1200px; height: 100%; margin: 0 auto; padding: 0 24px;
      display: flex; justify-content: space-between; align-items: center;
    }
    .logo {
      display: flex; align-items: baseline; font-size: 1.6rem;
      font-weight: 500; letter-spacing: -0.5px; color: var(--accent);
      font-family: var(--font-main); text-decoration: none;
    }
    body.dark-mode .logo { color: var(--ink); }
    .header-actions { display: flex; align-items: center; gap: 16px; }
    .header-actions button {
      background: transparent; border: none; color: var(--subtle); border-radius: 6px;
      padding: 8px 10px; cursor: pointer; font-size: 1rem;
      transition: color 0.2s ease, background-color 0.2s ease;
    }
    .header-actions button:hover { color: var(--ink); background-color: color-mix(in srgb, var(--border-color) 60%, transparent); }

    main { width: 100%; max-width: 950px; animation: fadeIn 0.8s ease-out both; }

    .profile-container {
      display: grid; grid-template-columns: 3fr 4fr;
      width: 100%; background-color: color-mix(in srgb, var(--border-color) 20%, transparent);
      border: 1px solid var(--border-color); border-radius: 24px; overflow: hidden;
      box-shadow: 0 20px 50px -10px var(--shadow-color);
    }
    .benefits-panel {
      padding: 64px 48px; display: flex; flex-direction: column; justify-content: center;
      background: linear-gradient(165deg, color-mix(in srgb, var(--border-color) 45%, transparent), color-mix(in srgb, var(--border-color) 15%, transparent));
      border-right: 1px solid var(--border-color);
    }
    .benefits-panel h2 {
      font-family: var(--font-main); font-size: 2.8rem; font-weight: 500; margin: 0 0 16px 0;
      line-height: 1.2; letter-spacing: -1px;
    }
    .benefits-panel p { color: var(--subtle); font-size: 1rem; line-height: 1.7; margin: 0 0 40px 0; }
    .benefit-item { display: flex; align-items: center; gap: 20px; margin-bottom: 24px; font-size: 1rem; }
    .benefit-item i { color: var(--accent); font-size: 1.2rem; width: 24px; text-align: center; transition: transform 0.3s ease; }
    .benefit-item:hover i { transform: scale(1.2); }

    .form-panel { padding: 64px; }
    .form-panel h3 {
      font-family: var(--font-main); font-size: 1.8rem; font-weight: 500;
      margin: 0 0 40px 0; text-align: left; position: relative;
    }
    .form-panel h3::after {
      content: ''; position: absolute; left: 0; bottom: -12px; width: 50px; height: 3px;
      background-color: var(--accent); border-radius: 3px;
    }

    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
    .form-field.full-width { grid-column: 1 / -1; }
    .form-field label { display: block; font-size: 0.85rem; font-weight: 500; margin-bottom: 8px; color: var(--subtle); }
    .form-field input, .form-field select {
      width: 100%; padding: 12px 14px; font-size: 1rem; font-family: var(--font-ui);
      border: 1px solid var(--border-color); border-radius: 8px; background-color: var(--bg);
      color: var(--ink); box-sizing: border-box; transition: border-color 0.2s, box-shadow 0.2s;
      -webkit-appearance: none; -moz-appearance: none; appearance: none;
    }
    .select-wrapper { position: relative; }
    .select-wrapper::after {
      content: '\f078'; font-family: 'Font Awesome 6 Free'; font-weight: 900; position: absolute; top: 50%; right: 16px;
      transform: translateY(-50%); color: var(--subtle); pointer-events: none; transition: transform 0.2s ease;
    }
    .select-wrapper:focus-within::after { transform: translateY(-50%) rotate(180deg); }
    .form-field input:focus, .form-field select:focus {
      outline: none; border-color: var(--accent);
      box-shadow: 0 0 0 4px color-mix(in srgb, var(--accent) 20%, transparent);
    }

    .form-actions { margin-top: 32px; display: flex; justify-content: space-between; align-items: center; gap: 16px; }
    .btn {
      font-family: var(--font-ui); font-size: 1rem; font-weight: 500;
      padding: 12px 24px; border-radius: 8px; border: none; cursor: pointer; transition: all 0.2s ease;
    }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-primary { background-color: var(--accent); color: white; }
    .btn-primary:not(:disabled):hover {
      background-color: color-mix(in srgb, var(--accent) 90%, black);
      transform: translateY(-3px);
      box-shadow: 0 6px 20px color-mix(in srgb, var(--accent) 40%, transparent);
    }
    .btn-secondary { background-color: transparent; color: var(--subtle); }
    .btn-secondary:not(:disabled):hover { color: var(--accent); }
    .form-message { margin-top: 20px; padding: 12px; border-radius: 8px; font-size: 0.9rem; text-align: center; display: none; }
    .form-message.success { background-color: color-mix(in srgb, var(--success) 15%, transparent); color: color-mix(in srgb, var(--success) 90%, black); border: 1px solid color-mix(in srgb, var(--success) 30%, transparent); }
    .form-message.error { background-color: color-mix(in srgb, var(--accent) 15%, transparent); color: var(--accent); border: 1px solid color-mix(in srgb, var(--accent) 30%, transparent); }
    .auth-toggle { text-align: center; margin-top: 24px; font-size: 0.9rem; color: var(--subtle); }
    .auth-toggle a { color: var(--accent); font-weight: 500; cursor: pointer; text-decoration: none; }
    .auth-toggle a:hover { text-decoration: underline; }

    #login-view { display: none; }

    @media (max-width: 900px) {
      body { padding: 80px 16px; }
      body::before { display: none; }
      main { padding: 0; }
      .profile-container { grid-template-columns: 1fr; box-shadow: 0 10px 30px var(--shadow-color); }
      .benefits-panel { display: none; }
      .form-panel { padding: 32px 24px; }
      .form-panel h3, .benefits-panel h2 { font-size: 1.6rem; }
      .form-grid { grid-template-columns: 1fr; }
      .form-actions { flex-direction: column-reverse; }
      .btn { width: 100%; }
    }
  </style>
</head>
<body>
  <div class="loading-overlay" id="loading-overlay"><div class="spinner"></div></div>

  <header class="app-header">
    <div class="header-content">
      <a href="https://kaffetish.club/" class="logo">Kaffetish</a>
      <div class="header-actions">
        <button id="mode-toggle" title="Toggle Theme"><i class="fa-solid fa-moon"></i></button>
      </div>
    </div>
  </header>

  <main>
        <div class="profile-container" id="register-view">
      <div class="benefits-panel">
        <h2>Create Your Account</h2>
        <p>Join our community to save your reading progress and curate a personal collection.</p>
        <div class="benefit-item"><i class="fa-solid fa-bookmark"></i><span>Save your reading progress</span></div>
        <div class="benefit-item"><i class="fa-solid fa-book-open"></i><span>Access your library anywhere</span></div>
        <div class="benefit-item"><i class="fa-solid fa-star"></i><span>Curate personal collections</span></div>
      </div>
      <div class="form-panel">
        <h3>Register</h3>
        <form id="register-form" novalidate>
          <div class="form-grid">
            <div class="form-field"><label for="reg-name">Name</label><input type="text" id="reg-name" required></div>
            <div class="form-field"><label for="reg-surname">Surname</label><input type="text" id="reg-surname" required></div>
            <div class="form-field full-width"><label for="reg-email">Email</label><input type="email" id="reg-email" required></div>
            <div class="form-field full-width"><label for="reg-continent">Continent</label><div class="select-wrapper"><select id="reg-continent" required></select></div></div>
            <div class="form-field"><label for="reg-password">Password</label><input type="password" id="reg-password" required minlength="8"></div>
            <div class="form-field"><label for="reg-password-confirm">Confirm Password</label><input type="password" id="reg-password-confirm" required minlength="8"></div>
          </div>
          <div class="form-message" id="register-message"></div>
          <div class="form-actions"><button type="submit" class="btn btn-primary">Create Account</button></div>
          <p class="auth-toggle">Already have an account? <a id="show-login">Sign In</a></p>
        </form>
      </div>
    </div>

        <div class="profile-container" id="login-view">
      <div class="benefits-panel">
        <h2>Welcome Back</h2>
        <p>Sign in to access your personal library and continue where you left off.</p>
        <div class="benefit-item"><i class="fa-solid fa-arrow-right-to-bracket"></i><span>Quick & Secure Login</span></div>
        <div class="benefit-item"><i class="fa-solid fa-cloud"></i><span>Your progress is synced</span></div>
      </div>
      <div class="form-panel">
        <h3>Sign In</h3>
        <form id="login-form" novalidate>
          <div class="form-grid">
            <div class="form-field full-width"><label for="login-email">Email</label><input type="email" id="login-email" required></div>
            <div class="form-field full-width"><label for="login-password">Password</label><input type="password" id="login-password" required></div>
          </div>
          <div class="form-message" id="login-message"></div>
          <div class="form-actions"><button type="submit" class="btn btn-primary">Sign In</button></div>
          <p class="auth-toggle">Don't have an account? <a id="show-register">Register</a></p>
        </form>
      </div>
    </div>
  </main>

 <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import {
    getAuth,
    setPersistence,
    browserLocalPersistence,
    onAuthStateChanged,
    createUserWithEmailAndPassword,
    signInWithEmailAndPassword,
  } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import {
    getFirestore,
    doc,
    getDoc,
    setDoc,
    serverTimestamp,
  } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  // ---------- CONFIG ----------
  const firebaseConfig = {
    apiKey: "AIzaSyAbnPpcIt88B0jIAoLUdC71zmQDvR_fdu8",
    authDomain: "physmathacademy-722b3.firebaseapp.com",
    projectId: "physmathacademy-722b3",
    storageBucket: "physmathacademy-722b3.appspot.com",
    messagingSenderId: "1093640992262",
    appId: "1:1093640992262:web:3552a4205dc5df869a84da",
  };

  // ---------- INIT ----------
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  await setPersistence(auth, browserLocalPersistence);

  // ---------- DOM ----------
  const $ = (s) => document.querySelector(s);
  const loadingOverlay = $("#loading-overlay");
  const views = { register: $("#register-view"), login: $("#login-view") };
  const showView = (name) => { Object.values(views).forEach(el => el.style.display = "none"); views[name].style.display = "grid"; };
  const setMessage = (el, text, type = "error") => { if (!el) return; el.textContent = text; el.classList.remove("success","error"); el.classList.add(type); el.style.display = text ? "block":"none"; };

  Object.values(views).forEach(el => el.style.display = "none");

  // Theme
  const modeToggle = $("#mode-toggle");
  const applyTheme = () => document.body.classList.toggle("dark-mode", (localStorage.getItem("kt_theme")||"light")==="dark");
  modeToggle?.addEventListener("click", () => { const c=localStorage.getItem("kt_theme")||"light"; localStorage.setItem("kt_theme", c==="light"?"dark":"light"); applyTheme(); });
  applyTheme();

  // Continents
  const continents = ["Africa","Asia","Europe","North America","South America","Oceania","Antarctica"];
  const regContinent = $("#reg-continent");
  const fillSelect = (sel) => {
    if (!sel || sel.options.length) return;
    sel.innerHTML = `<option value="" disabled selected>Select your continent</option>` + continents.map(c=>`<option value="${c}">${c}</option>`).join("");
  };
  fillSelect(regContinent);

  // Elements
  const registerForm = $("#register-form");
  const regName = $("#reg-name");
  const regSurname = $("#reg-surname");
  const regEmail = $("#reg-email");
  const regPassword = $("#reg-password");
  const regPasswordConfirm = $("#reg-password-confirm");
  const registerMsg = $("#register-message");
  const showLoginLink = $("#show-login");

  const loginForm = $("#login-form");
  const loginEmail = $("#login-email");
  const loginPassword = $("#login-password");
  const loginMsg = $("#login-message");
  const showRegisterLink = $("#show-register");

  // ---------- Helpers ----------
  const userDocRef = (uid) => doc(db, "kaffetish-users", uid);

  async function createUserDocIfMissing(user, extra = {}) {
    const ref = userDocRef(user.uid);
    const snap = await getDoc(ref);
    if (!snap.exists()) {
      console.log("[FS] setDoc ->", `kaffetish-users/${user.uid}`);
      await setDoc(ref, {
        uid: user.uid,
        email: user.email || "",
        name: extra.name || "",
        surname: extra.surname || "",
        continent: extra.continent || "",
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp(),
      }, { merge: true });
    }
  }
  
  function humanError(err) {
    const code = (err?.code || "").toLowerCase();
    if (code.includes("permission-denied")) return "Permissions blocked by Firestore rules for this path.";
    if (code.includes("operation-not-allowed")) return "Email/Password sign-in is disabled in Firebase.";
    if (code.includes("email-already-in-use")) return "This email is already registered. Try signing in.";
    if (code.includes("invalid-email")) return "Invalid email address.";
    if (code.includes("weak-password")) return "Password is too weak.";
    if (code.includes("network-request-failed")) return "Network error. Check your connection.";
    return err?.message || "Something went wrong.";
  }

  // ---------- View switching ----------
  showLoginLink?.addEventListener("click", () => { setMessage(registerMsg, ""); showView("login"); });
  showRegisterLink?.addEventListener("click", () => { setMessage(loginMsg, ""); showView("register"); });

  // Stash registration extras here; the auth observer will do the Firestore write before redirecting.
  let pendingRegistrationExtras = null;

  // ---------- Register ----------
  registerForm?.addEventListener("submit", async (e) => {
    e.preventDefault();
    setMessage(registerMsg, "");
    const name = regName.value.trim();
    const surname = regSurname.value.trim();
    const email = regEmail.value.trim().toLowerCase();
    const continent = regContinent.value;
    const pw = regPassword.value;
    const pw2 = regPasswordConfirm.value;

    if (!name || !surname || !email || !continent || !pw || !pw2) return setMessage(registerMsg, "Please fill in all fields.", "error");
    if (pw !== pw2) return setMessage(registerMsg, "Passwords do not match.", "error");
  	if (pw.length < 8) return setMessage(registerMsg, "Password must be at least 8 characters.", "error");

    const btn = registerForm.querySelector("button[type='submit']");
    btn.disabled = true;

    try {
      console.log("[Auth] createUserWithEmailAndPassword");
      // Save extras; the auth observer will create the Firestore doc AFTER auth is fully ready.
      pendingRegistrationExtras = { name, surname, continent };
      await createUserWithEmailAndPassword(auth, email, pw);
      setMessage(registerMsg, "Account created. Redirecting...", "success");
    } catch (err) {
      pendingRegistrationExtras = null; // Clear on failure
      console.error("[Auth/Register]", err?.code, err?.message, err);
      setMessage(registerMsg, humanError(err), "error");
    } finally {
      btn.disabled = false;
    }
  });

  // ---------- Login ----------
  loginForm?.addEventListener("submit", async (e) => {
    e.preventDefault();
    setMessage(loginMsg, "");
    const email = loginEmail.value.trim().toLowerCase();
    const pw = loginPassword.value;
    if (!email || !pw) return setMessage(loginMsg, "Enter your email and password.", "error");

    const btn = loginForm.querySelector("button[type='submit']");
    btn.disabled = true;

    try {
      console.log("[Auth] signInWithEmailAndPassword");
      await signInWithEmailAndPassword(auth, email, pw);
      setMessage(loginMsg, "Signed in. Redirecting...", "success");
    } catch (err) {
      console.error("[Auth/Login]", err?.code, err?.message, err);
      setMessage(loginMsg, humanError(err), "error");
    } finally {
      btn.disabled = false;
    }
  });

  // ---------- Auth observer (single source of truth) ----------
  onAuthStateChanged(auth, async (user) => {
    try {
      if (user) {
        // A user is now signed in. This could be from login or registration.
        // If it's a new registration, the extra data will be in our temp variable.
        if (pendingRegistrationExtras) {
          await createUserDocIfMissing(user, pendingRegistrationExtras);
          pendingRegistrationExtras = null; // Clear after use
        }
        // Redirect to the account page.
        window.location.href = 'account.html';
      } else {
        // No user is signed in, show the default registration view.
        showView("register");
        if (loadingOverlay) loadingOverlay.style.display = "none";
      }
    } catch (err) {
      console.error("[Auth Observer]", err?.code, err?.message, err);
      showView("register"); // Default to register on error
      if (loadingOverlay) loadingOverlay.style.display = "none";
    }
  });
 </script>
</body>
</html>
